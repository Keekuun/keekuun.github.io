## 36. 站点一键换肤的实现方式有哪些？

一键换肤是现代Web应用的常见需求，以下是全面的实现方案和技术细节：

## 一、CSS变量方案（推荐）

### 1. 基础实现
```css
/* 定义变量 */
:root {
  --primary-color: #1890ff;
  --bg-color: #ffffff;
  --text-color: #333333;
}

.dark-theme {
  --primary-color: #177ddc;
  --bg-color: #1f1f1f;
  --text-color: #f0f0f0;
}

/* 使用变量 */
body {
  background-color: var(--bg-color);
  color: var(--text-color);
}
```

```javascript
// 切换主题
function toggleTheme() {
  document.body.classList.toggle('dark-theme');
  // 持久化存储
  localStorage.setItem('theme', 
    document.body.classList.contains('dark-theme') ? 'dark' : 'light');
}

// 初始化
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark') {
  document.body.classList.add('dark-theme');
}
```

### 2. 高级技巧
- **动态生成主题色**：
  ```javascript
  function setPrimaryColor(hue) {
    document.documentElement.style.setProperty('--primary-color', `hsl(${hue}, 100%, 50%)`);
  }
  ```

- **过渡动画**：
  ```css
  * {
    transition: background-color 0.3s, color 0.2s;
  }
  ```

## 二、CSS类切换方案

### 1. 多主题管理
```css
/* 默认主题 */
.theme-light {
  --primary-color: #1890ff;
  --bg-color: #ffffff;
}

.theme-dark {
  --primary-color: #177ddc;
  --bg-color: #1f1f1f;
}

.theme-blue {
  --primary-color: #1a73e8;
  --bg-color: #e8f0fe;
}
```

```javascript
const themes = ['light', 'dark', 'blue'];
let currentTheme = 0;

function cycleTheme() {
  document.body.classList.remove(`theme-${themes[currentTheme]}`);
  currentTheme = (currentTheme + 1) % themes.length;
  document.body.classList.add(`theme-${themes[currentTheme]}`);
}
```

## 三、预处理变量替换方案

### 1. Less/Sass方案
```scss
// theme.config.scss
$themes: (
  light: (
    primary-color: #1890ff,
    bg-color: #ffffff
  ),
  dark: (
    primary-color: #177ddc,
    bg-color: #1f1f1f
  )
);

// 混入器
@mixin theme() {
  @each $theme, $map in $themes {
    .theme-#{$theme} & {
      $theme-map: () !global;
      @each $key, $value in $map {
        $theme-map: map-merge($theme-map, ($key: $value)) !global;
      }
      @content;
      $theme-map: null !global;
    }
  }
}

// 使用
@function themed($key) {
  @return map-get($theme-map, $key);
}

.button {
  @include theme {
    color: themed('primary-color');
    background: themed('bg-color');
  }
}
```

## 四、动态样式表方案

### 1. 样式表切换
```javascript
function loadTheme(themeName) {
  // 移除现有主题样式
  const oldLink = document.getElementById('theme-style');
  if (oldLink) oldLink.remove();

  // 加载新主题
  const link = document.createElement('link');
  link.id = 'theme-style';
  link.rel = 'stylesheet';
  link.href = `themes/${themeName}.css`;
  document.head.appendChild(link);
}
```

## 五、前端框架集成方案

### 1. React实现
```jsx
// ThemeContext.js
import React, { createContext, useState, useEffect } from 'react';

export const ThemeContext = createContext();

export const ThemeProvider = ({ children }) => {
  const [theme, setTheme] = useState('light');

  useEffect(() => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);
  }, []);

  const toggleTheme = () => {
    const newTheme = theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
    localStorage.setItem('theme', newTheme);
  };

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      <div className={`theme-${theme}`}>
        {children}
      </div>
    </ThemeContext.Provider>
  );
};

// 使用
import { useContext } from 'react';
import { ThemeContext } from './ThemeContext';

function ThemeButton() {
  const { theme, toggleTheme } = useContext(ThemeContext);
  return (
    <button onClick={toggleTheme}>
      当前主题: {theme}
    </button>
  );
}
```

### 2. Vue实现
```vue
<template>
  <div :class="`theme-${currentTheme}`">
    <button @click="toggleTheme">切换主题</button>
  </div>
</template>

<script>
export default {
  data() {
    return {
      currentTheme: 'light'
    }
  },
  created() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) this.currentTheme = savedTheme;
  },
  methods: {
    toggleTheme() {
      this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
      localStorage.setItem('theme', this.currentTheme);
    }
  }
}
</script>
```

## 六、主题持久化方案

### 1. 完整状态管理
```javascript
// themeStore.js
class ThemeStore {
  constructor() {
    this.theme = localStorage.getItem('theme') || 'light';
    this.subscribers = [];
  }

  toggle() {
    this.theme = this.theme === 'light' ? 'dark' : 'light';
    localStorage.setItem('theme', this.theme);
    this.notify();
  }

  subscribe(callback) {
    this.subscribers.push(callback);
  }

  notify() {
    this.subscribers.forEach(cb => cb(this.theme));
  }
}

export default new ThemeStore();
```

## 七、服务端渲染(SSR)支持

### 1. Next.js实现
```jsx
// _app.js
import { useEffect, useState } from 'react';
import cookies from 'next-cookies';

function MyApp({ Component, pageProps, initialTheme }) {
  const [theme, setTheme] = useState(initialTheme);

  useEffect(() => {
    document.body.className = theme;
  }, [theme]);

  return (
    <ThemeContext.Provider value={{ theme, setTheme }}>
      <Component {...pageProps} />
    </ThemeContext.Provider>
  );
}

MyApp.getInitialProps = async ({ ctx }) => {
  const { theme } = cookies(ctx);
  return { initialTheme: theme || 'light' };
};
```

## 八、主题扩展能力

### 1. 用户自定义主题
```javascript
function saveCustomTheme(colors) {
  const styleTag = document.createElement('style');
  styleTag.id = 'custom-theme';
  styleTag.textContent = `
    .theme-custom {
      --primary-color: ${colors.primary};
      --bg-color: ${colors.background};
    }
  `;
  document.head.appendChild(styleTag);
  localStorage.setItem('customTheme', JSON.stringify(colors));
}
```

## 九、性能优化建议

1. **CSS变量回退方案**：
   ```css
   .element {
     color: #333; /* 回退值 */
     color: var(--text-color, #333);
   }
   ```

2. **减少重绘**：
   ```javascript
   // 批量更新样式
   function applyTheme(theme) {
     const root = document.documentElement;
     requestAnimationFrame(() => {
       root.style.setProperty('--primary-color', theme.primary);
       root.style.setProperty('--bg-color', theme.background);
     });
   }
   ```

3. **主题资源按需加载**：
   ```javascript
   // 动态加载主题资源
   async function loadThemeAssets(theme) {
     if (theme === 'dark') {
       await import('./dark-theme.css');
     }
   }
   ```

## 十、完整实现流程图

```
用户点击换肤按钮
  ↓
触发主题切换函数
  ↓
更新CSS变量/类名
  │
  ├─▶ 应用视觉变化
  │
  └─▶ 保存到localStorage
       ↓
   下次加载时读取
       ↓
   应用保存的主题
```

选择方案时应考虑：
1. 项目复杂度
2. 主题数量
3. 性能要求
4. 团队熟悉度

CSS变量方案是目前最推荐的方式，它兼具灵活性和性能，且与现代前端框架完美兼容。
