## 54. å¦‚æœä¸ä½¿ç”¨è„šæ‰‹æ¶ï¼Œå¦‚æœç”¨ webpack æ„å»ºä¸€ä¸ªè‡ªå·±çš„ react åº”ç”¨

ä¸ä½¿ç”¨è„šæ‰‹æ¶ï¼Œæ‰‹åŠ¨é€šè¿‡ Webpack æ„å»º React åº”ç”¨çš„å®Œæ•´æŒ‡å—ï¼ˆTypeScript ç‰ˆï¼‰ï¼š

---

### ğŸ› ï¸ **é¡¹ç›®åˆå§‹åŒ–**
```bash
mkdir react-webpack-manual
cd react-webpack-manual
npm init -y
git init
```

---

### ğŸ“¦ **æ ¸å¿ƒä¾èµ–å®‰è£…**
```bash
# React åŸºç¡€
npm install react react-dom @types/react @types/react-dom

# Webpack å…¨å®¶æ¡¶
npm install webpack webpack-cli webpack-dev-server --save-dev

# Babel è½¬è¯‘
npm install @babel/core babel-loader @babel/preset-env @babel/preset-react @babel/preset-typescript --save-dev

# æ ·å¼å¤„ç†
npm install style-loader css-loader postcss postcss-loader postcss-preset-env sass sass-loader --save-dev

# å…¶ä»–å·¥å…·
npm install html-webpack-plugin typescript ts-loader @babel/plugin-transform-runtime --save-dev
```

---

### âš™ï¸ **Webpack é…ç½®**
#### 1. `webpack.config.ts` (TypeScript é…ç½®)
```typescript
import path from 'path'
import { Configuration } from 'webpack'
import HtmlWebpackPlugin from 'html-webpack-plugin'

const config: Configuration = {
  mode: 'development',
  entry: './src/index.tsx',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'bundle.[contenthash].js',
    clean: true,
  },
  module: {
    rules: [
      {
        test: /\.(ts|tsx)$/,
        exclude: /node_modules/,
        use: [
          {
            loader: 'babel-loader',
            options: {
              presets: [
                '@babel/preset-env',
                '@babel/preset-react',
                '@babel/preset-typescript'
              ],
              plugins: ['@babel/plugin-transform-runtime']
            }
          }
        ]
      },
      {
        test: /\.scss$/,
        use: [
          'style-loader',
          {
            loader: 'css-loader',
            options: {
              modules: {
                auto: true,
                localIdentName: '[name]__[local]--[hash:base64:5]'
              }
            }
          },
          'postcss-loader',
          'sass-loader'
        ]
      },
      {
        test: /\.(png|svg|jpg|jpeg|gif)$/i,
        type: 'asset/resource'
      }
    ]
  },
  resolve: {
    extensions: ['.tsx', '.ts', '.js'],
    alias: {
      '@': path.resolve(__dirname, 'src')
    }
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: './public/index.html',
      favicon: './public/favicon.ico'
    })
  ],
  devServer: {
    static: {
      directory: path.join(__dirname, 'dist')
    },
    historyApiFallback: true,
    hot: true,
    port: 3000,
    open: true
  }
}

export default config
```

#### 2. `webpack.prod.config.ts` (ç”Ÿäº§ç¯å¢ƒæ‰©å±•)
```typescript
import { merge } from 'webpack-merge'
import baseConfig from './webpack.config'
import MiniCssExtractPlugin from 'mini-css-extract-plugin'
import CssMinimizerPlugin from 'css-minimizer-webpack-plugin'
import TerserPlugin from 'terser-webpack-plugin'

const prodConfig = merge(baseConfig, {
  mode: 'production',
  devtool: 'source-map',
  module: {
    rules: [
      {
        test: /\.scss$/,
        use: [
          MiniCssExtractPlugin.loader,
          'css-loader',
          'postcss-loader',
          'sass-loader'
        ]
      }
    ]
  },
  plugins: [
    new MiniCssExtractPlugin({
      filename: 'styles.[contenthash].css'
    })
  ],
  optimization: {
    minimizer: [
      new TerserPlugin(),
      new CssMinimizerPlugin()
    ],
    splitChunks: {
      chunks: 'all'
    }
  }
})

export default prodConfig
```

---

### ğŸ”§ **è¾…åŠ©é…ç½®æ–‡ä»¶**
#### 1. `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "ESNext",
    "module": "ESNext",
    "jsx": "react-jsx",
    "baseUrl": "./",
    "paths": {
      "@/*": ["src/*"]
    },
    "strict": true,
    "moduleResolution": "node",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["src", "webpack.config.ts"],
  "exclude": ["node_modules"]
}
```

#### 2. `.babelrc`
```json
{
  "presets": [
    "@babel/preset-env",
    "@babel/preset-react",
    "@babel/preset-typescript"
  ],
  "plugins": [
    "@babel/plugin-transform-runtime"
  ]
}
```

#### 3. `postcss.config.js`
```javascript
module.exports = {
  plugins: [
    require('postcss-preset-env')({
      browsers: 'last 2 versions'
    }),
    require('autoprefixer')
  ]
}
```

---

### ğŸ“ **é¡¹ç›®ç»“æ„**
```bash
â”œâ”€â”€ dist/                  # æ„å»ºè¾“å‡ºç›®å½•
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ assets/            # é™æ€èµ„æº
â”‚   â”œâ”€â”€ components/        # é€šç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ hooks/             # è‡ªå®šä¹‰Hook
â”‚   â”œâ”€â”€ styles/            # å…¨å±€æ ·å¼
â”‚   â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ App.tsx            # æ ¹ç»„ä»¶
â”‚   â””â”€â”€ index.tsx          # å…¥å£æ–‡ä»¶
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ index.html         # HTMLæ¨¡æ¿
â”‚   â””â”€â”€ favicon.ico        # ç½‘ç«™å›¾æ ‡
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

---

### ğŸš€ **å…³é”®æ–‡ä»¶å®ç°**
#### 1. `public/index.html`
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰‹åŠ¨æ­å»ºReactåº”ç”¨</title>
</head>
<body>
  <div id="root"></div>
</body>
</html>
```

#### 2. `src/index.tsx`
```typescript
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './styles/global.scss'

const root = ReactDOM.createRoot(
  document.getElementById('root') as HTMLElement
)

root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
)
```

#### 3. `src/App.tsx` (å¸¦CSS Modules)
```typescript
import React from 'react'
import styles from './App.module.scss'

const App: React.FC = () => {
  return (
    <div className={styles.container}>
      <h1>æ‰‹åŠ¨æ­å»ºçš„Reactåº”ç”¨</h1>
      <p>åŸºäºWebpack + TypeScript</p>
    </div>
  )
}

export default App
```

---

### ğŸ“œ **NPM è„šæœ¬é…ç½®**
```json
{
  "scripts": {
    "start": "webpack serve --config webpack.config.ts",
    "build": "webpack --config webpack.prod.config.ts",
    "type-check": "tsc --noEmit",
    "lint": "eslint src --ext .ts,.tsx",
    "analyze": "webpack-bundle-analyzer dist/stats.json"
  }
}
```

---

### ğŸ” **é«˜çº§ä¼˜åŒ–æŠ€å·§**
#### 1. ä»£ç åˆ†å‰² (åŠ¨æ€å¯¼å…¥)
```typescript
// ä½¿ç”¨React.lazy + Suspense
const HeavyComponent = React.lazy(() => import('./components/HeavyComponent'))

function App() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <HeavyComponent />
    </Suspense>
  )
}
```

#### 2. æ€§èƒ½åˆ†ææ’ä»¶
```typescript
// webpack.prod.config.ts
import { BundleAnalyzerPlugin } from 'webpack-bundle-analyzer'

plugins: [
  new BundleAnalyzerPlugin({
    analyzerMode: 'static',
    reportFilename: 'bundle-analysis.html',
    openAnalyzer: false
  })
]
```

#### 3. ç¯å¢ƒå˜é‡æ³¨å…¥
```typescript
// webpack.config.ts
import Dotenv from 'dotenv-webpack'

plugins: [
  new Dotenv()
]

// ä½¿ç”¨ç¯å¢ƒå˜é‡
const apiUrl = process.env.API_URL
```

---

### ğŸ›¡ï¸ **å®‰å…¨åŠ å›ºæ–¹æ¡ˆ**
#### 1. CSP é…ç½®
```typescript
// webpack.prod.config.ts
import { DefinePlugin } from 'webpack'

plugins: [
  new DefinePlugin({
    'process.env.CSP_POLICY': JSON.stringify(
      "default-src 'self'; script-src 'self' 'unsafe-inline'"
    )
  })
]
```

#### 2. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
```bash
# å®‰è£…åŠ å¯†æ’ä»¶
npm install webpack-subresource-integrity --save-dev
```

```typescript
import { SubresourceIntegrityPlugin } from 'webpack-subresource-integrity'

output: {
  crossOriginLoading: 'anonymous'
},
plugins: [
  new SubresourceIntegrityPlugin()
]
```

---

### âš ï¸ **å¸¸è§é—®é¢˜è§£å†³**
1. **çƒ­æ›´æ–°å¤±æ•ˆ**ï¼š
   ```typescript
   devServer: {
     hot: true,
     client: {
       overlay: false
     }
   }
   ```

2. **TypeScript ç±»å‹æŠ¥é”™**ï¼š
   ```bash
   npm install @types/webpack @types/webpack-dev-server --save-dev
   ```

3. **è·¯å¾„åˆ«åé—®é¢˜**ï¼š
   ```json
   // tsconfig.json
   {
     "compilerOptions": {
       "baseUrl": "./",
       "paths": {
         "@/*": ["src/*"]
       }
     }
   }
   ```

---

### ğŸŒŸ **å®Œæ•´æ„å»ºæµç¨‹**
```mermaid
sequenceDiagram
    participant å¼€å‘è€…
    participant Webpack
    participant Babel
    participant TypeScript

    å¼€å‘è€…->>Webpack: æ‰§è¡Œ npm start
    Webpack->>TypeScript: ç±»å‹æ£€æŸ¥
    TypeScript-->>Webpack: é€šè¿‡
    Webpack->>Babel: è½¬è¯‘JSX/TS
    Babel-->>Webpack: ç”ŸæˆJS
    Webpack->>å¼€å‘è€…: å¯åŠ¨dev server
    å¼€å‘è€…->>Webpack: ä»£ç å˜æ›´
    Webpack->>å¼€å‘è€…: HMRçƒ­æ›´æ–°
```

é€šè¿‡è¿™å¥—é…ç½®ï¼Œä½ å¯ä»¥è·å¾—ï¼š
- å®Œæ•´çš„ React + TypeScript å¼€å‘ç¯å¢ƒ
- ç”Ÿäº§çº§ä»£ç ä¼˜åŒ–
- æ¨¡å—åŒ– CSS æ”¯æŒ
- é«˜æ•ˆçš„å¼€å‘ä½“éªŒ
- å¯æ‰©å±•çš„æ¶æ„åŸºç¡€

éœ€è¦é’ˆå¯¹ç‰¹å®šåœºæ™¯ï¼ˆå¦‚å¾®å‰ç«¯é›†æˆã€SSRæ”¯æŒã€æµ‹è¯•é…ç½®ç­‰ï¼‰çš„æ‰©å±•æ–¹æ¡ˆå—ï¼Ÿå¯ä»¥è¿›ä¸€æ­¥æ¢è®¨å…·ä½“éœ€æ±‚ã€‚