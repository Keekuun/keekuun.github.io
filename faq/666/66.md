## 66. JS æ‰§è¡Œ 100 ä¸‡ä¸ªä»»åŠ¡ï¼Œå¦‚ä½•ä¿è¯æµè§ˆå™¨ä¸å¡é¡¿ï¼Ÿ

åœ¨ JavaScript ä¸­æ‰§è¡Œ 100 ä¸‡ä¸ªä»»åŠ¡æ—¶ï¼Œå¦‚æœä¸åŠ ä»¥ä¼˜åŒ–ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ã€æµè§ˆå™¨å¡é¡¿ï¼ˆç”šè‡³é¡µé¢å´©æºƒï¼‰ã€‚ä»¥ä¸‹æ˜¯å‡ ç§æ ¸å¿ƒè§£å†³æ–¹æ¡ˆå’Œä¼˜åŒ–ç­–ç•¥ï¼š

---

## **1. ä»»åŠ¡åˆ†ç‰‡ï¼ˆChunkingï¼‰**
å°†å¤§ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå°ä»»åŠ¡ï¼Œåˆ†æ‰¹æ¬¡æ‰§è¡Œï¼Œé¿å…é•¿æ—¶é—´é˜»å¡ä¸»çº¿ç¨‹ã€‚

### **å®ç°æ–¹å¼**
#### **(1) ä½¿ç”¨ `setTimeout` æˆ– `setInterval`**
```typescript
function processChunk(tasks: any[], index: number = 0, chunkSize: number = 1000) {
  const end = Math.min(index + chunkSize, tasks.length);
  for (let i = index; i < end; i++) {
    processTask(tasks[i]); // æ‰§è¡Œå•ä¸ªä»»åŠ¡
  }
  if (end < tasks.length) {
    setTimeout(() => processChunk(tasks, end, chunkSize), 0); // ä¸‹ä¸€æ‰¹æ¬¡
  }
}

processChunk(Array(1e6).fill(null)); // å¯åŠ¨ä»»åŠ¡
```

#### **(2) ä½¿ç”¨ `requestIdleCallback`ï¼ˆæ›´é€‚åˆä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼‰**
```typescript
function processIdleChunk(tasks: any[], index: number = 0) {
  if (index >= tasks.length) return;
  requestIdleCallback((deadline) => {
    while (deadline.timeRemaining() > 0 && index < tasks.length) {
      processTask(tasks[index++]);
    }
    processIdleChunk(tasks, index); // ç»§ç»­å¤„ç†å‰©ä½™ä»»åŠ¡
  });
}
```

âœ… **ä¼˜ç‚¹**ï¼š
- ä¸»çº¿ç¨‹å¯å¤„ç†ç”¨æˆ·äº¤äº’ï¼Œé¿å…å¡é¡¿ã€‚
- å…¼å®¹æ€§å¥½ï¼ˆ`setTimeout` æ‰€æœ‰æµè§ˆå™¨æ”¯æŒï¼‰ã€‚

âŒ **ç¼ºç‚¹**ï¼š
- `setTimeout` çš„å»¶è¿Ÿä¸ç²¾ç¡®ï¼Œå¯èƒ½ä»æœ‰è½»å¾®å¡é¡¿ã€‚

---

## **2. Web Workersï¼ˆå¤šçº¿ç¨‹ï¼‰**
å°†è®¡ç®—å¯†é›†å‹ä»»åŠ¡æ”¾åˆ°åå°çº¿ç¨‹ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹ã€‚

### **å®ç°æ­¥éª¤**
#### **(1) åˆ›å»º Worker è„šæœ¬ï¼ˆ`worker.js`ï¼‰**
```javascript
// worker.js
self.onmessage = function (e) {
  const tasks = e.data;
  const results = tasks.map(processTask); // å¤„ç†ä»»åŠ¡
  self.postMessage(results); // è¿”å›ç»“æœ
};
```

#### **(2) ä¸»çº¿ç¨‹è°ƒç”¨**
```typescript
const worker = new Worker('worker.js');
worker.postMessage(Array(1e6).fill(null)); // å‘é€ä»»åŠ¡

worker.onmessage = function (e) {
  console.log('Results:', e.data); // æ¥æ”¶ç»“æœ
};
```

âœ… **ä¼˜ç‚¹**ï¼š
- å½»åº•é¿å…ä¸»çº¿ç¨‹å¡é¡¿ã€‚
- é€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚åŠ å¯†ã€å¤§æ•°æ®å¤„ç†ï¼‰ã€‚

âŒ **ç¼ºç‚¹**ï¼š
- æ— æ³•ç›´æ¥æ“ä½œ DOMã€‚
- é€šä¿¡å¼€é”€è¾ƒå¤§ï¼ˆéœ€åºåˆ—åŒ–æ•°æ®ï¼‰ã€‚

---

## **3. å¼‚æ­¥è¿­ä»£ï¼ˆGenerator + Promiseï¼‰**
ç»“åˆç”Ÿæˆå™¨å’Œå¼‚æ­¥å‡½æ•°ï¼Œåˆ†æ‰¹æ¬¡å¤„ç†ä»»åŠ¡ã€‚

### **å®ç°ä»£ç **
```typescript
async function processTasksAsync(tasks: any[], chunkSize: number = 1000) {
  for (let i = 0; i < tasks.length; i += chunkSize) {
    const chunk = tasks.slice(i, i + chunkSize);
    await Promise.all(chunk.map(processTask)); // å¹¶è¡Œå¤„ç†
    await new Promise(resolve => setTimeout(resolve, 0)); // é‡Šæ”¾ä¸»çº¿ç¨‹
  }
}

processTasksAsync(Array(1e6).fill(null));
```

âœ… **ä¼˜ç‚¹**ï¼š
- æ”¯æŒå¹¶è¡Œå¤„ç†ï¼ˆ`Promise.all`ï¼‰ã€‚
- ä»£ç å¯è¯»æ€§é«˜ã€‚

âŒ **ç¼ºç‚¹**ï¼š
- å¹¶è¡Œä»»åŠ¡è¿‡å¤šä»å¯èƒ½å¡é¡¿ã€‚

---

## **4. æ—¶é—´åˆ‡ç‰‡ï¼ˆTime Slicingï¼‰**
åˆ©ç”¨ `requestAnimationFrame` æˆ– `requestIdleCallback` åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡ã€‚

### **ç¤ºä¾‹ä»£ç **
```typescript
function processTimeSlice(tasks: any[], index: number = 0) {
  if (index >= tasks.length) return;
  requestAnimationFrame(() => {
    const start = performance.now();
    while (performance.now() - start < 10 && index < tasks.length) { // æ¯å¸§æœ€å¤šæ‰§è¡Œ 10ms
      processTask(tasks[index++]);
    }
    processTimeSlice(tasks, index);
  });
}
```

âœ… **ä¼˜ç‚¹**ï¼š
- ä¸æµè§ˆå™¨æ¸²æŸ“å¸§ç‡åŒæ­¥ï¼Œç”¨æˆ·ä½“éªŒæµç•…ã€‚

âŒ **ç¼ºç‚¹**ï¼š
- å®ç°è¾ƒå¤æ‚ã€‚

---

## **5. æ€§èƒ½ä¼˜åŒ–æŠ€å·§**
### **(1) å‡å°‘é‡å¤è®¡ç®—**
- ä½¿ç”¨ç¼“å­˜ï¼ˆå¦‚ Memoizationï¼‰é¿å…é‡å¤å¤„ç†ç›¸åŒæ•°æ®ã€‚
- é¢„å¤„ç†æ•°æ®ï¼ˆå¦‚æ’åºã€å“ˆå¸Œï¼‰ã€‚

### **(2) é¿å…é¢‘ç¹ DOM æ“ä½œ**
- æ‰¹é‡æ›´æ–° DOMï¼ˆå¦‚æ–‡æ¡£ç‰‡æ®µ `DocumentFragment`ï¼‰ã€‚
- ä½¿ç”¨è™šæ‹Ÿ DOM åº“ï¼ˆå¦‚ Reactã€Vueï¼‰ã€‚

### **(3) ä½¿ç”¨é«˜æ•ˆæ•°æ®ç»“æ„**
- æ¢ç”¨ `Map`/`Set` æ›¿ä»£æ™®é€šå¯¹è±¡ï¼Œæå‡æŸ¥æ‰¾é€Ÿåº¦ã€‚
- å¯¹å¤§æ•°æ®ä½¿ç”¨ `TypedArray`ï¼ˆå¦‚ `Uint32Array`ï¼‰ã€‚

### **(4) åƒåœ¾å›æ”¶ä¼˜åŒ–**
- åŠæ—¶é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å˜é‡ï¼ˆè®¾ä¸º `null`ï¼‰ã€‚
- é¿å…å†…å­˜æ³„æ¼ï¼ˆå¦‚æœªæ¸…é™¤çš„å®šæ—¶å™¨ã€é—­åŒ…ï¼‰ã€‚

---

## **6. æ–¹æ¡ˆå¯¹æ¯”**
| **æ–¹æ³•**            | **é€‚ç”¨åœºæ™¯**                | **æ˜¯å¦é˜»å¡ä¸»çº¿ç¨‹** | **å®ç°éš¾åº¦** |
|---------------------|----------------------------|--------------------|--------------|
| **ä»»åŠ¡åˆ†ç‰‡**        | é€šç”¨åœºæ™¯                   | å¦                 | ä½           |
| **Web Workers**     | CPU å¯†é›†å‹ä»»åŠ¡             | å¦                 | ä¸­           |
| **å¼‚æ­¥è¿­ä»£**        | éœ€è¦å¹¶è¡Œå¤„ç†               | éƒ¨åˆ†é˜»å¡           | ä¸­           |
| **æ—¶é—´åˆ‡ç‰‡**        | åŠ¨ç”»/é«˜ä¼˜å…ˆçº§ä»»åŠ¡          | å¦                 | é«˜           |

---

## **7. å®æˆ˜å»ºè®®**
1. **ç®€å•ä»»åŠ¡**ï¼šç”¨ `setTimeout` åˆ†ç‰‡ã€‚
2. **å¤æ‚è®¡ç®—**ï¼šä¼˜å…ˆé€‰ **Web Workers**ã€‚
3. **åŠ¨ç”»ç›¸å…³**ï¼šç”¨ `requestAnimationFrame` æ—¶é—´åˆ‡ç‰‡ã€‚
4. **å…¼å®¹æ€§è¦æ±‚é«˜**ï¼šåˆ†ç‰‡ + é™çº§ç­–ç•¥ã€‚

---

## **8. å®Œæ•´ç¤ºä¾‹ï¼ˆåˆ†ç‰‡ + Worker ç»“åˆï¼‰**
```typescript
// ä¸»çº¿ç¨‹
const worker = new Worker('worker.js');
const tasks = Array(1e6).fill(null);
let index = 0;

function scheduleChunk() {
  const chunk = tasks.slice(index, index + 1000);
  if (chunk.length === 0) return;
  worker.postMessage(chunk);
  index += 1000;
  setTimeout(scheduleChunk, 0); // ç»§ç»­è°ƒåº¦
}

scheduleChunk();
```

é€šè¿‡ä»¥ä¸Šæ–¹æ³•ï¼Œå¯ä»¥é«˜æ•ˆæ‰§è¡Œæµ·é‡ä»»åŠ¡è€Œä¸å¡é¡¿æµè§ˆå™¨ï¼ ğŸš€