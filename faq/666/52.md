## 52. 前端如何用 canvas 来做电影院选票功能

使用 HTML5 `<canvas>` 实现电影院选票功能是一种高效、灵活的方案。Canvas 允许我们直接在画布上绘制图形，非常适合用于座位布局、选中状态展示等交互场景。

下面是一个完整的实现方案，包含座位绘制、选中状态、座位价格、选座限制等实用功能，并使用 TypeScript 进行类型安全处理。

---

## 🎥 一、功能目标

- 展示影院座位布局
- 支持点击选座与取消选座
- 显示选中座位数量和总价
- 限制最多选座数量
- 支持不同座位价格（如 VIP 座位更贵）

---

## 🧩 二、数据结构设计

```typescript
type SeatState = 'available' | 'selected' | 'occupied';

interface Seat {
  state: SeatState;
  price: number;
}

// 座位布局二维数组
const seats: Seat[][] = [
  // 行数为 8，列数为 10，VIP 座位价格更高
  Array(10).fill({ state: 'available', price: 40 }),
  Array(10).fill({ state: 'available', price: 40 }),
  Array(10).fill({ state: 'available', price: 35 }),
  Array(10).fill({ state: 'available', price: 35 }),
  Array(10).fill({ state: 'available', price: 30 }),
  Array(10).fill({ state: 'available', price: 30 }),
  Array(10).fill({ state: 'available', price: 25 }),
  Array(10).fill({ state: 'available', price: 25 }),
];
```

---

## 🎨 三、Canvas 初始化与绘制

```typescript
const canvas = document.createElement('canvas');
canvas.width = 800;
canvas.height = 600;
document.body.appendChild(canvas);

const ctx = canvas.getContext('2d')!;
const seatWidth = 40;
const seatHeight = 40;
const margin = 10;
const maxSelection = 5;

// 用于记录当前选中的座位
const selectedSeats = new Set<string>();

function drawSeats() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (let row = 0; row < seats.length; row++) {
    for (let col = 0; col < seats[row].length; col++) {
      const seat = seats[row][col];
      const x = margin + col * (seatWidth + margin);
      const y = margin + row * (seatHeight + margin);

      // 填充颜色
      if (seat.state === 'occupied') {
        ctx.fillStyle = '#ccc'; // 灰色表示不可选
      } else if (selectedSeats.has(`${row}-${col}`)) {
        ctx.fillStyle = 'red'; // 已选中
      } else {
        ctx.fillStyle = 'green'; // 可选
      }

      ctx.fillRect(x, y, seatWidth, seatHeight);
      ctx.strokeStyle = '#000';
      ctx.strokeRect(x, y, seatWidth, seatHeight);

      // 显示价格
      ctx.fillStyle = 'white';
      ctx.font = '12px Arial';
      ctx.fillText(`¥${seat.price}`, x + 5, y + 20);
    }
  }

  // 显示选中信息
  const selected = [...selectedSeats].length;
  const total = [...selectedSeats]
    .reduce((sum, key) => {
      const [row, col] = key.split('-').map(Number);
      return sum + seats[row][col].price;
    }, 0);

  ctx.fillStyle = '#000';
  ctx.font = '16px Arial';
  ctx.fillText(`已选座位: ${selected} 个，总价: ¥${total}`, 20, canvas.height - 30);
}
```

---

## 🖱️ 四、鼠标点击事件处理

```typescript
canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const clickY = e.clientY - rect.top;

  for (let row = 0; row < seats.length; row++) {
    for (let col = 0; col < seats[row].length; col++) {
      const seat = seats[row][col];
      const x = margin + col * (seatWidth + margin);
      const y = margin + row * (seatHeight + margin);

      if (
        clickX >= x &&
        clickX <= x + seatWidth &&
        clickY >= y &&
        clickY <= y + seatHeight
      ) {
        const key = `${row}-${col}`;

        if (seat.state === 'occupied') return;

        if (selectedSeats.has(key)) {
          selectedSeats.delete(key);
        } else {
          if (selectedSeats.size >= maxSelection) {
            alert(`最多只能选 ${maxSelection} 个座位`);
            return;
          }
          selectedSeats.add(key);
        }

        drawSeats();
        return;
      }
    }
  }
});
```

---

## ✅ 五、完整调用

```typescript
drawSeats(); // 初始绘制
```

---

## 🧠 六、可扩展功能建议

- **支持拖动选座**：通过监听 `mousedown`, `mousemove`, `mouseup` 实现拖动选座
- **保存选座状态**：使用 localStorage 或发送到后端
- **座位颜色区分**：根据价格不同使用不同颜色
- **响应式设计**：根据屏幕大小动态调整画布尺寸
- **动画效果**：添加选中时的动画或高亮效果

---

## 📌 七、总结

使用 Canvas 实现电影院选座功能，具有以下优势：

| 特性 | 说明 |
|------|------|
| **性能高** | 直接操作像素，渲染效率高 |
| **灵活布局** | 可以自由设计座位形状和样式 |
| **交互丰富** | 支持点击、拖动、悬停等交互 |
| **易于扩展** | 可集成动画、价格、状态等逻辑 |

如果你希望将此功能封装成组件（如 React 组件），也可以进一步封装成可复用的 UI 模块，欢迎继续提问哦！

🎬 **现在你可以直接在页面中看到一个电影院的座位图，点击座位即可选中，最多选 5 个，总价自动计算。**
