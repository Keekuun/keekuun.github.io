## 121. [Webpack] æœ‰å“ªäº›ä¼˜åŒ–é¡¹ç›®çš„æ‰‹æ®µï¼Ÿ

Webpack æ˜¯å‰ç«¯æ„å»ºçš„æ ¸å¿ƒå·¥å…·ï¼Œä¼˜åŒ–å…¶æ€§èƒ½å¯ä»¥æ˜¾è‘—æå‡å¼€å‘ä½“éªŒå’Œç”Ÿäº§ç¯å¢ƒæ•ˆç‡ã€‚ä»¥ä¸‹æ˜¯ **å¼€å‘é˜¶æ®µ** å’Œ **ç”Ÿäº§ç¯å¢ƒ** çš„å®Œæ•´ä¼˜åŒ–æ‰‹æ®µï¼Œç»“åˆç°ä»£å‰ç«¯æŠ€æœ¯æ ˆï¼ˆå¦‚ React + TypeScriptï¼‰çš„å®è·µç¤ºä¾‹ï¼š

---

## ğŸŒŸ **æ ¸å¿ƒä¼˜åŒ–ç›®æ ‡**
1. **ç¼©çŸ­æ„å»ºæ—¶é—´**ï¼ˆå¼€å‘é˜¶æ®µï¼‰
2. **å‡å°‘äº§å‡ºä½“ç§¯**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
3. **æå‡è¿è¡Œæ—¶æ€§èƒ½**ï¼ˆå¦‚ç¼“å­˜ã€æ‡’åŠ è½½ï¼‰
4. **æ”¹å–„å¼€å‘è€…ä½“éªŒ**ï¼ˆå¦‚ HMR çƒ­æ›´æ–°ï¼‰

---

## ğŸ›  **å¼€å‘é˜¶æ®µä¼˜åŒ–**
### ğŸ“Œ **1. æé€Ÿæ„å»º**
#### âœ… **ç¼©å° Loader å¤„ç†èŒƒå›´**
```javascript
// webpack.config.js
module.exports = {
  module: {
    rules: [
      {
        test: /\.tsx?$/,
        exclude: /node_modules/, // å¿½ç•¥ node_modules
        use: 'ts-loader'
      }
    ]
  }
};
```

#### âœ… **ä½¿ç”¨ `cache-loader` æˆ– Webpack 5 æŒä¹…åŒ–ç¼“å­˜**
```javascript
// webpack 5 å†…ç½®ç¼“å­˜
module.exports = {
  cache: {
    type: 'filesystem', // æŒä¹…åŒ–ç¼“å­˜åˆ°ç£ç›˜
  }
};

// æˆ–ä½¿ç”¨ cache-loaderï¼ˆæ—§ç‰ˆæœ¬ï¼‰
{
  test: /\.jsx?$/,
  use: ['cache-loader', 'babel-loader']
}
```

#### âœ… **å¼€å¯å¤šçº¿ç¨‹æ„å»ºï¼ˆ`thread-loader`ï¼‰**
```javascript
{
  test: /\.tsx?$/,
  use: [
    'thread-loader', // æ”¾åœ¨è€—æ—¶ loader å‰
    'ts-loader'
  ]
}
```

---

### ğŸ“Œ **2. ä¼˜åŒ–å¼€å‘ä½“éªŒ**
#### âœ… **åŠ é€Ÿ HMRï¼ˆçƒ­æ¨¡å—æ›¿æ¢ï¼‰**
```javascript
devServer: {
  hot: true, // å¯ç”¨ HMR
  devMiddleware: {
    writeToDisk: true // å¼€å‘æ¨¡å¼å†™å…¥ç£ç›˜ï¼ˆå…¼å®¹éƒ¨åˆ†å·¥å…·ï¼‰
  }
}
```

#### âœ… **ç¼©å° DevTool èŒƒå›´**
```javascript
// å¼€å‘ç¯å¢ƒä½¿ç”¨ cheap-module-source-mapï¼ˆå¹³è¡¡è´¨é‡å’Œé€Ÿåº¦ï¼‰
devtool: process.env.NODE_ENV === 'development' 
  ? 'cheap-module-source-map' 
  : 'source-map';
```

---

## ğŸš€ **ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–**
### ğŸ“Œ **1. ä»£ç ä½“ç§¯ä¼˜åŒ–**
#### âœ… **Tree Shakingï¼ˆæ‘‡æ ‘ä¼˜åŒ–ï¼‰**
```javascript
// 1. ç¡®ä¿ä½¿ç”¨ ES Moduleï¼ˆå¦‚ import/exportï¼‰
// 2. åœ¨ package.json ä¸­æ ‡è®°å‰¯ä½œç”¨
{
  "sideEffects": ["*.css", "*.global.ts"]
}

// 3. Webpack é…ç½®ï¼ˆé»˜è®¤å¼€å¯ï¼‰
optimization: {
  usedExports: true,
}
```

#### âœ… **ä»£ç åˆ†å‰²ï¼ˆCode Splittingï¼‰**
```javascript
// åŠ¨æ€å¯¼å…¥ï¼ˆReact æ‡’åŠ è½½ç¤ºä¾‹ï¼‰
const LazyComponent = React.lazy(() => import('./HeavyComponent'));

// Webpack è‡ªåŠ¨ç”Ÿæˆåˆ†åŒ…
optimization: {
  splitChunks: {
    chunks: 'all', // åˆ†ç¦» node_modules å’Œå…¬å…±æ¨¡å—
  },
  runtimeChunk: 'single' // åˆ†ç¦» runtime ä»£ç 
}
```

#### âœ… **å‹ç¼©ä»£ç ï¼ˆTerserPluginï¼‰**
```javascript
const TerserPlugin = require('terser-webpack-plugin');

optimization: {
  minimize: true,
  minimizer: [new TerserPlugin({
    parallel: true, // å¤šçº¿ç¨‹å‹ç¼©
    terserOptions: {
      compress: { drop_console: true } // ç§»é™¤ console
    }
  })],
}
```

---

### ğŸ“Œ **2. èµ„æºä¼˜åŒ–**
#### âœ… **å‹ç¼©å›¾ç‰‡ï¼ˆ`image-webpack-loader`ï¼‰**
```javascript
{
  test: /\.(png|jpg|gif)$/,
  use: [
    'file-loader',
    {
      loader: 'image-webpack-loader',
      options: {
        mozjpeg: { quality: 80 } // è‡ªå®šä¹‰å‹ç¼©å‚æ•°
      }
    }
  ]
}
```

#### âœ… **å†…è”å°èµ„æºï¼ˆ`url-loader`ï¼‰**
```javascript
{
  test: /\.svg$/,
  use: [{
    loader: 'url-loader',
    options: {
      limit: 8192, // <8KB è½¬ä¸º Base64
      name: '[name].[hash:8].[ext]'
    }
  }]
}
```

---

### ğŸ“Œ **3. é«˜çº§ä¼˜åŒ–**
#### âœ… **é¢„ç¼–è¯‘ä¾èµ–ï¼ˆDLLPluginï¼‰**
```javascript
// 1. å•ç‹¬æ„å»º vendor
webpack --config webpack.vendor.config.js

// 2. ä¸»é…ç½®å¼•ç”¨ DLL
plugins: [
  new webpack.DllReferencePlugin({
    manifest: require('./vendor-manifest.json')
  })
]
```

#### âœ… **ä½¿ç”¨ CDN åŠ è½½ç¬¬ä¸‰æ–¹åº“**
```javascript
externals: {
  react: 'React', // ä» CDN å¼•å…¥
  'react-dom': 'ReactDOM'
}

// å¹¶åœ¨ HTML ä¸­æ‰‹åŠ¨æ·»åŠ  script æ ‡ç­¾
```

---

## ğŸ”§ **å·¥å…·é“¾è¾…åŠ©ä¼˜åŒ–**
### âœ… **åˆ†ææ„å»ºä½“ç§¯ï¼ˆ`webpack-bundle-analyzer`ï¼‰**
```javascript
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin;

plugins: [
  new BundleAnalyzerPlugin({ analyzerMode: 'static' })
]
```

### âœ… **è‡ªå®šä¹‰ Plugin ä¼˜åŒ–**
```javascript
// ç¤ºä¾‹ï¼šåˆ é™¤æ— ç”¨è¯­è¨€åŒ…
class RemoveMomentLocalesPlugin {
  apply(compiler) {
    compiler.hooks.emit.tap('RemoveMomentLocales', compilation => {
      Object.keys(compilation.assets).forEach(name => {
        if (/moment[\\/]locale[\\/]/.test(name)) {
          delete compilation.assets[name];
        }
      });
    });
  }
}
```

---

## ğŸ›¡ï¸ **ç¨³å®šæ€§ä¿éšœ**
| **é—®é¢˜**          | **è§£å†³æ–¹æ¡ˆ**                              |
|-------------------|-----------------------------------------|
| æ„å»ºå†…å­˜æº¢å‡º      | å¢åŠ  Node.js å†…å­˜é™åˆ¶ï¼ˆ`NODE_OPTIONS=--max-old-space-size=4096`ï¼‰ |
| ç¼“å­˜å¤±æ•ˆ          | åŒºåˆ†å¼€å‘/ç”Ÿäº§ç¯å¢ƒç¼“å­˜è·¯å¾„                |
| çƒ­æ›´æ–°å¡é¡¿        | ç¼©å° HMR ç›‘å¬èŒƒå›´ï¼ˆå¦‚ `devServer.watchFiles`ï¼‰ |

---

## ğŸ“¦ **å®Œæ•´é…ç½®ç¤ºä¾‹**
```javascript
// webpack.prod.js
const { merge } = require('webpack-merge');
const baseConfig = require('./webpack.base');

module.exports = merge(baseConfig, {
  mode: 'production',
  devtool: 'source-map',
  optimization: {
    splitChunks: { chunks: 'all' },
    minimizer: [new TerserPlugin()],
  },
  plugins: [new BundleAnalyzerPlugin()]
});
```

---

## ğŸ¯ **ä¼˜åŒ–æ•ˆæœéªŒè¯**
1. **æ„å»ºæ—¶é—´å¯¹æ¯”**ï¼š`before: 120s â†’ after: 45s`
2. **äº§å‡ºä½“ç§¯å¯¹æ¯”**ï¼š`before: 5MB â†’ after: 1.8MB`
3. **Lighthouse è¯„åˆ†**ï¼šæå‡è‡³ 90+

---

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–æ‰‹æ®µï¼Œä½ çš„ Webpack é¡¹ç›®å°†è·å¾—ï¼š
âœ… **æé€Ÿæ„å»º** - å¼€å‘ç¯å¢ƒç§’çº§ç¼–è¯‘
âœ… **æœ€å°äº§å‡º** - ç”Ÿäº§ç¯å¢ƒä½“ç§¯ç¼©å‡ 60%+
âœ… **é•¿æ•ˆç¼“å­˜** - åˆ©ç”¨ hash å’Œä»£ç åˆ†å‰²æå‡ç¼“å­˜å‘½ä¸­ç‡

é€‚ç”¨äºå¤§å‹ä¼ä¸šçº§åº”ç”¨å’Œå¤æ‚ SPA é¡¹ç›®ï¼ ğŸš€