## 121. [Webpack] 有哪些优化项目的手段？

Webpack 是前端构建的核心工具，优化其性能可以显著提升开发体验和生产环境效率。以下是 **开发阶段** 和 **生产环境** 的完整优化手段，结合现代前端技术栈（如 React + TypeScript）的实践示例：

---

## 🌟 **核心优化目标**
1. **缩短构建时间**（开发阶段）
2. **减少产出体积**（生产环境）
3. **提升运行时性能**（如缓存、懒加载）
4. **改善开发者体验**（如 HMR 热更新）

---

## 🛠 **开发阶段优化**
### 📌 **1. 提速构建**
#### ✅ **缩小 Loader 处理范围**
```javascript
// webpack.config.js
module.exports = {
  module: {
    rules: [
      {
        test: /\.tsx?$/,
        exclude: /node_modules/, // 忽略 node_modules
        use: 'ts-loader'
      }
    ]
  }
};
```

#### ✅ **使用 `cache-loader` 或 Webpack 5 持久化缓存**
```javascript
// webpack 5 内置缓存
module.exports = {
  cache: {
    type: 'filesystem', // 持久化缓存到磁盘
  }
};

// 或使用 cache-loader（旧版本）
{
  test: /\.jsx?$/,
  use: ['cache-loader', 'babel-loader']
}
```

#### ✅ **开启多线程构建（`thread-loader`）**
```javascript
{
  test: /\.tsx?$/,
  use: [
    'thread-loader', // 放在耗时 loader 前
    'ts-loader'
  ]
}
```

---

### 📌 **2. 优化开发体验**
#### ✅ **加速 HMR（热模块替换）**
```javascript
devServer: {
  hot: true, // 启用 HMR
  devMiddleware: {
    writeToDisk: true // 开发模式写入磁盘（兼容部分工具）
  }
}
```

#### ✅ **缩小 DevTool 范围**
```javascript
// 开发环境使用 cheap-module-source-map（平衡质量和速度）
devtool: process.env.NODE_ENV === 'development' 
  ? 'cheap-module-source-map' 
  : 'source-map';
```

---

## 🚀 **生产环境优化**
### 📌 **1. 代码体积优化**
#### ✅ **Tree Shaking（摇树优化）**
```javascript
// 1. 确保使用 ES Module（如 import/export）
// 2. 在 package.json 中标记副作用
{
  "sideEffects": ["*.css", "*.global.ts"]
}

// 3. Webpack 配置（默认开启）
optimization: {
  usedExports: true,
}
```

#### ✅ **代码分割（Code Splitting）**
```javascript
// 动态导入（React 懒加载示例）
const LazyComponent = React.lazy(() => import('./HeavyComponent'));

// Webpack 自动生成分包
optimization: {
  splitChunks: {
    chunks: 'all', // 分离 node_modules 和公共模块
  },
  runtimeChunk: 'single' // 分离 runtime 代码
}
```

#### ✅ **压缩代码（TerserPlugin）**
```javascript
const TerserPlugin = require('terser-webpack-plugin');

optimization: {
  minimize: true,
  minimizer: [new TerserPlugin({
    parallel: true, // 多线程压缩
    terserOptions: {
      compress: { drop_console: true } // 移除 console
    }
  })],
}
```

---

### 📌 **2. 资源优化**
#### ✅ **压缩图片（`image-webpack-loader`）**
```javascript
{
  test: /\.(png|jpg|gif)$/,
  use: [
    'file-loader',
    {
      loader: 'image-webpack-loader',
      options: {
        mozjpeg: { quality: 80 } // 自定义压缩参数
      }
    }
  ]
}
```

#### ✅ **内联小资源（`url-loader`）**
```javascript
{
  test: /\.svg$/,
  use: [{
    loader: 'url-loader',
    options: {
      limit: 8192, // <8KB 转为 Base64
      name: '[name].[hash:8].[ext]'
    }
  }]
}
```

---

### 📌 **3. 高级优化**
#### ✅ **预编译依赖（DLLPlugin）**
```javascript
// 1. 单独构建 vendor
webpack --config webpack.vendor.config.js

// 2. 主配置引用 DLL
plugins: [
  new webpack.DllReferencePlugin({
    manifest: require('./vendor-manifest.json')
  })
]
```

#### ✅ **使用 CDN 加载第三方库**
```javascript
externals: {
  react: 'React', // 从 CDN 引入
  'react-dom': 'ReactDOM'
}

// 并在 HTML 中手动添加 script 标签
```

---

## 🔧 **工具链辅助优化**
### ✅ **分析构建体积（`webpack-bundle-analyzer`）**
```javascript
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin;

plugins: [
  new BundleAnalyzerPlugin({ analyzerMode: 'static' })
]
```

### ✅ **自定义 Plugin 优化**
```javascript
// 示例：删除无用语言包
class RemoveMomentLocalesPlugin {
  apply(compiler) {
    compiler.hooks.emit.tap('RemoveMomentLocales', compilation => {
      Object.keys(compilation.assets).forEach(name => {
        if (/moment[\\/]locale[\\/]/.test(name)) {
          delete compilation.assets[name];
        }
      });
    });
  }
}
```

---

## 🛡️ **稳定性保障**
| **问题**          | **解决方案**                              |
|-------------------|-----------------------------------------|
| 构建内存溢出      | 增加 Node.js 内存限制（`NODE_OPTIONS=--max-old-space-size=4096`） |
| 缓存失效          | 区分开发/生产环境缓存路径                |
| 热更新卡顿        | 缩小 HMR 监听范围（如 `devServer.watchFiles`） |

---

## 📦 **完整配置示例**
```javascript
// webpack.prod.js
const { merge } = require('webpack-merge');
const baseConfig = require('./webpack.base');

module.exports = merge(baseConfig, {
  mode: 'production',
  devtool: 'source-map',
  optimization: {
    splitChunks: { chunks: 'all' },
    minimizer: [new TerserPlugin()],
  },
  plugins: [new BundleAnalyzerPlugin()]
});
```

---

## 🎯 **优化效果验证**
1. **构建时间对比**：`before: 120s → after: 45s`
2. **产出体积对比**：`before: 5MB → after: 1.8MB`
3. **Lighthouse 评分**：提升至 90+

---

通过以上优化手段，你的 Webpack 项目将获得：
✅ **极速构建** - 开发环境秒级编译
✅ **最小产出** - 生产环境体积缩减 60%+
✅ **长效缓存** - 利用 hash 和代码分割提升缓存命中率

适用于大型企业级应用和复杂 SPA 项目！ 🚀