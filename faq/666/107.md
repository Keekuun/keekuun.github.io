## 107. 常见的登录鉴权方式有哪些？

在 Web 和应用开发中，常见的登录鉴权方式有以下几种，每种方式都有其适用场景和优缺点：

---

### 🔑 **1. 基于 Session 的鉴权**
- **原理**：服务器在用户登录后创建 Session 并存储，客户端通过 Cookie 携带 Session ID。
- **适用场景**：传统的 Web 应用（如电商网站）。
- **优点**：
    - 实现简单，兼容性好。
    - 服务器完全控制 Session 生命周期。
- **缺点**：
    - 不适用于分布式系统（需共享 Session 存储）。
    - 依赖 Cookie，可能受 CSRF 攻击。

#### 📜 代码示例（Express.js）：
```typescript
import express from 'express';
import session from 'express-session';

const app = express();
app.use(session({
    secret: 'your-secret-key',
    resave: false,
    saveUninitialized: true,
}));

app.post('/login', (req, res) => {
    req.session.user = { id: 123, name: 'Alice' }; // 存储用户信息
    res.send('登录成功！');
});

app.get('/profile', (req, res) => {
    if (!req.session.user) return res.status(401).send('未登录');
    res.send(`欢迎, ${req.session.user.name}`);
});
```

---

### 🔑 **2. 基于 Token 的鉴权（如 JWT）**
- **原理**：服务器生成 Token（如 JWT）并返回给客户端，客户端在请求头中携带 Token。
- **适用场景**：前后端分离、移动端、API 服务。
- **优点**：
    - 无状态，适合分布式系统。
    - 支持跨域。
- **缺点**：
    - Token 一旦泄露无法直接撤销（需结合黑名单或短有效期）。

#### 📜 代码示例（JWT）：
```typescript
import jwt from 'jsonwebtoken';

const secret = 'your-secret-key';

// 生成 Token
const token = jwt.sign({ userId: 123 }, secret, { expiresIn: '1h' });
console.log('Token:', token);

// 验证 Token
jwt.verify(token, secret, (err, decoded) => {
    if (err) console.error('Token 无效');
    else console.log('用户 ID:', decoded.userId);
});
```

---

### 🔑 **3. OAuth2.0 / OpenID Connect**
- **原理**：通过授权服务器颁发令牌（如 Access Token、ID Token），第三方应用使用令牌访问资源。
- **适用场景**：社交登录（如微信、Google 登录）、API 授权。
- **优点**：
    - 用户无需暴露密码给第三方。
    - 支持权限细分（Scope）。
- **缺点**：
    - 实现复杂。
    - 依赖第三方服务。

#### 📜 代码示例（OAuth2.0）：
```typescript
// 参见问题 105 的示例代码
```

---

### 🔑 **4. SSO（单点登录）**
- **原理**：用户登录一次后，可访问多个关联系统（如企业内网）。
- **实现方式**：SAML、OAuth2.0、CAS 协议等。
- **优点**：
    - 提升用户体验。
    - 集中管理权限。
- **缺点**：
    - 部署和维护成本高。

#### 📜 代码示例（SAML）：
需使用库如 `saml2-js`，此处略。

---

### 🔑 **5. 基于密码哈希的鉴权**
- **原理**：用户密码加盐哈希后存储，登录时验证哈希值。
- **适用场景**：所有需要密码存储的系统。
- **优点**：
    - 避免明文存储密码。
- **缺点**：
    - 需防范彩虹表攻击。

#### 📜 代码示例（Bcrypt）：
```typescript
import bcrypt from 'bcrypt';

const saltRounds = 10;
const password = 'user-password';

// 哈希密码
bcrypt.hash(password, saltRounds, (err, hash) => {
    console.log('哈希密码:', hash);
});

// 验证密码
bcrypt.compare(password, hash, (err, result) => {
    console.log('密码匹配:', result);
});
```

---

### 🔑 **6. 双因素认证（2FA）**
- **原理**：结合密码 + 动态验证码（如短信、TOTP）。
- **适用场景**：高安全性需求（如银行、企业系统）。
- **优点**：
    - 显著提升安全性。
- **缺点**：
    - 增加用户操作步骤。

#### 📜 代码示例（TOTP）：
```typescript
import speakeasy from 'speakeasy';

// 生成密钥
const secret = speakeasy.generateSecret();
console.log('TOTP 密钥:', secret.base32);

// 生成验证码
const token = speakeasy.totp({
    secret: secret.base32,
    encoding: 'base32',
});
console.log('动态验证码:', token);

// 验证
const isValid = speakeasy.totp.verify({
    secret: secret.base32,
    encoding: 'base32',
    token: userInput,
});
console.log('验证结果:', isValid);
```

---

### 🎯 **如何选择鉴权方式？**
| **场景**               | **推荐方式**               |
|------------------------|---------------------------|
| 传统 Web 应用          | Session + Cookie          |
| 前后端分离/API         | JWT                       |
| 社交登录               | OAuth2.0 / OpenID Connect |
| 企业内网               | SSO（如 SAML）            |
| 高安全性需求           | 2FA + 密码哈希            |

---

### ⚠️ **安全注意事项**
1. 始终使用 HTTPS。
2. 敏感数据（如密码）必须加盐哈希。
3. Token 设置合理有效期。
4. 防范 CSRF、XSS 等攻击。

选择合适的鉴权方式可以平衡安全性、用户体验和开发成本！ 🚀