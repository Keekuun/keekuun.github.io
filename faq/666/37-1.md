##　37. 如何实现网页加载进度条？ —— 监听静态资源加载情况


下面是一个监听页面静态资源加载情况并显示进度条的Demo。这个Demo会自动监听页面中所有图片、样式表、脚本等静态资源的加载状态，并通过进度条直观展示加载进度。

<iframe height="300" style="width: 100%;" scrolling="no" title="progress-bar-3" src="https://codepen.io/Jeek-Chou/embed/vENZYrW?default-tab=html%2Cresult" frameborder="no" loading="lazy" allowtransparency="true" allowfullscreen="true">
  See the Pen <a href="https://codepen.io/Jeek-Chou/pen/vENZYrW">
  progress-bar-3</a> by Jeek Chou (<a href="https://codepen.io/Jeek-Chou">@Jeek-Chou</a>)
  on <a href="https://codepen.io">CodePen</a>.
</iframe>

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>资源加载进度条SDK</title>
  <script>
    // 资源加载进度条SDK
    (function(window) {
      // 默认配置
      const defaultConfig = {
        color: '#29d',          // 进度条颜色
        height: '3px',          // 进度条高度
        zIndex: 99999,          // 层级
        showDetail: false,      // 是否显示详细信息
        onComplete: null        // 加载完成回调
      };

      class ResourceLoader {
        constructor(config = {}) {
          // 合并配置
          this.config = { ...defaultConfig, ...config };
          
          // 资源统计
          this.totalResources = 0;
          this.loadedResources = 0;
          this.resourceList = [];
          
          // 初始化
          this.init();
        }

        // 初始化
        init() {
          // 创建进度条元素
          this.createProgressBar();
          
          // 收集并监听现有资源
          this.collectExistingResources();
          
          // 监听动态加载的资源
          this.observeDynamicResources();
          
          // 监听页面加载完成事件作为最终保障
          window.addEventListener('load', () => {
            setTimeout(() => {
              this.updateProgress(100);
            }, 100);
          });
        }

        // 创建进度条元素
        createProgressBar() {
          const progressBar = document.createElement('div');
          progressBar.id = 'resource-progress-bar';
          progressBar.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: ${this.config.height};
            background: ${this.config.color};
            z-index: ${this.config.zIndex};
            transition: width 0.3s ease;
          `;
          document.body.appendChild(progressBar);
          this.progressBar = progressBar;

          // 如果需要显示详细信息
          if (this.config.showDetail) {
            const detailInfo = document.createElement('div');
            detailInfo.id = 'resource-loading-detail';
            detailInfo.style.cssText = `
              position: fixed;
              top: 10px;
              left: 10px;
              padding: 5px 10px;
              background: rgba(0,0,0,0.7);
              color: white;
              font-size: 12px;
              border-radius: 3px;
              z-index: ${this.config.zIndex};
            `;
            document.body.appendChild(detailInfo);
            this.detailInfo = detailInfo;
          }
        }

        // 收集现有资源
        collectExistingResources() {
          // 图片资源
          const images = document.getElementsByTagName('img');
          this.addResources(images, 'img');
          
          // 样式表资源
          const stylesheets = document.styleSheets;
          for (let i = 0; i < stylesheets.length; i++) {
            const sheet = stylesheets[i];
            if (sheet.href) {
              this.addResource(sheet.href, 'stylesheet');
            }
          }
          
          // 脚本资源
          const scripts = document.getElementsByTagName('script');
          this.addResources(scripts, 'script', 'src');
          
          // 视频资源
          const videos = document.getElementsByTagName('video');
          this.addResourcesWithSources(videos, 'video');
          
          // 音频资源
          const audios = document.getElementsByTagName('audio');
          this.addResourcesWithSources(audios, 'audio');
          
          // 背景图片资源
          this.collectBackgroundImages();
        }

        // 收集背景图片资源
        collectBackgroundImages() {
          const elements = document.getElementsByTagName('*');
          for (let i = 0; i < elements.length; i++) {
            const element = elements[i];
            const style = window.getComputedStyle(element);
            const bgImage = style.backgroundImage;
            
            if (bgImage && bgImage !== 'none') {
              // 提取背景图片URL
              const urlMatch = bgImage.match(/url\(["']?([^"')]+)["']?\)/);
              if (urlMatch && urlMatch[1]) {
                this.addResource(urlMatch[1], 'background-image');
              }
            }
          }
        }

        // 批量添加资源
        addResources(elements, type, attribute = 'src') {
          for (let i = 0; i < elements.length; i++) {
            const element = elements[i];
            const url = element[attribute];
            if (url) {
              this.addResource(url, type, element);
            }
          }
        }

        // 添加带有source子元素的资源（video/audio）
        addResourcesWithSources(elements, type) {
          for (let i = 0; i < elements.length; i++) {
            const element = elements[i];
            // 处理元素自身的src
            if (element.src) {
              this.addResource(element.src, type, element);
            }
            // 处理source子元素
            const sources = element.getElementsByTagName('source');
            for (let j = 0; j < sources.length; j++) {
              const source = sources[j];
              if (source.src) {
                this.addResource(source.src, type, source);
              }
            }
          }
        }

        // 添加单个资源并监听其加载状态
        addResource(url, type, element) {
          // 去重处理
          if (this.resourceList.some(item => item.url === url)) {
            return;
          }
          
          const resource = {
            url: url,
            type: type,
            loaded: false
          };
          
          this.resourceList.push(resource);
          this.totalResources++;
          
          // 更新详细信息
          this.updateDetailInfo();
          
          // 如果元素已存在，监听其加载事件
          if (element) {
            this.listenToElementLoad(element, resource);
          } else {
            // 对于背景图片等没有直接元素的资源，使用Image对象监听
            this.loadResourceWithImage(url, resource);
          }
        }

        // 监听元素加载
        listenToElementLoad(element, resource) {
          // 如果已经加载完成
          if (element.complete) {
            this.markResourceLoaded(resource);
            return;
          }
          
          // 监听加载完成事件
          const loadHandler = () => {
            this.markResourceLoaded(resource);
            element.removeEventListener('load', loadHandler);
            element.removeEventListener('error', errorHandler);
          };
          
          // 监听加载错误事件（错误也视为已处理）
          const errorHandler = () => {
            this.markResourceLoaded(resource);
            element.removeEventListener('load', loadHandler);
            element.removeEventListener('error', errorHandler);
          };
          
          element.addEventListener('load', loadHandler);
          element.addEventListener('error', errorHandler);
        }

        // 使用Image对象加载资源以监听进度
        loadResourceWithImage(url, resource) {
          const img = new Image();
          img.addEventListener('load', () => {
            this.markResourceLoaded(resource);
          });
          img.addEventListener('error', () => {
            // 错误也视为已处理
            this.markResourceLoaded(resource);
          });
          img.src = url;
        }

        // 标记资源为已加载
        markResourceLoaded(resource) {
          if (!resource.loaded) {
            resource.loaded = true;
            this.loadedResources++;
            this.updateProgress();
            
            // 更新详细信息
            this.updateDetailInfo();
          }
        }

        // 更新进度
        updateProgress(forceProgress) {
          let progress;
          
          if (forceProgress !== undefined) {
            progress = forceProgress;
          } else {
            // 计算进度，确保至少显示1%避免视觉问题
            progress = this.totalResources > 0 
              ? Math.min(100, Math.round((this.loadedResources / this.totalResources) * 100))
              : 0;
          }
          
          // 更新进度条宽度
          this.progressBar.style.width = `${progress}%`;
          
          // 如果进度达到100%，执行完成回调并移除进度条
          if (progress === 100) {
            if (typeof this.config.onComplete === 'function') {
              this.config.onComplete();
            }
            
            // 延迟移除进度条，让用户看到完成状态
            setTimeout(() => {
              this.progressBar.style.opacity = '0';
              setTimeout(() => {
                this.progressBar.remove();
                if (this.detailInfo) {
                  this.detailInfo.remove();
                }
              }, 300);
            }, 500);
          }
        }

        // 更新详细信息显示
        updateDetailInfo() {
          if (this.detailInfo) {
            this.detailInfo.textContent = 
              `加载中: ${this.loadedResources}/${this.totalResources} (${
                this.totalResources > 0 ? Math.round((this.loadedResources / this.totalResources) * 100) : 0
              }%)`;
          }
        }

        // 监听动态加载的资源
        observeDynamicResources() {
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              // 检查新增的节点
              mutation.addedNodes.forEach((node) => {
                if (node.nodeType === 1) { // 元素节点
                  this.checkDynamicElement(node);
                  
                  // 检查子元素
                  const children = node.getElementsByTagName('*');
                  for (let i = 0; i < children.length; i++) {
                    this.checkDynamicElement(children[i]);
                  }
                }
              });
            });
          });
          
          // 监听整个文档的变化
          observer.observe(document, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['src', 'href', 'style']
          });
        }

        // 检查动态添加的元素是否包含资源
        checkDynamicElement(element) {
          const tagName = element.tagName.toLowerCase();
          
          // 处理图片
          if (tagName === 'img' && element.src) {
            this.addResource(element.src, 'img', element);
          }
          
          // 处理脚本
          else if (tagName === 'script' && element.src) {
            this.addResource(element.src, 'script', element);
          }
          
          // 处理样式表
          else if (tagName === 'link' && element.rel === 'stylesheet' && element.href) {
            this.addResource(element.href, 'stylesheet', element);
          }
          
          // 处理视频
          else if (tagName === 'video') {
            if (element.src) {
              this.addResource(element.src, 'video', element);
            }
            const sources = element.getElementsByTagName('source');
            this.addResources(sources, 'video', 'src');
          }
          
          // 处理音频
          else if (tagName === 'audio') {
            if (element.src) {
              this.addResource(element.src, 'audio', element);
            }
            const sources = element.getElementsByTagName('source');
            this.addResources(sources, 'audio', 'src');
          }
          
          // 处理背景图片变化
          else {
            const style = element.getAttribute('style');
            if (style && style.includes('background-image')) {
              this.collectBackgroundImages();
            }
          }
        }
      }

      // 暴露SDK到window对象
      window.ResourceLoader = ResourceLoader;
    })(window);
  </script>
</head>
<body>
  <!-- 页面内容 -->
  <h1>资源加载进度条演示</h1>
  
  <!-- 示例资源 -->
  <img src="https://picsum.photos/800/400?random=1" alt="示例图片1">
  <img src="https://picsum.photos/800/400?random=2" alt="示例图片2">
  <img src="https://picsum.photos/800/400?random=3" alt="示例图片3">
  
  <script>
    // 初始化资源加载进度条
    document.addEventListener('DOMContentLoaded', () => {
      new ResourceLoader({
        color: '#4CAF50',    // 进度条颜色
        height: '4px',       // 进度条高度
        showDetail: true,    // 显示详细信息
        onComplete: () => {
          console.log('所有资源加载完成！');
        }
      });

      // 动态添加资源示例
      setTimeout(() => {
        const img = document.createElement('img');
        img.src = 'https://picsum.photos/800/400?random=4';
        img.alt = '动态加载的图片';
        document.body.appendChild(img);
      }, 1000);
    });
  </script>
</body>
</html>
```

这个Demo的主要功能和特点：

1. 自动监听多种类型的静态资源：
    - 图片（img标签）
    - 脚本（script标签）
    - 样式表（link标签）
    - 视频和音频（video、audio标签及source子标签）
    - 背景图片（通过CSS background-image设置的图片）

2. 支持动态加载的资源：
    - 使用MutationObserver监听DOM变化，捕捉动态添加的资源

3. 可配置的进度条：
    - 颜色、高度、层级等样式可自定义
    - 可显示详细的加载信息
    - 提供加载完成回调

4. 使用方法简单：
    - 引入SDK后，创建ResourceLoader实例即可
    - 可通过配置参数自定义进度条行为和样式

使用时，只需在页面中引入该SDK，然后在DOM加载完成后初始化即可。进度条会自动显示在页面顶部，并随着资源加载进度逐渐增长，完成后自动消失。


## 这个SDK能够监听到样式表中的CSS背景图片和JavaScript脚本引入的第三方资源，具体实现方式如下：

1. **监听样式表中的背景图片**：
    - 通过`collectBackgroundImages()`方法遍历所有元素
    - 使用`window.getComputedStyle(element)`获取计算后的样式
    - 解析`backgroundImage`属性提取图片URL
    - 对提取到的图片URL进行监听

2. **监听JavaScript引入的第三方资源**：
    - 通过`MutationObserver`监听DOM变化，包括动态添加的`<script>`标签
    - 当检测到新的带`src`属性的`<script>`标签时，自动添加到资源列表
    - 对于脚本动态创建的其他资源（如图片、视频等），也能通过DOM变化监测到

3. **特别处理样式表资源**：
    - 直接扫描`document.styleSheets`收集所有样式表资源
    - 对于样式表中通过`@import`引入的其他样式表也能间接监测
    - 样式表中定义的背景图片会被`collectBackgroundImages()`方法捕捉

实际测试时，你会发现无论是：
- CSS中定义的`background-image: url(...)`
- 动态创建的`<script src="第三方库.js">`
- 脚本加载的图片资源

都能被进度条正确统计和显示加载进度。

如果需要更精确地监控某些特定类型的第三方资源，还可以通过扩展`checkDynamicElement`方法来添加自定义的资源检测逻辑。
