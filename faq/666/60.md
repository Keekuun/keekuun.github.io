## 60. å•ç‚¹ç™»å½•æ˜¯æ˜¯ä»€ä¹ˆï¼Œå…·ä½“æµç¨‹æ˜¯ä»€ä¹ˆ

å•ç‚¹ç™»å½•ï¼ˆSingle Sign-On, SSOï¼‰æ˜¯ä¸€ç§èº«ä»½è®¤è¯æœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡**ä¸€æ¬¡ç™»å½•**è®¿é—®å¤šä¸ªç›¸äº’ä¿¡ä»»çš„åº”ç”¨ç³»ç»Ÿã€‚ä»¥ä¸‹æ˜¯æ·±åº¦æŠ€æœ¯è§£æå’Œå®Œæ•´æµç¨‹è¯´æ˜ï¼š

---

### ğŸŒŸ **SSO æ ¸å¿ƒä»·å€¼**
| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **ç”¨æˆ·ä½“éªŒ** | ç”¨æˆ·åªéœ€è®°ä½1å¥—å‡­è¯ï¼Œæ— éœ€é‡å¤ç™»å½• |
| **å®‰å…¨é›†ä¸­** | ç»Ÿä¸€çš„å®‰å…¨ç­–ç•¥å’Œå¯†ç å¼ºåº¦è¦æ±‚ |
| **ç®¡ç†é«˜æ•ˆ** | è´¦å·å¼€é€š/ç¦ç”¨åªéœ€åœ¨SSOå¹³å°æ“ä½œ |
| **é£é™©å¯æ§** | æ‰€æœ‰ç³»ç»Ÿçš„ç™»å½•è¡Œä¸ºå¯é›†ä¸­å®¡è®¡ |

---

### ğŸ”‘ **æ ¸å¿ƒæœ¯è¯­**
| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| **IdP (Identity Provider)** | èº«ä»½è®¤è¯ä¸­å¿ƒï¼ˆå¦‚å…¬å¸SSOæœåŠ¡å™¨ï¼‰ |
| **SP (Service Provider)** | ä¾èµ–IdPçš„æœåŠ¡æä¾›æ–¹ï¼ˆå¦‚å†…éƒ¨ç³»ç»Ÿï¼‰ |
| **Token** | èº«ä»½å‡­è¯ï¼ˆå¦‚JWTã€SAMLæ–­è¨€ï¼‰ |
| **CAS (Central Authentication Service)** | ç»å…¸SSOåè®® |

---

### ğŸ”„ **SSO ä¸»æµåè®®å¯¹æ¯”**
| åè®® | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ | ç¤ºä¾‹ |
|------|----------|------|------|
| **OAuth 2.0** | äº’è”ç½‘åº”ç”¨ | æˆæƒè€Œéè®¤è¯ï¼Œéœ€ç»“åˆOpenID Connect | å¾®ä¿¡ç™»å½• |
| **SAML 2.0** | ä¼ä¸šçº§åº”ç”¨ | XMLæ ¼å¼ï¼Œå®‰å…¨æ€§é«˜ | å…¬å¸ADFSé›†æˆ |
| **CAS** | ä¼ ç»ŸWebç³»ç»Ÿ | ç®€å•é‡å®šå‘æµç¨‹ | å¤§å­¦å›¾ä¹¦é¦†ç³»ç»Ÿ |
| **Kerberos** | å†…ç½‘ç³»ç»Ÿ | æ— éœ€å‰ç«¯å‚ä¸ï¼Œä¾èµ–ç¥¨æ® | WindowsåŸŸè®¤è¯ |

---

### ğŸ“œ **ç»å…¸CASæµç¨‹è¯¦è§£ï¼ˆå«æ—¶åºå›¾ï¼‰**
```mermaid
sequenceDiagram
    participant User
    participant AppA(SP åº”ç”¨A)
    participant SSO(IdP è®¤è¯ä¸­å¿ƒ)
    participant AppB(SP åº”ç”¨B)

    User->>AppA: è®¿é—®app.example.com
    AppA->>User: 302é‡å®šå‘åˆ°SSO
    User->>SSO: æºå¸¦serviceå‚æ•°(https://app.example.com)
    SSO->>User: æ£€æŸ¥æœªç™»å½•â†’æ˜¾ç¤ºç™»å½•é¡µ
    User->>SSO: æäº¤ç”¨æˆ·å/å¯†ç 
    SSO->>User: è®¤è¯æˆåŠŸï¼Œè®¾ç½®SSO Cookie<br>302é‡å®šå‘å›AppAæºå¸¦ticket
    User->>AppA: æäº¤ticket
    AppA->>SSO: åå°éªŒè¯ticketæœ‰æ•ˆæ€§
    SSO->>AppA: è¿”å›ç”¨æˆ·èº«ä»½ä¿¡æ¯
    AppA->>User: è®¾ç½®åº”ç”¨ä¼šè¯Cookieï¼Œæ˜¾ç¤ºå†…å®¹

    User->>AppB: è®¿é—®app2.example.com
    AppB->>User: 302é‡å®šå‘åˆ°SSO
    User->>SSO: æºå¸¦SSO Cookieè‡ªåŠ¨è®¤è¯
    SSO->>User: 302é‡å®šå‘å›AppBæºå¸¦æ–°ticket
    User->>AppB: æäº¤ticket
    AppB->>SSO: éªŒè¯ticket
    SSO->>AppB: è¿”å›ç”¨æˆ·ä¿¡æ¯
    AppB->>User: å»ºç«‹ä¼šè¯ï¼Œæ— éœ€é‡å¤ç™»å½•
```

---

### ğŸ” **å…³é”®å®‰å…¨æªæ–½**
1. **Tokené˜²ç¯¡æ”¹**
    - ä½¿ç”¨JWTæ—¶å¿…åŠ ç­¾åï¼ˆHS256/RS256ï¼‰
    - SAMLæ–­è¨€éœ€XMLæ•°å­—ç­¾å
2. **é€šé“å®‰å…¨**
    - å¼ºåˆ¶HTTPS
    - ç¦ç”¨HTTPé‡å®šå‘
3. **æ—¶æ•ˆæ§åˆ¶**
   ```typescript
   // JWT æœ‰æ•ˆæœŸç¤ºä¾‹
   const token = jwt.sign({
     user: 'admin',
     exp: Math.floor(Date.now() / 1000) + 300 // 5åˆ†é’Ÿè¿‡æœŸ
   }, 'SECRET_KEY')
   ```
4. **CSRFé˜²æŠ¤**
    - ä½¿ç”¨stateå‚æ•°æ ¡éªŒè¯·æ±‚æ¥æº
    - åŒç«™Cookieè®¾ç½®`SameSite=Strict`

---

### ğŸ’» **OAuth 2.0 + OpenID Connect å®ç°SSO**
```typescript
// Express å®ç°OAuth2.0æˆæƒç æµç¨‹
import { AuthorizationCode } from 'simple-oauth2'

const client = new AuthorizationCode({
  client: {
    id: 'CLIENT_ID',
    secret: 'CLIENT_SECRET'
  },
  auth: {
    tokenHost: 'https://sso.example.com',
    authorizePath: '/oauth/authorize',
    tokenPath: '/oauth/token'
  }
})

// ç”Ÿæˆæˆæƒé“¾æ¥
router.get('/login', (req, res) => {
  const authorizationUri = client.authorizeURL({
    redirect_uri: 'https://app.example.com/callback',
    scope: 'openid profile', // OpenID Connect scope
    state: crypto.randomBytes(16).toString('hex')
  })
  res.redirect(authorizationUri)
})

// å¤„ç†å›è°ƒ
router.get('/callback', async (req, res) => {
  const token = await client.getToken({
    code: req.query.code,
    redirect_uri: 'https://app.example.com/callback'
  })
  req.session.ssoToken = token.token.access_token
  res.redirect('/dashboard')
})
```

---

### ğŸ›¡ï¸ **ä¼ä¸šçº§SSOæ¶æ„ç¤ºä¾‹**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘˜å·¥ç»ˆç«¯è®¾å¤‡    â”‚â”€â”€â”€â”€>â”‚ åå‘ä»£ç†å±‚  â”‚â”€â”€â”€â”€>â”‚  SSOè®¤è¯ä¸­å¿ƒ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                                         â†“
       â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â””â”€â”€â”€â”€â”€â”€â”€â”‚ è¯ä¹¦è®¤è¯    â”‚        â”‚  LDAP/ADç›®å½•æœåŠ¡ â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚  MFAæœåŠ¡    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### âš ï¸ **SSOå®æ–½å¸¸è§é—®é¢˜**
1. **CookieåŸŸé™åˆ¶**
    - è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®çˆ¶çº§åŸŸCookie
      `Set-Cookie: sso_token=xyz; Domain=.example.com; Path=/`

2. **è·¨åŸŸé—®é¢˜**
    - ä½¿ç”¨CORSæˆ–JSONPï¼ˆè€æ—§ç³»ç»Ÿï¼‰
    - ç°ä»£æ–¹æ¡ˆï¼šOAuth2.0 + PostMessage

3. **åè®®æ··åˆé£é™©**
    - ç¦æ­¢ï¼šSAML 1.0 + å¼±åŠ å¯†ç®—æ³•
    - æ¨èï¼šSAML 2.0 + AES-256

4. **ä¼šè¯åŒæ­¥ç™»å‡º**
   ```typescript
   // å…¨å±€ç™»å‡ºå®ç°
   router.post('/logout', (req, res) => {
     broadcastLogout(req.user.id) // é€šçŸ¥æ‰€æœ‰SP
     destroySSOSession(req.cookies.sso_token)
     res.clearCookie('sso_token').redirect('/goodbye')
   })
   ```

---

### ğŸ“Š **SSOåè®®é€‰å‹æŒ‡å—**
| åœºæ™¯ | æ¨èåè®® | å·¥å…·é“¾ |
|------|----------|--------|
| æ–°å¼€å‘Webåº”ç”¨ | OAuth2.0 + OIDC | Keycloak/Auth0 |
| ä¼ ç»Ÿä¼ä¸šç³»ç»Ÿé›†æˆ | SAML 2.0 | ADFS/Okta |
| ç§»åŠ¨ç«¯SSO | OAuth2.0 PKCE | AppAuth SDK |
| å†…éƒ¨å¾®æœåŠ¡ | JWT + APIç½‘å…³ | Kong/Ory Hydra |

---

### ğŸ”® **æœªæ¥è¶‹åŠ¿**
1. **æ— å¯†ç è®¤è¯**ï¼šWebAuthnæ ‡å‡†é›†æˆ
2. **åˆ†å¸ƒå¼èº«ä»½**ï¼šDIDï¼ˆDecentralized Identityï¼‰
3. **æŒç»­è®¤è¯**ï¼šè¡Œä¸ºç”Ÿç‰©ç‰¹å¾åˆ†æ