## 120. [ä½ä»£ç ] ä»£ç å¹³å°ä¸€èˆ¬åº•å±‚åè®®æ˜¯æ€ä¹ˆè®¾è®¡çš„

ä½ä»£ç å¹³å°çš„åº•å±‚åè®®è®¾è®¡æ˜¯å…¶æ ¸å¿ƒæ¶æ„çš„å…³é”®éƒ¨åˆ†ï¼Œå†³å®šäº†å¹³å°çš„æ‰©å±•æ€§ã€çµæ´»æ€§å’Œæ€§èƒ½ã€‚ä»¥ä¸‹æ˜¯ä½ä»£ç å¹³å°åº•å±‚åè®®çš„è¯¦ç»†è®¾è®¡æ€è·¯ï¼Œæ¶µç›– **åè®®åˆ†å±‚**ã€**æ•°æ®æ¨¡å‹**ã€**é€šä¿¡æœºåˆ¶** å’Œ **æ‰©å±•æ€§è®¾è®¡** ç­‰æ–¹é¢ï¼Œå¹¶æä¾›å…·ä½“çš„æŠ€æœ¯å®ç°ç¤ºä¾‹ï¼ˆåŸºäº TypeScript å’Œç°ä»£æ¶æ„æ¨¡å¼ï¼‰ã€‚

---

## ğŸŒŸ **æ ¸å¿ƒè®¾è®¡ç›®æ ‡**
1. **æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„æ•°æ®ç»“æ„å’Œäº¤äº’åè®®ã€‚
2. **é«˜æ€§èƒ½**ï¼šæ”¯æŒå¤§è§„æ¨¡ç»„ä»¶å’Œæ•°æ®çš„å®æ—¶æ¸²æŸ“ã€‚
3. **å¯æ‰©å±•**ï¼šå…è®¸æ’ä»¶åŒ–æ‰©å±•åè®®èƒ½åŠ›ã€‚
4. **è·¨å¹³å°**ï¼šåè®®å¯é€‚é… Webã€ç§»åŠ¨ç«¯ã€æ¡Œé¢ç­‰å¤šç«¯æ¸²æŸ“ã€‚

---

## ğŸ›  **åº•å±‚åè®®åˆ†å±‚è®¾è®¡**
```mermaid
graph TD
    A[ç”¨æˆ·æ“ä½œå±‚] -->|ç”Ÿæˆ/ä¿®æ”¹| B[DSL æè¿°å±‚]
    B -->|åºåˆ—åŒ–| C[åè®®ä¼ è¾“å±‚]
    C -->|ååºåˆ—åŒ–| D[å¼•æ“è§£æå±‚]
    D -->|æ¸²æŸ“| E[è¿è¡Œæ—¶å±‚]
```

---

### ğŸ“Œ **1. DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰è®¾è®¡**
#### âœ… **æ ¸å¿ƒæ•°æ®æ¨¡å‹**
```typescript
interface ComponentSchema {
  id: string;                      // å”¯ä¸€æ ‡è¯†
  type: string;                    // ç»„ä»¶ç±»å‹ï¼ˆå¦‚ "button"ï¼‰
  props: Record<string, any>;      // å±æ€§ï¼ˆå¦‚ { text: "æäº¤" }ï¼‰
  children?: ComponentSchema[];    // åµŒå¥—å­ç»„ä»¶
  events?: {                      // äº‹ä»¶ç»‘å®š
    [eventName: string]: {
      action: "navigate" | "api" | "custom";
      payload: any;
    };
  };
  dataBinding?: {                  // æ•°æ®ç»‘å®šè§„åˆ™
    source: string;                // æ•°æ®æºï¼ˆå¦‚ "formData.name"ï¼‰
    transform?: (value: any) => any; // æ•°æ®è½¬æ¢å‡½æ•°
  };
}
```

#### âœ… **åè®®ç¤ºä¾‹ï¼ˆJSONï¼‰**
```json
{
  "type": "page",
  "children": [
    {
      "type": "form",
      "children": [
        {
          "type": "input",
          "props": { "label": "ç”¨æˆ·å", "placeholder": "è¯·è¾“å…¥" },
          "dataBinding": { "source": "formData.username" }
        },
        {
          "type": "button",
          "props": { "text": "æäº¤" },
          "events": {
            "onClick": { "action": "api", "payload": { "url": "/submit" } }
          }
        }
      ]
    }
  ]
}
```

---

### ğŸ“Œ **2. åè®®ä¼ è¾“å±‚è®¾è®¡**
#### âœ… **é€šä¿¡åè®®**
- **WebSocket**ï¼šç”¨äºå®æ—¶åä½œç¼–è¾‘ï¼ˆå¤šäººåŒæ—¶ç¼–è¾‘åŒä¸€é¡µé¢ï¼‰ã€‚
- **RESTful API**ï¼šç”¨äºä¿å­˜/åŠ è½½ Schemaã€‚
- **å¢é‡æ›´æ–°åè®®**ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰ï¼š
  ```typescript
  interface DeltaUpdate {
    op: "add" | "remove" | "update"; // æ“ä½œç±»å‹
    path: string;                    // ç›®æ ‡è·¯å¾„ï¼ˆå¦‚ "children.0.props.text"ï¼‰
    value?: any;                     // æ–°å€¼ï¼ˆop=add/update æ—¶æœ‰æ•ˆï¼‰
  }
  ```

#### âœ… **åºåˆ—åŒ–ä¼˜åŒ–**
- **äºŒè¿›åˆ¶åè®®**ï¼šå¯¹å¤§å‹ Schema ä½¿ç”¨ Protocol Buffers æˆ– MessagePackã€‚
  ```protobuf
  // Protocol Buffers ç¤ºä¾‹
  message Component {
    required string id = 1;
    optional string type = 2;
    map<string, string> props = 3;
  }
  ```

---

### ğŸ“Œ **3. å¼•æ“è§£æå±‚è®¾è®¡**
#### âœ… **æ¸²æŸ“å¼•æ“æ ¸å¿ƒæµç¨‹**
```typescript
class RenderEngine {
  private componentRegistry: Map<string, ComponentDefinition>;

  render(schema: ComponentSchema, parentEl: HTMLElement) {
    const component = this._createComponent(schema);
    parentEl.appendChild(component);
  }

  private _createComponent(schema: ComponentSchema): HTMLElement {
    // 1. æŸ¥æ‰¾ç»„ä»¶å®šä¹‰
    const definition = this.componentRegistry.get(schema.type);
    if (!definition) throw new Error(`Unknown component: ${schema.type}`);

    // 2. åˆ›å»º DOM èŠ‚ç‚¹
    const el = document.createElement(definition.tagName);

    // 3. åº”ç”¨å±æ€§å’Œæ•°æ®ç»‘å®š
    this._applyProps(el, schema.props);
    this._bindData(el, schema.dataBinding);

    // 4. é€’å½’æ¸²æŸ“å­ç»„ä»¶
    schema.children?.forEach(child => this.render(child, el));

    return el;
  }
}
```

---

### ğŸ“Œ **4. è¿è¡Œæ—¶åè®®æ‰©å±•**
#### âœ… **è‡ªå®šä¹‰åŠ¨ä½œåè®®**
```typescript
// æ³¨å†Œè‡ªå®šä¹‰åŠ¨ä½œå¤„ç†å™¨
engine.registerAction("custom", (payload, context) => {
  console.log("æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘", payload);
});

// åœ¨ DSL ä¸­è°ƒç”¨
{
  "events": {
    "onClick": { "action": "custom", "payload": { "foo": "bar" } }
  }
}
```

#### âœ… **æ’ä»¶åŒ–åè®®æ‰©å±•**
```typescript
interface PlatformPlugin {
  name: string;
  components: Record<string, ComponentDefinition>;
  actions?: Record<string, ActionHandler>;
}

// æ³¨å†Œç§»åŠ¨ç«¯æ’ä»¶
engine.use({
  name: "mobile-plugin",
  components: {
    "mobile-button": {
      tagName: "android-button",
      propsMapper: (props) => ({ "android:text": props.text })
    }
  }
});
```

---

## ğŸš€ **æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
### âœ… **1. æ‡’åŠ è½½åè®®**
```typescript
// åŠ¨æ€åŠ è½½ç»„ä»¶å®šä¹‰
engine.registerLazyComponent("data-grid", () => 
  import('./components/DataGrid').then(m => m.definition)
);
```

### âœ… **2. è™šæ‹Ÿ DOM Diff**
```typescript
function applyDelta(oldSchema: ComponentSchema, delta: DeltaUpdate) {
  // ä½¿ç”¨ JSON Patch æˆ–è‡ªå®šä¹‰å·®å¼‚ç®—æ³•
  const newSchema = deepClone(oldSchema);
  lodash.set(newSchema, delta.path, delta.value);
  return newSchema;
}
```

### âœ… **3. åè®®ç¼“å­˜**
```typescript
// å¯¹è§£æåçš„ Schema è¿›è¡Œå“ˆå¸Œç¼“å­˜
const schemaCache = new Map<string, RenderTree>();

function renderWithCache(schema: ComponentSchema) {
  const hash = hashSchema(schema);
  if (!schemaCache.has(hash)) {
    schemaCache.set(hash, engine.compile(schema));
  }
  return schemaCache.get(hash).render();
}
```

---

## ğŸ”§ **æ‰©å±•æ€§è®¾è®¡**
### âœ… **å¤šç«¯æ¸²æŸ“åè®®é€‚é…å™¨**
```typescript
abstract class RenderAdapter {
  abstract renderComponent(schema: ComponentSchema): void;
}

class WebRenderer extends RenderAdapter {
  renderComponent(schema) {
    // ç”Ÿæˆ HTML/CSS
  }
}

class MiniProgramRenderer extends RenderAdapter {
  renderComponent(schema) {
    // ç”Ÿæˆ WXML/WXSS
  }
}
```

### âœ… **DSL åˆ°ä»£ç çš„è½¬æ¢åè®®**
```typescript
interface CodeGenerator {
  generate(schema: ComponentSchema): { code: string; dependencies: string[] };
}

const generators = {
  react: (schema) => ({
    code: `export default () => <Button>${schema.props.text}</Button>`,
    dependencies: ["react"]
  }),
  vue: (schema) => ({
    code: `<template><button>${schema.props.text}</button></template>`,
    dependencies: ["vue"]
  })
};
```

---

## ğŸ›¡ï¸ **ç¨³å®šæ€§ä¿éšœ**
| **æŒ‘æˆ˜**               | **è§£å†³æ–¹æ¡ˆ**                              |
|------------------------|-----------------------------------------|
| åè®®ç‰ˆæœ¬å…¼å®¹æ€§         | è®¾è®¡å¸¦ç‰ˆæœ¬çš„åè®®å¤´ï¼ˆå¦‚ `version: "1.0"`ï¼‰|
| å¾ªç¯å¼•ç”¨               | æ£€æµ‹ Schema ä¸­çš„å¾ªç¯ä¾èµ–å¹¶æŠ¥é”™           |
| å¤§ Schema æ€§èƒ½é—®é¢˜      | åˆ†å—åŠ è½½ + å¢é‡æ›´æ–°                      |

---

## ğŸ“¦ **å®Œæ•´åè®®å·¥ä½œæµç¤ºä¾‹**
1. **è®¾è®¡å™¨ç”Ÿæˆ DSL** â†’ é€šè¿‡ WebSocket å‘é€ Delta æ›´æ–°
2. **æœåŠ¡ç«¯æŒä¹…åŒ–** â†’ å­˜å‚¨ Schema åˆ°æ•°æ®åº“
3. **å®¢æˆ·ç«¯åŠ è½½åè®®** â†’ å¼•æ“è§£æå¹¶æ¸²æŸ“
4. **è¿è¡Œæ—¶äº¤äº’** â†’ è§¦å‘åè®®å®šä¹‰çš„äº‹ä»¶åŠ¨ä½œ

```typescript
// 1. è®¾è®¡å™¨å‘é€å¢é‡æ›´æ–°
ws.send(JSON.stringify({
  op: "update",
  path: "children.0.props.text",
  value: "æ–°æ–‡æœ¬"
}));

// 2. å¼•æ“åº”ç”¨æ›´æ–°
ws.onMessage((delta) => {
  currentSchema = applyDelta(currentSchema, delta);
  engine.rerender(currentSchema);
});
```

---

## ğŸ¯ **åè®®éªŒè¯ Checklist**
1. [ ] åè®®æ˜¯å¦èƒ½å®Œæ•´æè¿° UI å’Œäº¤äº’é€»è¾‘ï¼Ÿ
2. [ ] æ˜¯å¦æ”¯æŒè·¨å¹³å°æ¸²æŸ“ï¼ˆWeb/ç§»åŠ¨ç«¯ï¼‰ï¼Ÿ
3. [ ] å¢é‡æ›´æ–°åè®®æ˜¯å¦ä¼˜åŒ–äº†æ€§èƒ½ï¼Ÿ
4. [ ] æ˜¯å¦æä¾›æ‰©å±•ç‚¹ï¼ˆè‡ªå®šä¹‰ç»„ä»¶/åŠ¨ä½œï¼‰ï¼Ÿ

---

é€šè¿‡ä»¥ä¸Šè®¾è®¡ï¼Œä½ä»£ç å¹³å°çš„åº•å±‚åè®®å¯å®ç°ï¼š
âœ… **é«˜æ•ˆæ¸²æŸ“** - æ”¯æŒä¸‡çº§ç»„ä»¶ç§’çº§åŠ è½½
âœ… **çµæ´»æ‰©å±•** - æ’ä»¶åŒ–å®šåˆ¶åè®®èƒ½åŠ›
âœ… **å¤šç«¯ä¸€è‡´** - ä¸€å¥—åè®®é€‚é… Web/å°ç¨‹åº/æ¡Œé¢ç«¯

é€‚ç”¨äºä¼ä¸šçº§åº”ç”¨æ­å»ºã€å¯è§†åŒ–å¤§å±ç­‰å¤æ‚åœºæ™¯ï¼ ğŸš€