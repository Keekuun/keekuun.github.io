## 115. 页面加载速度提升（性能优化）应该从哪些反向来思考？

提升页面加载速度是前端性能优化的核心目标，需要从 **多维度、全链路** 进行系统性优化。以下是分层次的优化方向和具体策略（附优先级标注 ⭐️）：

---

### 🌟 **1. 网络层优化（减少传输体积和时间）**
#### ✅ **压缩与缓存**
- **Gzip/Brotli 压缩**：减少资源体积（文本文件可压缩 60%~70%）。
  ```nginx
  # Nginx 配置示例
  gzip on;
  gzip_types text/plain application/javascript text/css;
  ```
- **HTTP 缓存**：
    - 强缓存（`Cache-Control: max-age=31536000`）
    - 协商缓存（`ETag`/`Last-Modified`）

#### ✅ **减少请求数量**
- **资源合并**：将小图标合并为雪碧图（Sprite）或使用 SVG 符号。
- **HTTP/2 多路复用**：取代 HTTP/1.1 的队头阻塞。

#### ✅ **CDN 加速**
静态资源（JS/CSS/图片）分发到边缘节点，减少网络延迟。

---

### 🖼️ **2. 资源层优化（关键资源优先）**
#### ✅ **图片优化**
- **格式选择**：
    - `WebP`（比 JPEG/PNG 小 30%~50%）
    - 渐进式 JPEG（用户体验更好）
- **懒加载**：
  ```html
  <img loading="lazy" src="placeholder.jpg" data-src="real-image.jpg" />
  ```

#### ✅ **代码拆分（Code Splitting）**
- **按路由拆分**（React.lazy / Vue 异步组件）：
  ```tsx
  const Home = lazy(() => import('./Home'));
  ```
- **动态导入**：非核心功能（如富文本编辑器）按需加载。

#### ✅ **Preload/Prefetch**
预加载关键资源，预取未来可能需要的资源：
  ```html
  <link rel="preload" href="critical.css" as="style" />
  <link rel="prefetch" href="next-page.js" />
  ```

---

### ⚡ **3. 渲染层优化（加速首屏展示）**
#### ✅ **关键渲染路径（CRP）优化**
- **内联关键 CSS**：避免阻塞渲染。
- **异步非关键 JS**：
  ```html
  <script defer src="non-critical.js"></script>
  ```

#### ✅ **服务端渲染（SSR）**
Next.js/Nuxt.js 等服务端渲染框架，解决白屏问题。

#### ✅ **骨架屏（Skeleton）**
在数据加载前展示占位 UI，提升用户感知速度。

---

### 📦 **4. JavaScript 执行优化**
#### ✅ **减少主线程负担**
- **Web Worker**：将复杂计算（如大数据处理）移至子线程。
- **时间切片（Time Slicing）**：用 `requestIdleCallback` 拆分长任务。

#### ✅ **防抖/节流**
避免频繁事件（如 `scroll`/`resize`）触发重复计算：
  ```ts
  const handleScroll = throttle(() => { /* ... */ }, 200);
  ```

---

### 🔍 **5. 监控与分析**
#### ✅ **性能指标**
- **Lighthouse**：检测综合评分（FCP、TTI、TBT 等）。
- **Web Vitals**：关注核心指标（CLS、FID、LCP）。

#### ✅ **持续优化**
- **Performance API**：
  ```js
  const { loadEventEnd, navigationStart } = performance.timing;
  console.log('页面加载耗时：', loadEventEnd - navigationStart);
  ```
- **日志上报**：统计真实用户性能数据（RUM）。

---

### 🛠 **6. 进阶优化（针对大型项目）**
#### ✅ **预渲染（Prerendering）**
对静态页面提前生成 HTML，适合营销页。

#### ✅ **边缘计算（Edge Computing）**
使用 Cloudflare Workers 等工具在边缘节点处理逻辑。

#### ✅ **PWA 离线缓存**
Service Worker 缓存资源，提升二次访问速度。

---

### 📊 **优化优先级参考**
| **优化方向**       | **具体措施**                  | **优先级** | **预期收益** |
|--------------------|-----------------------------|------------|--------------|
| 网络层优化        | CDN + HTTP/2 + Gzip        | ⭐️⭐️⭐️⭐️⭐️  | 高           |
| 资源加载策略      | 懒加载 + Preload           | ⭐️⭐️⭐️⭐️     | 中高         |
| 渲染优化          | 内联关键 CSS + 骨架屏       | ⭐️⭐️⭐️⭐️     | 中高         |
| JavaScript 优化   | 代码拆分 + Web Worker       | ⭐️⭐️⭐️       | 中           |
| 监控与分析        | Lighthouse + Web Vitals     | ⭐️⭐️⭐️       | 长期收益     |

---

### 🎯 **核心原则**
1. **先测量，后优化**：用工具定位瓶颈（如 Chrome DevTools 的 Performance 面板）。
2. **二八法则**：优先解决影响最大的 20% 问题。
3. **渐进增强**：确保基础功能快速可用，再增强体验。

---

通过以上策略，即使是大型项目也能显著提升加载速度（实测可优化 50%~70%）。性能优化是持续过程，需结合业务场景不断迭代！ 🚀