## 80. vue 中 Scoped styles 是如何实现样式隔离的，原理是啥？

在 Vue 中，**Scoped Styles** 是一种实现组件级样式隔离的机制，它通过自动添加唯一的属性选择器来限定样式的作用范围。以下是其实现原理和细节：

---

## **1. Scoped Styles 的核心原理**
当你在 Vue 单文件组件（SFC）中使用 `<style scoped>` 时，Vue 会通过以下步骤实现样式隔离：

### **(1) 添加唯一属性**
- **编译阶段**：Vue 的编译器（如 `vue-loader`）会为当前组件的 **所有 DOM 元素** 添加一个唯一的 `data-v-xxxx` 属性（`xxxx` 是哈希值）。
  ```html
  <!-- 编译前 -->
  <template>
    <div class="demo">Hello</div>
  </template>

  <!-- 编译后 -->
  <div class="demo" data-v-f3f3eg9>Hello</div>
  ```

### **(2) 重写 CSS 选择器**
- **样式处理**：组件的所有 CSS 选择器会被修改，附加 `[data-v-xxxx]` 属性选择器。
  ```css
  /* 编译前 */
  <style scoped>
  .demo { color: red; }
  </style>

  /* 编译后 */
  .demo[data-v-f3f3eg9] { color: red; }
  ```
  这样样式只会作用于当前组件的 DOM 元素。

---

## **2. 技术实现细节**
### **(1) 哈希生成**
- 每个组件的 `data-v-xxxx` 哈希值是基于 **文件路径** 或 **组件名** 生成的，确保唯一性。
- 例如：`data-v-f3f3eg9`。

### **(2) 深度选择器 (`>>>` 或 `/deep/`)**
如果需要影响子组件的样式，可以使用深度选择器：
```css
/* 编译前 */
<style scoped>
.parent >>> .child { color: blue; }
</style>

/* 编译后 */
.parent[data-v-f3f3eg9] .child { color: blue; }
```
> **注意**：Vue 3 中推荐使用 `:deep()` 替代 `>>>` 或 `/deep/`。

### **(3) 动态内容隔离**
- 通过 `v-html` 插入的内容也会被添加 `data-v-xxxx` 属性，但外部引入的 CSS 不受 Scoped 限制。

---

## **3. 与其他方案的对比**
| **方案**               | **原理**                          | **优点**                     | **缺点**                     |
|------------------------|-----------------------------------|-----------------------------|-----------------------------|
| **Scoped Styles**      | 添加唯一属性选择器                | 轻量、无运行时开销          | 无法完全隔离第三方组件样式  |
| **CSS Modules**        | 生成唯一类名                      | 天然隔离、支持 JS 引用      | 配置复杂                    |
| **Shadow DOM**         | 浏览器原生隔离                    | 完全隔离                    | 兼容性问题、样式穿透困难    |

---

## **4. 源码解析（简化版）**
Vue 的 `vue-loader` 在处理 `<style scoped>` 时，会调用 `@vue/compiler-sfc` 的编译逻辑：
1. **解析模板**：为每个 DOM 节点添加 `data-v-xxxx`。
2. **重写 CSS**：使用 PostCSS 插件（如 `postcss-selector-scope`）修改选择器。
   ```javascript
   // 伪代码示例
   const postcss = require('postcss');
   postcss([scopeSelector]).process(cssContent);
   ```

---

## **5. 注意事项**
- **避免全局样式泄漏**：Scoped 无法隔离全局样式（如 `body` 或第三方库的 CSS）。
- **性能影响**：大量 Scoped 样式会增加 CSS 文件体积（但现代工具会优化）。
- **动态组件**：动态组件的 Scoped 样式会重新生成哈希。

---

## **6. 示例：Scoped 的实际效果**
### **编译前**
```vue
<template>
  <div class="demo">Scoped Style</div>
</template>

<style scoped>
.demo { color: red; }
</style>
```

### **编译后**
```html
<div class="demo" data-v-f3f3eg9>Scoped Style</div>

<style>
.demo[data-v-f3f3eg9] { color: red; }
</style>
```

---

## **7. 总结**
- **核心机制**：通过 `data-v-xxxx` 属性和重写 CSS 选择器实现隔离。
- **适用场景**：组件级样式隔离，避免全局污染。
- **局限性**：无法完全隔离第三方组件，需配合 `:deep()` 或 CSS Modules 使用。

Scoped Styles 是 Vue 生态中简单高效的样式隔离方案，适合大多数业务场景！ 🎨