## 110. å°è£…ä¸€ä¸ªè¯·æ±‚è¶…æ—¶ï¼Œå‘èµ·é‡è¯•çš„ä»£ç 

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå°è£…äº†**è¯·æ±‚è¶…æ—¶**å’Œ**è‡ªåŠ¨é‡è¯•**åŠŸèƒ½çš„ä»£ç ç¤ºä¾‹ï¼Œä½¿ç”¨ TypeScript å’Œ `fetch` API å®ç°ã€‚è¯¥ä»£ç æ”¯æŒè‡ªå®šä¹‰è¶…æ—¶æ—¶é—´ã€é‡è¯•æ¬¡æ•°ä»¥åŠé‡è¯•é—´éš”ï¼Œå¹¶æä¾›äº†è‰¯å¥½çš„ç±»å‹æç¤ºå’Œé”™è¯¯å¤„ç†ã€‚

---

### ğŸ“œ **ä»£ç å®ç°**
```typescript
/**
 * å°è£…å¸¦è¶…æ—¶å’Œé‡è¯•çš„è¯·æ±‚
 * @param url è¯·æ±‚åœ°å€
 * @param options è¯·æ±‚é…ç½®ï¼ˆå¯é€‰ï¼‰
 * @param timeout è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤ 5000msï¼‰
 * @param maxRetries æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 3 æ¬¡ï¼‰
 * @param retryDelay é‡è¯•é—´éš”ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤ 1000msï¼‰
 * @returns å“åº”æ•°æ®
 */
async function fetchWithTimeoutAndRetry<T = any>(
    url: string,
    options?: RequestInit,
    timeout: number = 5000,
    maxRetries: number = 3,
    retryDelay: number = 1000
): Promise<T> {
    let retryCount = 0;
    let lastError: Error | null = null;

    while (retryCount < maxRetries) {
        try {
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            // å‘èµ·è¯·æ±‚ï¼ˆåˆå¹¶ä¿¡å·å’Œé…ç½®ï¼‰
            const response = await fetch(url, {
                ...options,
                signal: controller.signal,
            });

            clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨

            if (!response.ok) {
                throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }

            return await response.json() as T; // è¿”å›è§£æåçš„æ•°æ®
        } catch (error) {
            lastError = error as Error;
            retryCount++;

            if (retryCount >= maxRetries) {
                break; // ä¸å†é‡è¯•
            }

            console.warn(`è¯·æ±‚å¤±è´¥ï¼Œç¬¬ ${retryCount} æ¬¡é‡è¯•...`, error);
            await new Promise(resolve => setTimeout(resolve, retryDelay)); // å»¶è¿Ÿé‡è¯•
        }
    }

    throw new Error(`è¯·æ±‚è¶…æ—¶æˆ–å¤±è´¥ï¼Œé‡è¯• ${maxRetries} æ¬¡åä»æ— æ³•æˆåŠŸ: ${lastError?.message}`);
}

// ç¤ºä¾‹è°ƒç”¨
interface ApiResponse {
    data: {
        id: number;
        name: string;
    };
}

async function main() {
    try {
        const result = await fetchWithTimeoutAndRetry<ApiResponse>(
            'https://api.example.com/data',
            { method: 'GET' },
            3000, // è¶…æ—¶æ—¶é—´
            2,    // é‡è¯•æ¬¡æ•°
            500   // é‡è¯•é—´éš”
        );
        console.log('è¯·æ±‚æˆåŠŸ:', result.data);
    } catch (error) {
        console.error('è¯·æ±‚æœ€ç»ˆå¤±è´¥:', error);
    }
}

main();
```

---

### ğŸ¯ **åŠŸèƒ½è¯´æ˜**
1. **è¶…æ—¶æ§åˆ¶**ï¼š
    - ä½¿ç”¨ `AbortController` å®ç°è¯·æ±‚è¶…æ—¶ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…ã€‚
    - è¶…æ—¶åè‡ªåŠ¨å–æ¶ˆè¯·æ±‚å¹¶æŠ›å‡ºé”™è¯¯ã€‚

2. **è‡ªåŠ¨é‡è¯•**ï¼š
    - æ”¯æŒè‡ªå®šä¹‰é‡è¯•æ¬¡æ•°ï¼ˆ`maxRetries`ï¼‰å’Œé‡è¯•é—´éš”ï¼ˆ`retryDelay`ï¼‰ã€‚
    - æ¯æ¬¡é‡è¯•å‰ä¼šç­‰å¾…æŒ‡å®šçš„é—´éš”æ—¶é—´ã€‚

3. **é”™è¯¯å¤„ç†**ï¼š
    - æ•è·ç½‘ç»œé”™è¯¯ã€è¶…æ—¶é”™è¯¯å’Œ HTTP çŠ¶æ€ç é”™è¯¯ã€‚
    - é‡è¯•æ¬¡æ•°ç”¨å°½åæŠ›å‡ºæœ€ç»ˆé”™è¯¯ã€‚

4. **ç±»å‹å®‰å…¨**ï¼š
    - ä½¿ç”¨æ³›å‹ `T` å®šä¹‰è¿”å›æ•°æ®çš„ç±»å‹ï¼Œæ–¹ä¾¿ TypeScript ç±»å‹æ¨æ–­ã€‚

---

### âš™ï¸ **ä½¿ç”¨åœºæ™¯**
- **ä¸ç¨³å®šçš„ç½‘ç»œç¯å¢ƒ**ï¼šå¦‚ç§»åŠ¨ç«¯æˆ–å¼±ç½‘æ¡ä»¶ä¸‹ï¼Œé€šè¿‡é‡è¯•æé«˜è¯·æ±‚æˆåŠŸç‡ã€‚
- **å…³é”® API è¯·æ±‚**ï¼šéœ€è¦ç¡®ä¿æ•°æ®è·å–æˆåŠŸçš„åœºæ™¯ï¼ˆå¦‚æ”¯ä»˜ã€ç™»å½•ï¼‰ã€‚
- **ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨**ï¼šå¯¹ä¸å¯æ§çš„ç¬¬ä¸‰æ–¹æœåŠ¡å¢åŠ å®¹é”™æœºåˆ¶ã€‚

---

### ğŸ“Š **å‚æ•°è¯´æ˜**
| **å‚æ•°å**    | **ç±»å‹**      | **é»˜è®¤å€¼** | **è¯´æ˜**                     |
|---------------|---------------|------------|-----------------------------|
| `url`         | `string`      | -          | è¯·æ±‚åœ°å€                     |
| `options`     | `RequestInit` | `{}`       | Fetch API çš„è¯·æ±‚é…ç½®         |
| `timeout`     | `number`      | `5000`     | è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰             |
| `maxRetries`  | `number`      | `3`        | æœ€å¤§é‡è¯•æ¬¡æ•°                 |
| `retryDelay`  | `number`      | `1000`     | é‡è¯•é—´éš”ï¼ˆæ¯«ç§’ï¼‰             |

---

### ğŸŒŸ **ä¼˜åŒ–å»ºè®®**
1. **æŒ‡æ•°é€€é¿**ï¼šé‡è¯•é—´éš”å¯ä»¥åŠ¨æ€å¢åŠ ï¼ˆå¦‚ `retryDelay * retryCount`ï¼‰ï¼Œé¿å…é¢‘ç¹é‡è¯•ã€‚
2. **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ¯æ¬¡é‡è¯•çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ã€‚
3. **è‡ªå®šä¹‰é‡è¯•æ¡ä»¶**ï¼šæ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦é‡è¯•ï¼ˆå¦‚ä»…å¯¹è¶…æ—¶æˆ– 5xx é”™è¯¯é‡è¯•ï¼‰ã€‚

---

### ğŸš€ **ç¤ºä¾‹æ‰©å±•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰**
```typescript
async function fetchWithExponentialBackoff<T = any>(
    url: string,
    options?: RequestInit,
    timeout: number = 5000,
    maxRetries: number = 3,
    initialDelay: number = 1000
): Promise<T> {
    let retryCount = 0;
    let delay = initialDelay;

    while (retryCount < maxRetries) {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            const response = await fetch(url, {
                ...options,
                signal: controller.signal,
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }

            return await response.json() as T;
        } catch (error) {
            retryCount++;
            if (retryCount >= maxRetries) {
                throw new Error(`é‡è¯• ${maxRetries} æ¬¡åå¤±è´¥: ${error.message}`);
            }

            console.warn(`ç¬¬ ${retryCount} æ¬¡é‡è¯•ï¼Œç­‰å¾… ${delay}ms...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2; // æŒ‡æ•°é€€é¿
        }
    }

    throw new Error('æœªçŸ¥é”™è¯¯');
}
```

---

é€šè¿‡è¿™ä¸ªå°è£…ï¼Œä½ å¯ä»¥è½»æ¾å®ç°**é«˜å¯é æ€§**çš„ç½‘ç»œè¯·æ±‚ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­çš„å¤æ‚åœºæ™¯ï¼ ğŸ‰