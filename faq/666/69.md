## 69. è™šæ‹Ÿæ»šåŠ¨åŠ è½½åŸç†æ˜¯ä»€ä¹ˆï¼Œç”¨ã€ŒReactã€ä»£ç ç®€å•å®ç°ä¸€ä¸ªè™šæ‹Ÿæ»šåŠ¨åŠ è½½ã€‚

è™šæ‹Ÿæ»šåŠ¨ï¼ˆVirtual Scrollingï¼‰æ˜¯ä¸€ç§ä¼˜åŒ–é•¿åˆ—è¡¨æ¸²æŸ“æ€§èƒ½çš„æŠ€æœ¯ï¼Œé€šè¿‡ **ä»…æ¸²æŸ“å¯è§†åŒºåŸŸå†…çš„å…ƒç´ ** æ¥å‡å°‘ DOM èŠ‚ç‚¹æ•°é‡ï¼Œä»è€Œå¤§å¹…æå‡æ€§èƒ½ã€‚ä»¥ä¸‹æ˜¯å…¶æ ¸å¿ƒåŸç†å’Œå®ç°ï¼š

---

## **1. è™šæ‹Ÿæ»šåŠ¨åŸç†**
### **(1) æ ¸å¿ƒæ€æƒ³**
- **å¯è§†åŒºåŸŸæ¸²æŸ“**ï¼šåªæ¸²æŸ“ç”¨æˆ·å½“å‰å¯è§çš„éƒ¨åˆ†å†…å®¹ã€‚
- **åŠ¨æ€è®¡ç®—ä½ç½®**ï¼šé€šè¿‡æ»šåŠ¨ä½ç½®åŠ¨æ€è®¡ç®—éœ€è¦æ¸²æŸ“çš„èµ·å§‹å’Œç»“æŸç´¢å¼•ã€‚
- **å ä½å®¹å™¨**ï¼šç”¨ç©ºç™½åŒºåŸŸï¼ˆæˆ–å ä½å…ƒç´ ï¼‰æ¨¡æ‹Ÿå®Œæ•´åˆ—è¡¨çš„é«˜åº¦ã€‚

### **(2) å…³é”®æ­¥éª¤**
1. **è®¡ç®—å¯è§†åŒºåŸŸ**ï¼š
    - è·å–å®¹å™¨é«˜åº¦ï¼ˆ`containerHeight`ï¼‰å’Œæ¯ä¸ªé¡¹çš„é«˜åº¦ï¼ˆ`itemHeight`ï¼‰ã€‚
    - è®¡ç®—å¯è§†åŒºåŸŸèƒ½æ˜¾ç¤ºçš„é¡¹æ•°ï¼š`visibleCount = Math.ceil(containerHeight / itemHeight)`ã€‚

2. **åŠ¨æ€æ¸²æŸ“é¡¹**ï¼š
    - æ ¹æ®æ»šåŠ¨ä½ç½®ï¼ˆ`scrollTop`ï¼‰è®¡ç®—èµ·å§‹ç´¢å¼•ï¼š
      `startIndex = Math.floor(scrollTop / itemHeight)`
    - ç»“æŸç´¢å¼•ï¼š`endIndex = startIndex + visibleCount`ã€‚

3. **å ä½åŒºåŸŸ**ï¼š
    - ä¸Šæ–¹å ä½é«˜åº¦ï¼š`startIndex * itemHeight`ã€‚
    - ä¸‹æ–¹å ä½é«˜åº¦ï¼š`(totalCount - endIndex) * itemHeight`ã€‚

---

## **2. ä»£ç å®ç°**
ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„è™šæ‹Ÿæ»šåŠ¨å®ç°ï¼ˆä½¿ç”¨ TypeScript + Reactï¼‰ï¼š

```tsx
import React, { useState, useRef, useEffect } from 'react';

interface VirtualScrollProps {
  itemHeight: number; // æ¯é¡¹é«˜åº¦
  totalCount: number; // æ€»é¡¹æ•°
  renderItem: (index: number) => React.ReactNode; // æ¸²æŸ“å•é¡¹çš„å‡½æ•°
  containerHeight: number; // å®¹å™¨é«˜åº¦
}

const VirtualScroll: React.FC<VirtualScrollProps> = ({
  itemHeight,
  totalCount,
  renderItem,
  containerHeight,
}) => {
  const [startIndex, setStartIndex] = useState(0);
  const containerRef = useRef<HTMLDivElement>(null);

  // è®¡ç®—å¯è§†åŒºåŸŸèƒ½æ˜¾ç¤ºçš„é¡¹æ•°
  const visibleCount = Math.ceil(containerHeight / itemHeight);
  const endIndex = Math.min(startIndex + visibleCount, totalCount - 1);

  // å¤„ç†æ»šåŠ¨äº‹ä»¶
  const handleScroll = () => {
    if (containerRef.current) {
      const { scrollTop } = containerRef.current;
      const newStartIndex = Math.floor(scrollTop / itemHeight);
      setStartIndex(newStartIndex);
    }
  };

  // åˆå§‹åŒ–å®¹å™¨é«˜åº¦
  useEffect(() => {
    if (containerRef.current) {
      containerRef.current.style.height = `${containerHeight}px`;
    }
  }, [containerHeight]);

  return (
    <div
      ref={containerRef}
      style={{
        overflowY: 'auto',
        border: '1px solid #ccc',
        position: 'relative',
      }}
      onScroll={handleScroll}
    >
      {/* ä¸Šæ–¹å ä½åŒºåŸŸ */}
      <div style={{ height: `${startIndex * itemHeight}px` }}></div>

      {/* æ¸²æŸ“å¯è§†åŒºåŸŸå†…çš„é¡¹ */}
      {Array.from({ length: endIndex - startIndex + 1 }).map((_, index) => {
        const itemIndex = startIndex + index;
        return (
          <div key={itemIndex} style={{ height: `${itemHeight}px` }}>
            {renderItem(itemIndex)}
          </div>
        );
      })}

      {/* ä¸‹æ–¹å ä½åŒºåŸŸ */}
      <div
        style={{
          height: `${(totalCount - endIndex - 1) * itemHeight}px`,
        }}
      ></div>
    </div>
  );
};

// ä½¿ç”¨ç¤ºä¾‹
const App: React.FC = () => {
  const items = Array.from({ length: 10000 }, (_, i) => `Item ${i + 1}`);

  return (
    <VirtualScroll
      itemHeight={50}
      totalCount={items.length}
      containerHeight={500}
      renderItem={(index) => <div>{items[index]}</div>}
    />
  );
};

export default App;
```

---

## **3. å…³é”®ç‚¹è§£æ**
1. **æ€§èƒ½ä¼˜åŒ–**ï¼š
    - æ— è®ºåˆ—è¡¨å¤šé•¿ï¼Œå®é™…æ¸²æŸ“çš„ DOM èŠ‚ç‚¹æ•°ä»…ä¸º `visibleCount + 2`ï¼ˆå ä½åŒºåŸŸï¼‰ã€‚
    - æ»šåŠ¨æ—¶åªæ›´æ–° `startIndex`ï¼Œè§¦å‘å±€éƒ¨é‡æ–°æ¸²æŸ“ã€‚

2. **åŠ¨æ€é«˜åº¦æ”¯æŒ**ï¼š
    - å¦‚æœé¡¹é«˜åº¦ä¸å›ºå®šï¼Œéœ€å…ˆè®¡ç®—å¹¶ç¼“å­˜æ‰€æœ‰é¡¹çš„é«˜åº¦ï¼ˆå¤æ‚å®ç°éœ€ç”¨ `ResizeObserver`ï¼‰ã€‚

3. **æ‰©å±•åŠŸèƒ½**ï¼š
    - **æ»šåŠ¨ç¼“å†²**ï¼šå¯æå‰æ¸²æŸ“éƒ¨åˆ†é¢å¤–é¡¹ï¼ˆå¦‚ `startIndex - 5` åˆ° `endIndex + 5`ï¼‰ï¼Œé¿å…å¿«é€Ÿæ»šåŠ¨æ—¶ç©ºç™½ã€‚
    - **å¼‚æ­¥åŠ è½½**ï¼šç»“åˆåˆ†é¡µåŠ è½½æ•°æ®ï¼ˆå¦‚æ»šåŠ¨åˆ°åº•éƒ¨æ—¶åŠ è½½æ›´å¤šï¼‰ã€‚

---

## **4. å¯¹æ¯”ä¼ ç»Ÿæ»šåŠ¨**
| **ç‰¹æ€§**         | **ä¼ ç»Ÿæ»šåŠ¨**               | **è™šæ‹Ÿæ»šåŠ¨**               |
|------------------|---------------------------|---------------------------|
| **DOM èŠ‚ç‚¹æ•°**   | å…¨éƒ¨æ¸²æŸ“ï¼ˆæ€§èƒ½å·®ï¼‰         | ä»…æ¸²æŸ“å¯è§†åŒºåŸŸï¼ˆæ€§èƒ½ä¼˜ï¼‰   |
| **å†…å­˜å ç”¨**     | é«˜                        | ä½                        |
| **é€‚ç”¨åœºæ™¯**     | å°‘é‡æ•°æ®                  | é•¿åˆ—è¡¨ï¼ˆå¦‚è¡¨æ ¼ã€èŠå¤©è®°å½•ï¼‰ |

---

## **5. ç°æœ‰åº“æ¨è**
- **React**ï¼š`react-window`ã€`react-virtualized`ã€‚
- **Vue**ï¼š`vue-virtual-scroller`ã€‚
- **åŸç”Ÿ JS**ï¼š`IntersectionObserver` å®ç°åŠ¨æ€æ¸²æŸ“ã€‚

---

é€šè¿‡è™šæ‹Ÿæ»šåŠ¨ï¼Œå³ä½¿æ˜¯ç™¾ä¸‡çº§æ•°æ®çš„åˆ—è¡¨ä¹Ÿèƒ½æµç•…æ¸²æŸ“ï¼ ğŸš€