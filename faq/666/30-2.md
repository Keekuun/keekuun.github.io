## 使用同一个链接，如何实现 PC 打开是 web 应用、手机打开是一个 H5 应用？ —— 淘宝实现原理分析

> 探索：当访问 https://www.taobao.com/的时候如果检测到时pc端不会跳转，但是当检测是移动端的时候刷新页面就会跳转到https://main.m.taobao.com/， 反之亦然，具体是怎么实现的呢？

淘宝实现PC端与移动端自动跳转的核心逻辑是**设备类型检测**，通过识别访问设备是PC还是移动设备，然后引导至对应的站点。具体实现主要依赖以下技术手段：

### 1. 核心依据：User-Agent（用户代理）识别
浏览器或应用在发送网络请求时，会在HTTP请求头中携带`User-Agent`（简称UA）字符串，该字符串包含了设备类型、操作系统、浏览器等信息。例如：
- **PC端UA**（如Windows电脑Chrome浏览器）：  
  `Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36`
- **移动端UA**（如iPhone Safari）：  
  `Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1`

通过解析UA中的关键词（如`Mobile`、`Android`、`iPhone`标识移动端；`Windows`、`Macintosh`标识PC端），即可判断设备类型。


### 2. 实现方式：服务器端+客户端协同检测
淘宝作为大型网站，通常会结合**服务器端检测**和**客户端检测**，确保跳转准确且高效。

#### （1）服务器端检测（主要方式）
服务器在接收请求时，先解析UA，直接通过302重定向跳转到对应站点，减少客户端加载冗余内容。  

以Nginx服务器为例，核心配置逻辑类似：
```nginx
# 检测移动端UA，跳转到m.taobao.com
if ($http_user_agent ~* (mobile|android|iphone|ipad|ipod|windows phone)) {
    rewrite ^(.*)$ https://main.m.taobao.com/$1 permanent;
}

# 检测PC端UA访问移动端站点时，跳转到PC端
server {
    listen 80;
    server_name main.m.taobao.com;
    if ($http_user_agent ~* (windows|macintosh|linux x86)) {
        rewrite ^(.*)$ https://www.taobao.com/$1 permanent;
    }
}
```
- 逻辑：若检测到移动端UA访问`www.taobao.com`，直接跳转到`main.m.taobao.com`；若PC端UA访问移动端站点，则跳转回PC端。
- 优势：跳转在请求初期完成，效率高，减少无效资源加载。


#### （2）客户端JavaScript检测（补充方式）
如果服务器端检测未覆盖所有场景（如UA异常、代理等），会在页面中嵌入JavaScript代码进行二次检测，确保跳转准确性。示例逻辑：
```javascript
// 检测是否为移动端设备
function isMobile() {
    const ua = navigator.userAgent.toLowerCase();
    // 匹配常见移动端UA关键词
    return /mobile|android|iphone|ipad|ipod|windows phone/.test(ua);
}

// 检测是否为PC端设备
function isPC() {
    const ua = navigator.userAgent.toLowerCase();
    // 匹配常见PC端UA关键词（排除移动端）
    return /windows|macintosh|linux x86/.test(ua) && !isMobile();
}

// 执行跳转逻辑
if (window.location.host === 'www.taobao.com' && isMobile()) {
    // PC站检测到移动端，跳转到移动站
    window.location.href = 'https://main.m.taobao.com' + window.location.pathname;
} else if (window.location.host === 'main.m.taobao.com' && isPC()) {
    // 移动站检测到PC端，跳转到PC站
    window.location.href = 'https://www.taobao.com' + window.location.pathname;
}
```
- 逻辑：通过`navigator.userAgent`获取UA，判断设备类型后，使用`window.location.href`强制跳转。
- 优势：覆盖服务器端漏检的边缘场景，确保最终展示正确版本。


### 3. 双向跳转逻辑
淘宝的跳转是“双向”的：
- 移动端设备访问`www.taobao.com` → 跳转到`main.m.taobao.com`
- PC端设备访问`main.m.taobao.com` → 跳转到`www.taobao.com`

核心是通过**“当前域名+设备类型”的组合判断**：如果当前域名与设备类型不匹配，则跳转到对应域名。


### 总结
淘宝的设备检测跳转本质是：**通过解析User-Agent识别设备类型，再结合服务器端302重定向和客户端JavaScript强制跳转，实现PC/移动端站点的自动匹配**。这种方式兼顾了效率（服务器端优先）和准确性（客户端补充），是行业内主流的多端适配方案。
