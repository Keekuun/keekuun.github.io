## 122. IndexedDB å­˜å‚¨ç©ºé—´å¤§å°æ˜¯å¦‚ä½•çº¦æŸçš„ï¼Ÿ

IndexedDB çš„å­˜å‚¨ç©ºé—´å¤§å°çº¦æŸæ¶‰åŠ **æµè§ˆå™¨ç­–ç•¥**ã€**ç”¨æˆ·æˆæƒ** å’Œ **å­˜å‚¨æœºåˆ¶** ç­‰å¤šä¸ªç»´åº¦ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£æå’ŒæŠ€æœ¯å®è·µå»ºè®®ï¼ˆåŸºäºæœ€æ–°æµè§ˆå™¨è§„èŒƒå’Œå®é™…æµ‹è¯•æ•°æ®ï¼‰ï¼š

---

## ğŸŒŸ **æ ¸å¿ƒçº¦æŸå› ç´ **
| **å› ç´ **               | **å…¸å‹å€¼/è§„åˆ™**                          | **å¤‡æ³¨**                          |
|------------------------|----------------------------------------|-----------------------------------|
| **æµè§ˆå™¨é»˜è®¤é™åˆ¶**     | 50% ç£ç›˜å‰©ä½™ç©ºé—´ï¼ˆChromeï¼‰             | åŠ¨æ€è°ƒæ•´ï¼Œæ— å›ºå®šä¸Šé™              |
| **å•åŸŸåé™åˆ¶**         | 60% æµè§ˆå™¨å…¨å±€é…é¢ï¼ˆçº¦ 80% ç£ç›˜å‰©ä½™ç©ºé—´ï¼‰| ä¸åŒæµè§ˆå™¨å®ç°ä¸åŒ                |
| **ç”¨æˆ·æˆæƒæœºåˆ¶**       | è¶…è¿‡é˜ˆå€¼éœ€ç”¨æˆ·ç¡®è®¤                     | ç±»ä¼¼ Notification æƒé™å¼¹çª—       |
| **ä¸´æ—¶å­˜å‚¨ vs æŒä¹…å­˜å‚¨**| ä¸´æ—¶å­˜å‚¨å¯è¢«è‡ªåŠ¨æ¸…ç†ï¼ŒæŒä¹…å­˜å‚¨éœ€æ˜¾å¼ç”³è¯· | é€šè¿‡ `storage.persist()` ç”³è¯·     |

---

## ğŸ›  **è¯¦ç»†çº¦æŸè§„åˆ™**
### ğŸ“Œ **1. æµè§ˆå™¨å…¨å±€é…é¢**
- **Chrome/Edge**
    - æ€»é…é¢ = ç£ç›˜å‰©ä½™ç©ºé—´çš„ 50%
    - å•åŸŸåé»˜è®¤ä¸Šé™ = æ€»é…é¢çš„ 60%ï¼ˆä¾‹å¦‚ç£ç›˜å‰©ä½™ 100GB â†’ å•åŸŸåæœ€å¤š 30GBï¼‰
    - **å®é™…æµ‹è¯•**ï¼šåœ¨ 256GB SSD è®¾å¤‡ä¸Šï¼Œå•åŸŸåå¯ç”¨çº¦ 20GBï¼ˆåŠ¨æ€è°ƒæ•´ï¼‰

- **Firefox**
    - å›ºå®šå•åŸŸåé™åˆ¶ä¸º **2GB**ï¼ˆéœ€ç”¨æˆ·æˆæƒçªç ´ï¼‰

- **Safari**
    - é»˜è®¤ **1GB**ï¼Œè¶…è¿‡åå¼¹çª—ç”³è¯·

---

### ğŸ“Œ **2. ç”¨æˆ·æˆæƒæµç¨‹**
#### âœ… **ä¸´æ—¶å­˜å‚¨ï¼ˆæ— éœ€æˆæƒï¼‰**
- åˆå§‹ä½¿ç”¨æ—¶è‡ªåŠ¨åˆ†é…ç©ºé—´ï¼ˆé€šå¸¸ä¸ºå‡  MB åˆ°å‡ ç™¾ MBï¼‰
- å¯èƒ½è¢«æµè§ˆå™¨è‡ªåŠ¨æ¸…ç†ï¼ˆå¦‚ç£ç›˜ç©ºé—´ä¸è¶³æ—¶ï¼‰

#### âœ… **æŒä¹…å­˜å‚¨ï¼ˆéœ€æ˜¾å¼æˆæƒï¼‰**
```typescript
// ç”³è¯·æŒä¹…åŒ–å­˜å‚¨ï¼ˆè¿”å› Promise<boolean>ï¼‰
async function requestPersistence() {
  if (navigator.storage && navigator.storage.persist) {
    const isPersisted = await navigator.storage.persist();
    console.log(`æŒä¹…åŒ–å­˜å‚¨æˆæƒ: ${isPersisted ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
    return isPersisted;
  }
  return false;
}
```
**ç”¨æˆ·è§¦å‘æ¡ä»¶**ï¼š
- å­˜å‚¨è¶…è¿‡åˆå§‹é˜ˆå€¼ï¼ˆChrome çº¦ä¸º 50MBï¼‰
- è°ƒç”¨ `persist()` æ—¶å¯èƒ½ç›´æ¥å¼¹çª—

---

### ğŸ“Œ **3. æŸ¥è¯¢é…é¢å’Œä½¿ç”¨é‡**
```typescript
// è·å–å½“å‰åŸŸåå¯ç”¨é…é¢å’Œå·²ç”¨é‡
async function checkStorageQuota() {
  if (navigator.storage && navigator.storage.estimate) {
    const { quota, usage } = await navigator.storage.estimate();
    console.log(`é…é¢: ${(quota / 1024 / 1024).toFixed(2)}MB`);
    console.log(`å·²ç”¨: ${(usage / 1024 / 1024).toFixed(2)}MB`);
    return { quota, usage };
  }
  return { quota: 0, usage: 0 };
}
```
**è¾“å‡ºç¤ºä¾‹**ï¼š
```bash
é…é¢: 5120.00MB  # 5GB
å·²ç”¨: 243.76MB   # 243MB
```

---

## ğŸš€ **ä¼˜åŒ–ä¸æœ€ä½³å®è·µ**
### âœ… **1. ç›‘æ§å­˜å‚¨çŠ¶æ€**
```typescript
// ç›‘å¬å­˜å‚¨å‹åŠ›äº‹ä»¶ï¼ˆæµè§ˆå™¨å¯èƒ½æ¸…ç†æ•°æ®æ—¶è§¦å‘ï¼‰
navigator.storage.addEventListener('quotachange', () => {
  console.warn('å­˜å‚¨é…é¢å³å°†è€—å°½ï¼Œå»ºè®®æ¸…ç†æ•°æ®');
});
```

### âœ… **2. æ¸…ç†ç­–ç•¥**
```typescript
// æ ¹æ® LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰æ¸…ç†æ—§æ•°æ®
function cleanupOldData(dbName: string, maxAge: number) {
  const request = indexedDB.open(dbName);
  request.onsuccess = (event) => {
    const db = event.target.result;
    const tx = db.transaction('yourStore', 'readwrite');
    const store = tx.objectStore('yourStore');
    const cutoff = Date.now() - maxAge;

    store.openCursor().onsuccess = (e) => {
      const cursor = e.target.result;
      if (cursor && cursor.value.timestamp < cutoff) {
        store.delete(cursor.primaryKey);
      }
      cursor?.continue();
    };
  };
}
```

### âœ… **3. é”™è¯¯å¤„ç†**
```typescript
// æ•è·ç©ºé—´ä¸è¶³é”™è¯¯
const request = indexedDB.open('largeDB', { version: 1 });
request.onerror = (event) => {
  if (event.target.error.name === 'QuotaExceededError') {
    alert('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†æ•°æ®æˆ–ç”³è¯·æ›´å¤šç©ºé—´');
  }
};
```

---

## ğŸ›¡ï¸ **å…¼å®¹æ€§æ³¨æ„äº‹é¡¹**
| **æµè§ˆå™¨**       | **å…³é”®å·®å¼‚**                              |
|------------------|-----------------------------------------|
| Chrome/Edge      | åŠ¨æ€é…é¢ï¼Œæ”¯æŒ `storage.estimate()`      |
| Firefox          | å›ºå®š 2GB é™åˆ¶ï¼Œéœ€æ—©æœŸç‰ˆæœ¬ polyfill       |
| Safari           | ä¸¥æ ¼é™åˆ¶ï¼Œç§æœ‰æ¨¡å¼ç¦ç”¨ IndexedDB          |

---

## ğŸ“¦ **å®Œæ•´ç¤ºä¾‹ï¼šå­˜å‚¨ç®¡ç†å·¥å…·ç±»**
```typescript
class StorageManager {
  private dbName: string;

  constructor(dbName: string) {
    this.dbName = dbName;
  }

  async ensurePersistent(): Promise<boolean> {
    if (!navigator.storage?.persist) return false;
    return await navigator.storage.persist();
  }

  async getQuota(): Promise<{ quota: number; usage: number }> {
    if (!navigator.storage?.estimate) return { quota: 0, usage: 0 };
    return await navigator.storage.estimate();
  }

  async cleanupOldData(maxAgeMs: number): Promise<void> {
    // å®ç°å‚è€ƒä¸Šæ–‡ LRU æ¸…ç†é€»è¾‘
  }
}

// ä½¿ç”¨
const manager = new StorageManager('myDB');
await manager.ensurePersistent();
const { quota } = await manager.getQuota();
```

---

## ğŸ¯ **å…³é”®å†³ç­–ç‚¹**
1. **æ˜¯å¦éœ€è¦æŒä¹…åŒ–ï¼Ÿ**
    - æ˜¯ â†’ è°ƒç”¨ `storage.persist()` å¹¶å¼•å¯¼ç”¨æˆ·æˆæƒ
    - å¦ â†’ æ¥å—ä¸´æ—¶å­˜å‚¨å¯èƒ½è¢«æ¸…ç†

2. **æ•°æ®æ•æ„Ÿæ€§**
    - é‡è¦æ•°æ® â†’ å®ç°å®šæœŸå¤‡ä»½åˆ°æœåŠ¡å™¨
    - ç¼“å­˜æ•°æ® â†’ è®¾ç½®è‡ªåŠ¨æ¸…ç†ç­–ç•¥

3. **ç›®æ ‡ç”¨æˆ·è®¾å¤‡**
    - ç§»åŠ¨ç«¯ â†’ è°¨æ…ä½¿ç”¨ï¼ˆSafari/ä½ç«¯æœºé™åˆ¶ä¸¥æ ¼ï¼‰
    - æ¡Œé¢ç«¯ â†’ å¯ç”³è¯·æ›´å¤§ç©ºé—´

---

é€šè¿‡åˆç†è®¾è®¡ï¼ŒIndexedDB å¯æ”¯æŒ **GB çº§** ç»“æ„åŒ–æ•°æ®å­˜å‚¨ï¼Œé€‚ç”¨äºç¦»çº¿åº”ç”¨ã€å¤§å‹æ•°æ®é›†ç¼“å­˜ç­‰åœºæ™¯ï¼ ğŸš€