## 118. åœ¨å‰ç«¯åº”ç”¨å¦‚ä½•è¿›è¡Œæƒé™è®¾è®¡ï¼Ÿ

åœ¨å‰ç«¯åº”ç”¨ä¸­è®¾è®¡æƒé™ç³»ç»Ÿæ˜¯ç¡®ä¿åº”ç”¨å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒçš„å…³é”®ã€‚æƒé™è®¾è®¡éœ€è¦ç»“åˆ **è·¯ç”±æ§åˆ¶**ã€**UI å±•ç¤º**ã€**API æ‹¦æˆª** ç­‰å¤šä¸ªç»´åº¦ï¼ŒåŒæ—¶è€ƒè™‘ **åŠ¨æ€æƒé™** å’Œ **é™æ€æƒé™** çš„éœ€æ±‚ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„è®¾è®¡æ€è·¯å’Œå®ç°æ–¹æ¡ˆï¼ˆåŸºäº TypeScript å’Œç°ä»£å‰ç«¯æ¡†æ¶ï¼‰ï¼š

---

## ğŸŒŸ **æ ¸å¿ƒè®¾è®¡ç›®æ ‡**
1. **å®‰å…¨æ€§**ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®æ•æ„ŸåŠŸèƒ½æˆ–æ•°æ®ã€‚
2. **çµæ´»æ€§**ï¼šæ”¯æŒåŠ¨æ€æƒé™é…ç½®ï¼ˆå¦‚ RBAC æ¨¡å‹ï¼‰ã€‚
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæ— æƒé™æ—¶å‹å¥½æç¤ºæˆ–éšè—åŠŸèƒ½ã€‚
4. **å¯ç»´æŠ¤æ€§**ï¼šæƒé™é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•ã€‚

---

## ğŸ›  **æƒé™è®¾è®¡æ–¹æ¡ˆ**
### ğŸ“Œ **1. æƒé™æ¨¡å‹é€‰æ‹©**
#### âœ… **RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰**
```mermaid
graph TD
    A[ç”¨æˆ·] --> B[è§’è‰²]
    B --> C[æƒé™]
    C --> D[èœå•/æŒ‰é’®/API]
```
- **è§’è‰²**ï¼šå¦‚ `admin`ã€`editor`ã€`guest`ã€‚
- **æƒé™**ï¼šå¦‚ `user:delete`ã€`dashboard:view`ã€‚

#### âœ… **ABACï¼ˆåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼‰**
- æ›´ç»†ç²’åº¦ï¼ˆå¦‚é™åˆ¶ `éƒ¨é—¨=è´¢åŠ¡` çš„ç”¨æˆ·è®¿é—®è´¢åŠ¡æ•°æ®ï¼‰ã€‚

---

### ğŸ“Œ **2. å‰ç«¯æƒé™æ§åˆ¶å®ç°**
#### âœ… **è·¯ç”±çº§æƒé™**
**æ–¹æ¡ˆ**ï¼šåŠ¨æ€ç”Ÿæˆè·¯ç”±è¡¨ï¼ˆæ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤æ— æ•ˆè·¯ç”±ï¼‰ã€‚
```typescript
// è·¯ç”±é…ç½®ç¤ºä¾‹
const routes = [
  { path: '/dashboard', component: Dashboard, meta: { requiredPermission: 'dashboard:view' } },
  { path: '/admin', component: Admin, meta: { roles: ['admin'] } },
];

// åŠ¨æ€è¿‡æ»¤è·¯ç”±
function filterRoutes(userPermissions: string[]) {
  return routes.filter(route => {
    return !route.meta?.requiredPermission || 
           userPermissions.includes(route.meta.requiredPermission);
  });
}
```

#### âœ… **ç»„ä»¶/æŒ‰é’®çº§æƒé™**
**æ–¹æ¡ˆ**ï¼šè‡ªå®šä¹‰æŒ‡ä»¤æˆ–é«˜é˜¶ç»„ä»¶ã€‚
```vue
<!-- Vue è‡ªå®šä¹‰æŒ‡ä»¤ç¤ºä¾‹ -->
<template>
  <button v-permission="'user:delete'">åˆ é™¤ç”¨æˆ·</button>
</template>

<script>
// æ³¨å†ŒæŒ‡ä»¤
app.directive('permission', {
  mounted(el, binding) {
    if (!checkPermission(binding.value)) {
      el.remove();
    }
  },
});
</script>
```

#### âœ… **API çº§æƒé™**
**æ–¹æ¡ˆ**ï¼šè¯·æ±‚æ‹¦æˆªå™¨ + ç»Ÿä¸€é”™è¯¯å¤„ç†ã€‚
```typescript
axios.interceptors.response.use(
  response => response,
  error => {
    if (error.response.status === 403) {
      showToast('æ— æƒé™æ“ä½œ');
    }
    return Promise.reject(error);
  }
);
```

---

### ğŸ“Œ **3. æƒé™æ•°æ®ç®¡ç†**
#### âœ… **é™æ€æƒé™ï¼ˆå‰ç«¯é…ç½®ï¼‰**
```typescript
// permissions.ts
export const PERMISSIONS = {
  VIEW_DASHBOARD: 'dashboard:view',
  DELETE_USER: 'user:delete',
} as const;
```

#### âœ… **åŠ¨æ€æƒé™ï¼ˆåç«¯è¿”å›ï¼‰**
**æ¥å£ç¤ºä¾‹**ï¼š
```json
{
  "roles": ["editor"],
  "permissions": ["dashboard:view", "post:edit"]
}
```

**å­˜å‚¨æ–¹æ¡ˆ**ï¼š
- **Pinia/Vuex**ï¼šå…¨å±€çŠ¶æ€ç®¡ç†ã€‚
- **LocalStorage**ï¼šæŒä¹…åŒ–ï¼ˆéœ€åŠ å¯†æ•æ„Ÿå­—æ®µï¼‰ã€‚

---

### ğŸ“Œ **4. åŠ¨æ€èœå•ç”Ÿæˆ**
**æ–¹æ¡ˆ**ï¼šæ ¹æ®æƒé™è¿‡æ»¤èœå•é¡¹ã€‚
```typescript
// åŸå§‹èœå•é…ç½®
const menus = [
  { name: 'Dashboard', path: '/dashboard', permission: 'dashboard:view' },
  { name: 'ç”¨æˆ·ç®¡ç†', path: '/users', permission: 'user:manage' },
];

// è¿‡æ»¤åçš„èœå•
const visibleMenus = menus.filter(menu => 
  !menu.permission || userPermissions.includes(menu.permission)
);
```

---

## ğŸš€ **å…³é”®ä¼˜åŒ–ç‚¹**
### âœ… **æ€§èƒ½ä¼˜åŒ–**
- **æŒ‰éœ€åŠ è½½æƒé™æ¨¡å—**ï¼š
  ```typescript
  const AdminPage = () => import('@/views/AdminPage.vue');
  ```

### âœ… **å®‰å…¨æ€§å¢å¼º**
- **Token è¿‡æœŸå¤„ç†**ï¼š
  ```typescript
  axios.interceptors.response.use(null, error => {
    if (error.response.status === 401) {
      logoutAndRedirectToLogin();
    }
  });
  ```
- **æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯**ï¼šå¦‚æ”¯ä»˜å‰è¦æ±‚è¾“å…¥å¯†ç ã€‚

### âœ… **ç”¨æˆ·ä½“éªŒ**
- **æ— æƒé™æç¤º**ï¼š
  ```vue
  <template>
    <Teleport to="#permission-toast">
      <Toast v-if="showPermissionDenied" />
    </Teleport>
  </template>
  ```

---

## ğŸ›¡ï¸ **é˜²å¾¡æ€§è®¾è®¡**
| **æ”»å‡»ç±»å‹**   | **é˜²å¾¡æªæ–½**                                  |
|----------------|---------------------------------------------|
| **è¶Šæƒè®¿é—®**   | åç«¯å¿…é¡»æ ¡éªŒæƒé™ï¼ˆå‰ç«¯æƒé™ä»…ç”¨äºå±•ç¤ºä¼˜åŒ–ï¼‰    |
| **XSS**        | é¿å…åŠ¨æ€æ¸²æŸ“æƒé™æ•°æ®ï¼ˆå¦‚ `v-html`ï¼‰          |
| **æ•°æ®æ³„éœ²**   | æœ¬åœ°å­˜å‚¨åŠ å¯†ï¼ˆå¦‚ `CryptoJS`ï¼‰                |

---

## ğŸ“¦ **å®Œæ•´å®ç°ç¤ºä¾‹ï¼ˆVue3 + TypeScriptï¼‰**
```typescript
// permission.ts
export function checkPermission(required: string, userPermissions: string[]) {
  return userPermissions.includes(required);
}

// main.ts
app.directive('permission', {
  mounted(el, binding) {
    const { value, instance } = binding;
    const userPermissions = instance?.$store.state.user.permissions || [];
    if (!checkPermission(value, userPermissions)) {
      el.style.display = 'none';
    }
  },
});

// è·¯ç”±å®ˆå«
router.beforeEach((to, from, next) => {
  const requiredRole = to.meta.role;
  if (requiredRole && !user.roles.includes(requiredRole)) {
    next('/403'); // æ— æƒé™é¡µé¢
  } else {
    next();
  }
});
```

---

## ğŸ“Š **æƒé™ç³»ç»ŸéªŒè¯**
1. **å•å…ƒæµ‹è¯•**ï¼šè¦†ç›– `checkPermission` ç­‰æ ¸å¿ƒå‡½æ•°ã€‚
2. **E2E æµ‹è¯•**ï¼šæ¨¡æ‹Ÿä¸åŒè§’è‰²ç”¨æˆ·æ“ä½œæµç¨‹ï¼ˆå¦‚ Cypressï¼‰ã€‚
3. **ç›‘æ§**ï¼šè®°å½•æƒé™å¼‚å¸¸äº‹ä»¶ï¼ˆå¦‚é¢‘ç¹ 403 é”™è¯¯ï¼‰ã€‚

---

## ğŸ¯ **è®¾è®¡åŸåˆ™æ€»ç»“**
1. **æœ€å°æƒé™åŸåˆ™**ï¼šç”¨æˆ·ä»…æ‹¥æœ‰å¿…è¦æƒé™ã€‚
2. **å‰åç«¯åˆ†ç¦»æ ¡éªŒ**ï¼šå‰ç«¯ä¼˜åŒ–ä½“éªŒï¼Œåç«¯ä¿è¯å®‰å…¨ã€‚
3. **ç°åº¦å‘å¸ƒ**ï¼šæ–°æƒé™é€æ­¥å¼€æ”¾ã€‚

---

é€šè¿‡ä»¥ä¸Šè®¾è®¡ï¼Œä½ çš„å‰ç«¯æƒé™ç³»ç»Ÿå°†å…·å¤‡ï¼š
âœ… **é«˜å®‰å…¨æ€§** - ç»“åˆåç«¯æ ¡éªŒæœç»è¶Šæƒ
âœ… **é«˜çµæ´»æ€§** - æ”¯æŒ RBAC/ABAC åŠ¨æ€é…ç½®
âœ… **ä¼˜é›…é™çº§** - æ— æƒé™æ—¶è‡ªç„¶éšè—è€ŒéæŠ¥é”™

é€‚ç”¨äºä¸­åå°ç³»ç»Ÿã€SaaS å¹³å°ç­‰å¤æ‚åœºæ™¯ï¼ ğŸš€