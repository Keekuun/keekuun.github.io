## 48. web 应用中如何对静态资源加载失败的场景做降级处理

# Web应用静态资源加载失败降级方案

## 一、基础降级策略

### 1. 资源监听与错误处理
```typescript
// 通用资源加载错误监听
function setupResourceErrorHandling() {
  // 全局捕获资源加载错误
  window.addEventListener('error', (event) => {
    if (event.target && RESOURCE_TAGS.includes(event.target.tagName)) {
      handleFailedResource(event.target as HTMLElement);
      event.preventDefault(); // 阻止向上冒泡
    }
  }, true);
}

// 处理不同类型资源失败
function handleFailedResource(element: HTMLElement) {
  switch (element.tagName) {
    case 'IMG':
      handleImageFallback(element as HTMLImageElement);
      break;
    case 'SCRIPT':
      handleScriptFallback(element as HTMLScriptElement);
      break;
    case 'LINK':
      handleStyleFallback(element as HTMLLinkElement);
      break;
    case 'IFRAME':
      handleIframeFallback(element as HTMLIFrameElement);
      break;
  }
}
```

### 2. 图片资源降级方案
```typescript
// 多级图片降级策略
function handleImageFallback(img: HTMLImageElement) {
  // 1. 尝试备用源
  if (img.dataset.fallbackSrc) {
    img.src = img.dataset.fallbackSrc;
    return;
  }

  // 2. 使用Base64占位图
  if (img.dataset.placeholder) {
    img.src = img.dataset.placeholder;
    return;
  }

  // 3. 显示SVG替代内容
  if (img.dataset.svgPlaceholder) {
    img.outerHTML = decodeURIComponent(img.dataset.svgPlaceholder);
    return;
  }

  // 4. 最终CSS降级
  img.classList.add('image-failed');
}
```

## 二、关键资源降级实现

### 1. CSS样式表降级
```typescript
// 样式加载失败处理
function handleStyleFallback(link: HTMLLinkElement) {
  // 1. 尝试备用CDN
  if (link.dataset.fallbackHref) {
    link.href = link.dataset.fallbackHref;
    return;
  }

  // 2. 加载内联关键CSS
  if (link.dataset.criticalCss) {
    const style = document.createElement('style');
    style.textContent = link.dataset.criticalCss;
    document.head.appendChild(style);
    link.remove();
  
    // 异步加载非关键CSS
    loadNonCriticalCSS();
    return;
  }

  // 3. 使用系统默认样式
  document.documentElement.classList.add('css-failed');
}

// 异步加载非关键CSS
function loadNonCriticalCSS() {
  const link = document.createElement('link');
  link.rel = 'stylesheet';
  link.href = '/css/non-critical.css';
  link.onerror = () => {
    document.documentElement.classList.add('basic-styles-only');
  };
  document.head.appendChild(link);
}
```

### 2. JavaScript脚本降级
```typescript
// 脚本加载失败处理
function handleScriptFallback(script: HTMLScriptElement) {
  // 1. 重试机制
  if (Number(script.dataset.retry || 0) < MAX_RETRY) {
    const newScript = document.createElement('script');
    newScript.src = script.src;
    newScript.dataset.retry = String(Number(script.dataset.retry || 0) + 1);
    script.parentNode?.replaceChild(newScript, script);
    return;
  }

  // 2. 备用源切换
  if (script.dataset.fallbackSrc) {
    loadScript(script.dataset.fallbackSrc);
    return;
  }

  // 3. 核心功能降级
  if (script.dataset.critical) {
    showErrorModal('核心功能加载失败，部分功能不可用');
    document.documentElement.classList.add('script-failed');
  }
}

// 动态加载脚本
function loadScript(src: string, attributes: Record<string, string> = {}) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    Object.entries(attributes).forEach(([key, value]) => {
      script.setAttribute(key, value);
    });
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}
```

## 三、高级降级技术

### 1. 资源预加载与缓存策略
```typescript
// 使用Service Worker缓存降级资源
const CACHE_NAME = 'fallback-v1';
const FALLBACK_URLS = [
  '/fallback/style.css',
  '/fallback/main.js',
  '/fallback/logo.png'
];

// 安装阶段缓存降级资源
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(FALLBACK_URLS))
  );
});

// 拦截请求返回降级内容
self.addEventListener('fetch', (event) => {
  event.respondWith(
    fetch(event.request).catch(() => {
      // 根据请求类型返回不同降级内容
      if (event.request.url.endsWith('.css')) {
        return caches.match('/fallback/style.css');
      }
      if (event.request.url.endsWith('.js')) {
        return caches.match('/fallback/main.js');
      }
      if (event.request.url.endsWith('.png')) {
        return caches.match('/fallback/logo.png');
      }
      return Response.error();
    })
  );
});
```

### 2. 异步组件降级方案
```typescript
// Vue异步组件降级处理
const AsyncComponent = defineAsyncComponent({
  loader: () => import('./AdvancedComponent.vue'),
  loadingComponent: LoadingSpinner,
  errorComponent: {
    template: `
      <div class="component-fallback">
        <h3>组件加载失败</h3>
        <button @click="retry">重试</button>
        <div v-if="showBasic" class="basic-version">
          <!-- 基础功能实现 -->
        </div>
      </div>
    `,
    methods: {
      retry() {
        this.$emit('retry');
      }
    }
  },
  delay: 200,
  timeout: 5000
});

// React Suspense降级处理
function FallbackComponent({ error, resetErrorBoundary }) {
  return (
    <div className="component-error">
      <h3>组件加载出错</h3>
      <pre>{error.message}</pre>
      <button onClick={resetErrorBoundary}>重试</button>
      <BasicComponent />
    </div>
  );
}

<ErrorBoundary FallbackComponent={FallbackComponent}>
  <Suspense fallback={<Loader />}>
    <AsyncComponent />
  </Suspense>
</ErrorBoundary>
```

## 四、监控与统计系统

### 1. 资源失败监控
```typescript
// 资源加载监控系统
class ResourceMonitor {
  private failures = new Map<string, number>();

  constructor() {
    this.setupReporting();
    setInterval(() => this.reportFailures(), 30000);
  }

  trackFailure(url: string) {
    const count = this.failures.get(url) || 0;
    this.failures.set(url, count + 1);
  }

  private setupReporting() {
    window.addEventListener('error', (event) => {
      if (event.target instanceof HTMLElement) {
        const src = (event.target as any).src || (event.target as any).href;
        if (src) {
          this.trackFailure(src);
        }
      }
    }, true);
  }

  private reportFailures() {
    if (this.failures.size > 0) {
      navigator.sendBeacon('/api/resource-errors', {
        timestamp: Date.now(),
        failures: Array.from(this.failures.entries())
      });
      this.failures.clear();
    }
  }
}

new ResourceMonitor();
```

### 2. 用户体验降级
```typescript
// 渐进式降级管理系统
class GracefulDegradation {
  private failureCount = 0;
  private maxFailures = 3;

  constructor() {
    this.initPerformanceObserver();
  }

  private initPerformanceObserver() {
    const observer = new PerformanceObserver((list) => {
      const entries = list.getEntriesByType('resource');
      entries.forEach(entry => {
        if (entry.duration > 5000) { // 5秒超时
          this.recordSlowResource(entry.name);
        }
      });
    });
    observer.observe({ entryTypes: ['resource'] });
  }

  private recordSlowResource(url: string) {
    this.failureCount++;
  
    if (this.failureCount >= this.maxFailures) {
      this.activateFallbackMode();
    }
  }

  private activateFallbackMode() {
    document.documentElement.classList.add('lite-mode');
  
    // 禁用非核心功能
    disableNonCriticalFeatures();
  
    // 切换到简化版资源
    switchToLiteResources();
  
    // 通知用户
    showDegradationNotice();
  }
}
```

## 五、最佳实践总结

### 1. 多级降级策略表
| 降级级别 | 触发条件 | 处理方式 | 用户体验影响 |
|---------|---------|---------|-------------|
| 1级 | 首次加载失败 | 自动重试/备用源 | 几乎无感知 |
| 2级 | 多次重试失败 | 使用本地缓存/简化版 | 轻微延迟 |
| 3级 | 关键资源失败 | 显示基础功能/占位符 | 功能受限 |
| 4级 | 完全加载失败 | 静态HTML备用页 | 仅基础浏览 |

### 2. 关键实现要点

1. **资源预加载检测**：
```typescript
// 预加载关键资源并检测可用性
function preloadAndCheckResources() {
  const resources = [
    { url: '/css/main.css', type: 'style' },
    { url: '/js/main.js', type: 'script' }
  ];

  resources.forEach(res => {
    const link = document.createElement('link');
    link.rel = res.type === 'style' ? 'preload' : 'prefetch';
    link.as = res.type;
    link.href = res.url;
    link.onerror = () => markResourceAsUnavailable(res.url);
    document.head.appendChild(link);
  });
}
```

2. **智能降级决策**：
```typescript
// 基于网络状况的降级
function networkAwareDegradation() {
  const connection = (navigator as any).connection;

  if (connection) {
    if (connection.effectiveType === 'slow-2g') {
      activateLiteMode();
    }
  
    connection.addEventListener('change', () => {
      if (connection.effectiveType.includes('2g')) {
        throttleNonCriticalRequests();
      }
    });
  }
}
```

3. **优雅降级UI**：
```typescript
// 资源失败时的UI反馈
function showResourceError(element: HTMLElement) {
  const wrapper = document.createElement('div');
  wrapper.className = 'resource-error';

  if (element.tagName === 'IMG') {
    wrapper.innerHTML = `
      <svg class="broken-image" viewBox="0 0 100 100">
        <path d="M20,20 L80,80 M80,20 L20,80" />
      </svg>
      <div class="error-message">图片加载失败</div>
    `;
  }

  element.parentNode?.replaceChild(wrapper, element);
}
```

通过实施这些降级策略，可以确保即使在资源加载失败的情况下，Web应用仍能提供可用的基础功能和良好的用户体验。关键在于：
1. 建立完善的错误监控机制
2. 设计多层次的降级方案
3. 保持核心功能的独立可用性
4. 提供清晰的用户反馈
5. 实现自动化降级决策
