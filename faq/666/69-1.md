## 69. è™šæ‹Ÿæ»šåŠ¨åŠ¨æ€é«˜åº¦

åœ¨è™šæ‹Ÿæ»šåŠ¨ä¸­ï¼Œå¦‚æœ **`itemHeight` ä¸ç¡®å®š**ï¼ˆå³æ¯ä¸ªåˆ—è¡¨é¡¹çš„é«˜åº¦åŠ¨æ€å˜åŒ–ï¼‰ï¼Œä¼ ç»Ÿçš„å›ºå®šé«˜åº¦è®¡ç®—æ–¹å¼ä¼šå¤±æ•ˆã€‚ä»¥ä¸‹æ˜¯è§£å†³æ–¹æ¡ˆå’Œå®ç°æ€è·¯ï¼š

---

## **1. æ ¸å¿ƒé—®é¢˜**
- **ä¼ ç»Ÿè™šæ‹Ÿæ»šåŠ¨**ï¼šä¾èµ–å›ºå®šçš„ `itemHeight` è®¡ç®—å¯è§†åŒºåŸŸå’Œæ»šåŠ¨ä½ç½®ã€‚
- **åŠ¨æ€é«˜åº¦**ï¼šæ¯ä¸ªé¡¹çš„é«˜åº¦å¯èƒ½ä¸åŒï¼ˆå¦‚æ–‡æœ¬æ¢è¡Œã€å›¾ç‰‡åŠ è½½ç­‰ï¼‰ï¼Œå¯¼è‡´æ— æ³•é¢„å…ˆè®¡ç®—æ»šåŠ¨åç§»é‡ã€‚

---

## **2. è§£å†³æ–¹æ¡ˆ**
### **(1) åŠ¨æ€æµ‹é‡ + ä½ç½®ç¼“å­˜**
- **æ­¥éª¤**ï¼š
    1. **é¦–æ¬¡æ¸²æŸ“æ—¶æµ‹é‡**ï¼šæ¸²æŸ“æ¯ä¸€é¡¹å¹¶è®°å½•å®é™…é«˜åº¦ã€‚
    2. **ç¼“å­˜ä½ç½®**ï¼šæ ¹æ®æµ‹é‡ç»“æœè®¡ç®—æ¯ä¸ªé¡¹çš„èµ·å§‹ä½ç½®ï¼ˆ`startOffset`ï¼‰å’Œç»“æŸä½ç½®ï¼ˆ`endOffset`ï¼‰ã€‚
    3. **æ»šåŠ¨æ—¶æŸ¥è¯¢ç¼“å­˜**ï¼šé€šè¿‡äºŒåˆ†æŸ¥æ‰¾å¿«é€Ÿå®šä½å¯è§†åŒºåŸŸçš„é¡¹ã€‚

- **ä¼˜ç‚¹**ï¼šç²¾ç¡®æ§åˆ¶æ»šåŠ¨è¡Œä¸ºã€‚
- **ç¼ºç‚¹**ï¼šé¦–æ¬¡æ¸²æŸ“éœ€æµ‹é‡æ‰€æœ‰é¡¹ï¼ˆæ€§èƒ½å¼€é”€å¤§ï¼‰ã€‚

### **(2) é¢„ä¼°é«˜åº¦ + åŠ¨æ€è°ƒæ•´**
- **æ­¥éª¤**ï¼š
    1. **åˆå§‹ä½¿ç”¨é¢„ä¼°é«˜åº¦**ï¼šå‡è®¾æ‰€æœ‰é¡¹é«˜åº¦ä¸º `estimatedHeight`ã€‚
    2. **æ»šåŠ¨æ—¶åŠ¨æ€è°ƒæ•´**ï¼šå½“é¡¹è¿›å…¥å¯è§†åŒºåŸŸæ—¶ï¼Œæµ‹é‡å®é™…é«˜åº¦å¹¶æ›´æ–°ç¼“å­˜ã€‚
    3. **ä¿®æ­£æ»šåŠ¨ä½ç½®**ï¼šæ ¹æ®å®é™…é«˜åº¦è°ƒæ•´åç»­é¡¹çš„åç§»é‡ã€‚

- **ä¼˜ç‚¹**ï¼šé¿å…é¦–æ¬¡å…¨é‡æµ‹é‡ã€‚
- **ç¼ºç‚¹**ï¼šå¿«é€Ÿæ»šåŠ¨æ—¶å¯èƒ½å‡ºç°çŸ­æš‚è·³åŠ¨ã€‚

### **(3) ä½¿ç”¨ç°æœ‰åº“**
- **æ¨èåº“**ï¼š
    - `react-window`ï¼ˆ`VariableSizeList` ç»„ä»¶ï¼‰ã€‚
    - `react-virtualized`ï¼ˆ`CellMeasurer` ç»„ä»¶ï¼‰ã€‚
    - `@tanstack/react-virtual`ï¼ˆåŠ¨æ€é«˜åº¦æ”¯æŒï¼‰ã€‚

---

## **3. ä»£ç å®ç°ï¼ˆåŠ¨æ€æµ‹é‡ + ç¼“å­˜ï¼‰**
ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„åŠ¨æ€é«˜åº¦è™šæ‹Ÿæ»šåŠ¨å®ç°ï¼ˆReact + TypeScriptï¼‰ï¼š

```tsx
import React, { useState, useRef, useEffect } from 'react';

interface DynamicVirtualScrollProps {
  data: any[]; // æ•°æ®æº
  estimatedItemHeight: number; // é¢„ä¼°é«˜åº¦
  renderItem: (item: any, index: number) => React.ReactNode; // æ¸²æŸ“å‡½æ•°
  containerHeight: number; // å®¹å™¨é«˜åº¦
}

const DynamicVirtualScroll: React.FC<DynamicVirtualScrollProps> = ({
  data,
  estimatedItemHeight,
  renderItem,
  containerHeight,
}) => {
  const [positions, setPositions] = useState<{ offset: number; height: number }[]>([]);
  const [visibleRange, setVisibleRange] = useState({ start: 0, end: 0 });
  const containerRef = useRef<HTMLDivElement>(null);

  // åˆå§‹åŒ–ä½ç½®ç¼“å­˜ï¼ˆåŸºäºé¢„ä¼°é«˜åº¦ï¼‰
  useEffect(() => {
    const initialPositions = data.map((_, index) => ({
      offset: index * estimatedItemHeight,
      height: estimatedItemHeight,
    }));
    setPositions(initialPositions);
  }, [data, estimatedItemHeight]);

  // åŠ¨æ€æµ‹é‡å®é™…é«˜åº¦å¹¶æ›´æ–°ç¼“å­˜
  const updateItemHeight = (index: number, height: number) => {
    if (positions[index].height === height) return;

    setPositions(prev => {
      const newPositions = [...prev];
      newPositions[index] = { ...newPositions[index], height };

      // ä¿®æ­£åç»­é¡¹çš„åç§»é‡
      for (let i = index + 1; i < newPositions.length; i++) {
        newPositions[i].offset = newPositions[i - 1].offset + newPositions[i - 1].height;
      }

      return newPositions;
    });
  };

  // è®¡ç®—å¯è§†åŒºåŸŸ
  const calculateVisibleRange = () => {
    if (!containerRef.current) return;

    const { scrollTop } = containerRef.current;
    const startIndex = findNearestIndex(scrollTop);
    const endIndex = findNearestIndex(scrollTop + containerHeight);

    setVisibleRange({ start: startIndex, end: endIndex });
  };

  // äºŒåˆ†æŸ¥æ‰¾æœ€è¿‘çš„é¡¹
  const findNearestIndex = (offset: number) => {
    let low = 0;
    let high = positions.length - 1;

    while (low <= high) {
      const mid = Math.floor((low + high) / 2);
      const midOffset = positions[mid].offset;

      if (midOffset === offset) return mid;
      else if (midOffset < offset) low = mid + 1;
      else high = mid - 1;
    }

    return low;
  };

  // å¤„ç†æ»šåŠ¨äº‹ä»¶
  const handleScroll = () => {
    calculateVisibleRange();
  };

  // åˆå§‹åŒ–å®¹å™¨é«˜åº¦å’Œå¯è§†åŒºåŸŸ
  useEffect(() => {
    if (containerRef.current) {
      containerRef.current.style.height = `${containerHeight}px`;
      calculateVisibleRange();
    }
  }, [containerHeight]);

  return (
    <div
      ref={containerRef}
      style={{ overflowY: 'auto', border: '1px solid #ccc', position: 'relative' }}
      onScroll={handleScroll}
    >
      {/* ä¸Šæ–¹å ä½åŒºåŸŸ */}
      <div style={{ height: `${positions[visibleRange.start]?.offset || 0}px` }}></div>

      {/* æ¸²æŸ“å¯è§†åŒºåŸŸå†…çš„é¡¹ */}
      {data.slice(visibleRange.start, visibleRange.end + 1).map((item, index) => {
        const realIndex = visibleRange.start + index;
        return (
          <div
            key={realIndex}
            ref={node => {
              if (node) {
                const height = node.getBoundingClientRect().height;
                updateItemHeight(realIndex, height);
              }
            }}
          >
            {renderItem(item, realIndex)}
          </div>
        );
      })}

      {/* ä¸‹æ–¹å ä½åŒºåŸŸ */}
      <div
        style={{
          height: `${
            positions[positions.length - 1]?.offset +
            positions[positions.length - 1]?.height -
            positions[visibleRange.end]?.offset
          }px`
        }}
      ></div>
    </div>
  );
};

// ä½¿ç”¨ç¤ºä¾‹
const App: React.FC = () => {
  const data = Array.from({ length: 1000 }, (_, i) => ({
    id: i,
    content: `Item ${i} - ${'Lorem ipsum '.repeat(Math.random() * 10)}`, // åŠ¨æ€å†…å®¹
  }));

  return (
    <DynamicVirtualScroll
      data={data}
      estimatedItemHeight={50}
      containerHeight={500}
      renderItem={(item) => <div style={{ padding: '10px' }}>{item.content}</div>}
    />
  );
};

export default App;
```

---

## **4. å…³é”®ä¼˜åŒ–ç‚¹**
1. **æƒ°æ€§æµ‹é‡**ï¼šä»…åœ¨é¡¹è¿›å…¥å¯è§†åŒºåŸŸæ—¶æµ‹é‡å®é™…é«˜åº¦ã€‚
2. **äºŒåˆ†æŸ¥æ‰¾**ï¼šå¿«é€Ÿå®šä½æ»šåŠ¨ä½ç½®å¯¹åº”çš„é¡¹ã€‚
3. **åç§»é‡ä¿®æ­£**ï¼šåŠ¨æ€æ›´æ–°ç¼“å­˜åï¼Œç«‹å³ä¿®æ­£åç»­é¡¹çš„ä½ç½®ã€‚

---

## **5. ç°æœ‰åº“çš„è§£å†³æ–¹æ¡ˆ**
### **(1) react-window (VariableSizeList)**
```tsx
import { VariableSizeList } from 'react-window';

const rowHeights = new Array(1000).fill(true).map(() => 50 + Math.random() * 100);

const Row = ({ index, style }: { index: number; style: React.CSSProperties }) => (
  <div style={style}>Row {index}</div>
);

const App = () => (
  <VariableSizeList
    height={500}
    itemCount={1000}
    itemSize={index => rowHeights[index]} // åŠ¨æ€é«˜åº¦å‡½æ•°
    width="100%"
  >
    {Row}
  </VariableSizeList>
);
```

### **(2) @tanstack/react-virtual**
```tsx
import { useVirtualizer } from '@tanstack/react-virtual';

const parentRef = useRef<HTMLDivElement>(null);
const virtualizer = useVirtualizer({
  count: 1000,
  getScrollElement: () => parentRef.current,
  estimateSize: () => 50, // é¢„ä¼°é«˜åº¦
});

// æ¸²æŸ“é€»è¾‘ç±»ä¼¼ react-window
```

---

## **6. æ€»ç»“**
- **åŠ¨æ€é«˜åº¦è™šæ‹Ÿæ»šåŠ¨çš„æ ¸å¿ƒ**ï¼š
    - æµ‹é‡å®é™…é«˜åº¦ + ç»´æŠ¤ä½ç½®ç¼“å­˜ã€‚
    - å¿«é€ŸæŸ¥æ‰¾ + åŠ¨æ€è°ƒæ•´åç§»é‡ã€‚
- **æ¨èä½¿ç”¨æˆç†Ÿåº“**ï¼šå¦‚ `react-window` æˆ– `@tanstack/react-virtual`ï¼Œé¿å…é‡å¤é€ è½®å­ã€‚

é€šè¿‡åˆç†çš„è®¾è®¡ï¼Œå³ä½¿æ˜¯ä¸å®šé«˜çš„è™šæ‹Ÿæ»šåŠ¨ä¹Ÿèƒ½å®ç°æµç•…ä½“éªŒï¼ ğŸš€