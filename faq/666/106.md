## 106. 单点登录是如何实现的？

单点登录（Single Sign-On，简称 SSO）是一种用户身份认证机制，允许用户通过**一次登录**即可访问多个相关但独立的系统或服务，而无需重复输入用户名和密码。SSO 的核心目标是提升用户体验和安全性。

---

### 🔑 SSO 的实现原理
SSO 的实现通常基于以下两种技术：
1. **基于 Cookie 的 SSO**（适用于同一域名下的子域）。
2. **基于令牌的 SSO**（如 OAuth2.0、SAML、OpenID Connect）。

---

### 🌟 常见的 SSO 实现方式

#### 1. **基于 Cookie 的 SSO**
- **适用场景**：同一顶级域名下的多个子域（如 `app1.example.com` 和 `app2.example.com`）。
- **实现步骤**：
    1. 用户登录后，认证服务器在顶级域名（如 `.example.com`）下设置一个共享的 Cookie。
    2. 用户在访问其他子域时，浏览器会自动携带该 Cookie，实现自动登录。

#### 2. **基于 OAuth2.0 的 SSO**
- **适用场景**：跨域或跨平台的系统（如使用 Google 账号登录第三方应用）。
- **实现步骤**：
    1. 用户通过授权服务器（如 Google）登录。
    2. 授权服务器颁发访问令牌（Access Token）。
    3. 第三方应用使用令牌验证用户身份，实现登录。

#### 3. **基于 SAML 的 SSO**
- **适用场景**：企业级应用（如公司内部系统）。
- **实现步骤**：
    1. 用户访问服务提供者（SP），SP 生成 SAML 请求并重定向用户到身份提供者（IdP）。
    2. 用户在 IdP 登录后，IdP 生成 SAML 响应并返回给 SP。
    3. SP 验证 SAML 响应，完成登录。

#### 4. **基于 OpenID Connect 的 SSO**
- **适用场景**：现代 Web 和移动应用（如使用微信登录）。
- **实现步骤**：
    1. 用户通过 OpenID Provider（OP）登录。
    2. OP 返回 ID Token（JWT 格式）和 Access Token。
    3. 应用验证 ID Token，实现登录。

---

### 📜 代码示例（基于 OAuth2.0 的 SSO）
以下是一个简单的 TypeScript 示例，展示如何使用 OAuth2.0 实现 SSO：

```typescript
import axios from 'axios';

// 1. 用户被重定向到授权服务器登录
const authorizeUrl = 'https://auth.example.com/authorize';
const clientId = 'your-client-id';
const redirectUri = 'https://your-app.com/callback';
const scope = 'openid profile'; // OpenID Connect 的 Scope

const authUrl = `${authorizeUrl}?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}&response_type=code`;

console.log(`请访问以下链接登录: ${authUrl}`);

// 2. 获取授权码后交换令牌
const authorizationCode = 'received-code-from-callback';

const tokenUrl = 'https://auth.example.com/token';
const clientSecret = 'your-client-secret';

axios.post(tokenUrl, {
    grant_type: 'authorization_code',
    code: authorizationCode,
    redirect_uri: redirectUri,
    client_id: clientId,
    client_secret: clientSecret,
}).then((response) => {
    const accessToken = response.data.access_token;
    const idToken = response.data.id_token; // OpenID Connect 的 ID Token

    console.log(`访问令牌: ${accessToken}`);
    console.log(`ID Token: ${idToken}`);

    // 3. 验证 ID Token（JWT）
    // 通常使用库如 `jsonwebtoken` 验证签名和有效期
    const decodedToken = decodeJWT(idToken); // 假设的 JWT 解码函数
    console.log('用户信息:', decodedToken);
});
```

---

### ⚠️ 注意事项
1. **安全性**：
    - 使用 HTTPS 传输敏感数据。
    - 验证令牌的签名和有效期。
2. **用户体验**：
    - 提供清晰的登录和登出流程。
3. **兼容性**：
    - 不同系统可能需要不同的 SSO 协议（如 SAML 或 OAuth2.0）。

---

### 🚀 优势
- **减少密码疲劳**：用户只需记住一个密码。
- **提升安全性**：集中管理身份认证，降低密码泄露风险。
- **简化管理**：管理员可以统一控制用户权限。

SSO 是现代企业和互联网服务中不可或缺的一部分，能够显著提升用户体验和安全性！ 🌈