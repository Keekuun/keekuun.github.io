## 5. å¦‚ä½•åœ¨åˆ’è¯é€‰æ‹©çš„æ–‡æœ¬ä¸Šæ·»åŠ å³é”®èœå•ï¼ˆåˆ’è¯ï¼šé¼ æ ‡æ»‘åŠ¨é€‰æ‹©ä¸€ç»„å­—ç¬¦ï¼Œå¯¹ç»„å­—ç¬¦è¿›è¡Œæ“ä½œï¼‰

å®ç°åˆ’è¯é€‰æ‹©æ–‡æœ¬åè§¦å‘å³é”®èœå•çš„åŠŸèƒ½ï¼Œéœ€è¦ç»¼åˆå¤„ç† **æ–‡æœ¬é€‰æ‹©ç›‘å¬**ã€**å³é”®èœå•å®šä½** å’Œ **è‡ªå®šä¹‰æ“ä½œé€»è¾‘**ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´å®ç°æ–¹æ¡ˆï¼ˆä½¿ç”¨ TypeScript + Reactï¼ŒåŸç†å¯ç§»æ¤åˆ°å…¶ä»–æ¡†æ¶ï¼‰ï¼š

---

### ä¸€ã€æ ¸å¿ƒå®ç°æ­¥éª¤
#### 1. ç›‘å¬æ–‡æœ¬é€‰æ‹©äº‹ä»¶
```tsx
import { useEffect, useRef, useState } from 'react';

const TextSelectionMenu = () => {
  const [menuVisible, setMenuVisible] = useState(false);
  const [menuPosition, setMenuPosition] = useState({ x: 0, y: 0 });
  const [selectedText, setSelectedText] = useState('');
  const containerRef = useRef<HTMLDivElement>(null);

  // ç›‘å¬æ–‡æœ¬é€‰æ‹©å˜åŒ–
  useEffect(() => {
    const handleSelectionChange = () => {
      const selection = window.getSelection();
      if (selection && selection.toString().trim() !== '') {
        setSelectedText(selection.toString());
      
        // è·å–é€‰åŒºä½ç½®
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        setMenuPosition({ x: rect.left, y: rect.bottom });
        setMenuVisible(true);
      } else {
        setMenuVisible(false);
      }
    };

    document.addEventListener('mouseup', handleSelectionChange);
    return () => document.removeEventListener('mouseup', handleSelectionChange);
  }, []);
```
**å…³é”®ç‚¹**ï¼š
- é€šè¿‡ `window.getSelection()` è·å–ç”¨æˆ·é€‰æ‹©çš„æ–‡æœ¬
- ä½¿ç”¨ `getBoundingClientRect()` è·å–é€‰åŒºä½ç½®

---

#### 2. é˜»æ­¢é»˜è®¤å³é”®èœå• + è‡ªå®šä¹‰èœå•
```tsx
  // é˜»æ­¢é»˜è®¤å³é”®èœå•
  useEffect(() => {
    const handleContextMenu = (e: MouseEvent) => {
      if (window.getSelection()?.toString()) {
        e.preventDefault(); // å½“æœ‰æ–‡æœ¬é€‰ä¸­æ—¶é˜»æ­¢é»˜è®¤èœå•
      }
    };

    document.addEventListener('contextmenu', handleContextMenu);
    return () => document.removeEventListener('contextmenu', handleContextMenu);
  }, []);

  // è‡ªå®šä¹‰èœå•æ“ä½œ
  const handleMenuAction = (action: string) => {
    console.log(`æ‰§è¡Œæ“ä½œ: ${action}`, selectedText);
    // å®é™…ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚è°ƒç”¨APIã€ä¿®æ”¹DOMç­‰ï¼‰
    setMenuVisible(false);
  };
```

---

#### 3. æ¸²æŸ“è‡ªå®šä¹‰èœå• UI
```tsx
  return (
    <div ref={containerRef} style={{ padding: '20px', userSelect: 'text' }}>
      <p>å°è¯•ç”¨é¼ æ ‡åˆ’è¯é€‰æ‹©è¿™æ®µæ–‡æœ¬ï¼Œç„¶åå³é”®ç‚¹å‡»...</p>

      {/* è‡ªå®šä¹‰å³é”®èœå• */}
      {menuVisible && (
        <div
          style={{
            position: 'fixed',
            left: `${menuPosition.x}px`,
            top: `${menuPosition.y}px`,
            backgroundColor: 'white',
            boxShadow: '0 2px 10px rgba(0,0,0,0.2)',
            borderRadius: '4px',
            zIndex: 1000,
          }}
          onClick={(e) => e.stopPropagation()}
        >
          <button 
            onClick={() => handleMenuAction('highlight')}
            style={{ display: 'block', width: '100%', padding: '8px 12px' }}
          >
            ğŸŒˆ é«˜äº®
          </button>
          <button
            onClick={() => handleMenuAction('translate')}
            style={{ display: 'block', width: '100%', padding: '8px 12px' }}
          >
            ğŸŒ ç¿»è¯‘
          </button>
          <button
            onClick={() => handleMenuAction('copy')}
            style={{ display: 'block', width: '100%', padding: '8px 12px' }}
          >
            â˜ å¤åˆ¶
          </button>
        </div>
      )}
    </div>
  );
};
```

---

### äºŒã€é«˜çº§åŠŸèƒ½æ‰©å±•
#### 1. åŠ¨æ€é«˜äº®é€‰ä¸­æ–‡æœ¬
```ts
const highlightSelection = () => {
  const selection = window.getSelection();
  if (!selection?.rangeCount) return;

  const range = selection.getRangeAt(0);
  const span = document.createElement('span');
  span.style.backgroundColor = 'yellow';

  range.surroundContents(span);
  selection.removeAllRanges();
};
```

#### 2. åˆ’è¯ç¿»è¯‘ï¼ˆè°ƒç”¨APIï¼‰
```ts
const translateText = async () => {
  try {
    const res = await fetch('https://api.example.com/translate', {
      method: 'POST',
      body: JSON.stringify({ text: selectedText })
    });
    const data = await res.json();
    alert(`ç¿»è¯‘ç»“æœ: ${data.result}`);
  } catch (err) {
    console.error('ç¿»è¯‘å¤±è´¥', err);
  }
};
```

---

### ä¸‰ã€è·¨æ¡†æ¶å®ç°æ–¹æ¡ˆ
#### Vue 3 ç‰ˆæœ¬
```vue
<template>
  <div ref="container" @mouseup="handleSelectionChange">
    <p>åˆ’è¯é€‰æ‹©æµ‹è¯•...</p>
    <div 
      v-if="menuVisible" 
      :style="menuStyle"
      @click.stop
    >
      <button @click="handleAction('highlight')">ğŸŒˆ é«˜äº®</button>
      <button @click="handleAction('copy')">â˜ å¤åˆ¶</button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';

const menuVisible = ref(false);
const menuPosition = ref({ x: 0, y: 0 });
const selectedText = ref('');

const handleSelectionChange = () => {
  const selection = window.getSelection();
  if (selection?.toString()) {
    const range = selection.getRangeAt(0);
    const rect = range.getBoundingClientRect();
    menuPosition.value = { x: rect.left, y: rect.bottom };
    menuVisible.value = true;
  }
};
</script>
```

---

### å››ã€æ³¨æ„äº‹é¡¹ä¸ä¼˜åŒ–
1. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   ```ts
   // é˜²æŠ–å¤„ç†é¢‘ç¹çš„ selectionchange äº‹ä»¶
   const debouncedHandler = _.debounce(handleSelectionChange, 100);
   ```

2. **æ— éšœç¢è®¿é—®**ï¼š
   ```tsx
   <button 
     aria-label="é«˜äº®é€‰ä¸­æ–‡æœ¬"
     onClick={/*...*/}
   >
     é«˜äº®
   </button>
   ```

3. **ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•**ï¼š
   ```tsx
   useEffect(() => {
     const handleClickOutside = () => setMenuVisible(false);
     document.addEventListener('click', handleClickOutside);
     return () => document.removeEventListener('click', handleClickOutside);
   }, []);
   ```

4. **å…¼å®¹æ€§å¤„ç†**ï¼š
   ```ts
   // å¤„ç† Safari çš„ selection å…¼å®¹æ€§
   const selection = window.getSelection() || document.getSelection();
   ```

---

### äº”ã€æœ€ç»ˆæ•ˆæœ
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
1. é¼ æ ‡åˆ’è¯é€‰æ‹©æ–‡æœ¬
2. è‡ªåŠ¨å¼¹å‡ºå³é”®èœå•ï¼ˆæˆ–éœ€å³é”®è§¦å‘ï¼‰
3. é€‰æ‹©èœå•é¡¹æ‰§è¡Œå¯¹åº”æ“ä½œ
4. æ“ä½œåèœå•è‡ªåŠ¨æ¶ˆå¤±

---

é€šè¿‡è¿™ä¸ªæ–¹æ¡ˆï¼Œä½ å¯ä»¥å®ç°ç±»ä¼¼æµè§ˆå™¨åŸç”Ÿåˆ’è¯ç¿»è¯‘æ’ä»¶çš„é«˜çº§äº¤äº’æ•ˆæœã€‚å…³é”®ç‚¹åœ¨äºç²¾å‡†æ§åˆ¶é€‰åŒºä½ç½®å’Œä¸è‡ªå®šä¹‰èœå•çš„è”åŠ¨ã€‚
