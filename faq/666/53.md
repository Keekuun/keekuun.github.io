## 53. å¦‚ä½•é€šè¿‡è®¾ç½®å¤±æ•ˆæ—¶é—´æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„æ•°æ®ï¼Ÿ

åœ¨ Web å¼€å‘ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ¡ˆå®ç°å¸¦å¤±æ•ˆæ—¶é—´çš„æœ¬åœ°æ•°æ®å­˜å‚¨ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´å®ç°æ–¹æ¡ˆï¼ˆä½¿ç”¨ TypeScriptï¼‰ï¼š

---

### ğŸŒŸ **è§£å†³æ–¹æ¡ˆå…¨æ™¯å›¾**
```mermaid
graph LR
    A[æ•°æ®å­˜å‚¨] --> B[è®¾ç½®è¿‡æœŸæ—¶é—´]
    A --> C[è¯»å–æ—¶éªŒè¯]
    A --> D[è‡ªåŠ¨æ¸…ç†]
```

---

### ä¸€ã€**åŸºç¡€å®ç°æ–¹æ¡ˆ**
#### 1. å°è£… localStorage å¸¦è¿‡æœŸæ—¶é—´
```typescript
// lib/storage.ts
interface StorageItem<T> {
  value: T
  expiry: number // æ—¶é—´æˆ³
}

export const setWithExpiry = <T>(key: string, value: T, ttl: number): void => {
  const now = new Date()
  const item: StorageItem<T> = {
    value,
    expiry: now.getTime() + ttl * 1000 // è½¬æ¢ä¸ºæ¯«ç§’
  }
  localStorage.setItem(key, JSON.stringify(item))
}

export const getWithExpiry = <T>(key: string): T | null => {
  const itemStr = localStorage.getItem(key)
  if (!itemStr) return null

  const item: StorageItem<T> = JSON.parse(itemStr)
  const now = new Date()

  // æ•°æ®å·²è¿‡æœŸ
  if (now.getTime() > item.expiry) {
    localStorage.removeItem(key)
    return null
  }

  return item.value
}

// ä½¿ç”¨ç¤ºä¾‹
setWithExpiry('user_token', 'abc123', 3600) // 1å°æ—¶åè¿‡æœŸ
const token = getWithExpiry<string>('user_token')
```

#### 2. å°è£… sessionStorage ç‰ˆæœ¬
```typescript
export const setSessionWithExpiry = <T>(key: string, value: T, ttl: number): void => {
  const item: StorageItem<T> = {
    value,
    expiry: Date.now() + ttl * 1000
  }
  sessionStorage.setItem(key, JSON.stringify(item))
}
```

---

### äºŒã€**é«˜çº§åŠŸèƒ½æ‰©å±•**
#### 1. è‡ªåŠ¨æ¸…ç†æœºåˆ¶
```typescript
// å¯åŠ¨æ—¶æ¸…ç†è¿‡æœŸé¡¹ç›®
export const cleanupExpiredItems = (): void => {
  Object.keys(localStorage).forEach(key => {
    getWithExpiry(key) // è¯»å–æ—¶ä¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸé¡¹
  })
}

// åº”ç”¨åˆå§‹åŒ–æ—¶è°ƒç”¨
if (typeof window !== 'undefined') {
  cleanupExpiredItems()
}
```

#### 2. æ”¯æŒåŠ å¯†å­˜å‚¨ï¼ˆæ•æ„Ÿæ•°æ®ï¼‰
```typescript
import CryptoJS from 'crypto-js'

const SECRET_KEY = 'your-secret-key'

export const setEncryptedWithExpiry = <T>(
  key: string,
  value: T,
  ttl: number
): void => {
  const item: StorageItem<T> = {
    value,
    expiry: Date.now() + ttl * 1000
  }
  const ciphertext = CryptoJS.AES.encrypt(
    JSON.stringify(item),
    SECRET_KEY
  ).toString()
  localStorage.setItem(key, ciphertext)
}
```

---

### ä¸‰ã€**React Hook å°è£…**
```typescript
// hooks/useExpiryStorage.ts
import { useEffect, useState } from 'react'

export function useExpiryStorage<T>(
  key: string,
  initialValue: T,
  ttl?: number
): [T, (value: T) => void] {
  const [storedValue, setStoredValue] = useState<T>(() => {
    if (typeof window === 'undefined') return initialValue

    const item = getWithExpiry<T>(key)
    return item ?? initialValue
  })

  const setValue = (value: T) => {
    if (typeof window === 'undefined') return

    if (ttl) {
      setWithExpiry(key, value, ttl)
    } else {
      localStorage.setItem(key, JSON.stringify(value))
    }
    setStoredValue(value)
  }

  useEffect(() => {
    const handleStorageChange = (e: StorageEvent) => {
      if (e.key === key) {
        setStoredValue(e.newValue ? JSON.parse(e.newValue) : initialValue)
      }
    }

    window.addEventListener('storage', handleStorageChange)
    return () => window.removeEventListener('storage', handleStorageChange)
  }, [key])

  return [storedValue, setValue]
}

// ä½¿ç”¨ç¤ºä¾‹
const [token, setToken] = useExpiryStorage('auth_token', null, 3600)
```

---

### å››ã€**æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”**
| æ–¹æ¡ˆ                | ä¼˜ç‚¹                      | ç¼ºç‚¹                     |
|---------------------|--------------------------|--------------------------|
| è‡ªå®šä¹‰å°è£…          | å®Œå…¨æ§åˆ¶é€»è¾‘              | éœ€è¦æ‰‹åŠ¨å®ç°æ‰€æœ‰åŠŸèƒ½      |
| store2 åº“           | å†…ç½®è¿‡æœŸæ—¶é—´æ”¯æŒ          | ä¾èµ–ç¬¬ä¸‰æ–¹åº“              |
| IndexedDB           | å­˜å‚¨é‡å¤§                  | API å¤æ‚                 |
| Cookies             | è‡ªåŠ¨è¿‡æœŸ                  | å­˜å‚¨ç©ºé—´å°(4KB)          |

#### ä½¿ç”¨ store2 åº“å®ç°
```typescript
import store from 'store2'

// è®¾ç½®å¸¦è¿‡æœŸæ—¶é—´çš„æ•°æ®ï¼ˆå•ä½ï¼šç§’ï¼‰
store.set('user_data', { name: 'John' }, 3600)

// è·å–æ•°æ®ï¼ˆè‡ªåŠ¨å¤„ç†è¿‡æœŸï¼‰
const user = store.get('user_data')
```

---

### äº”ã€**TypeScript ç±»å‹å¢å¼º**
```typescript
// types/storage.d.ts
declare module '@/lib/storage' {
  export function setWithExpiry<T>(
    key: string,
    value: T,
    ttl: number
  ): void

  export function getWithExpiry<T>(
    key: string
  ): T | null
}
```

---

### å…­ã€**å®é™…åº”ç”¨åœºæ™¯**
#### 1. ç”¨æˆ·ç™»å½•å‡­è¯
```typescript
// ç™»å½•æˆåŠŸå
setWithExpiry('auth_token', response.token, response.expires_in)

// è·¯ç”±å®ˆå«æ£€æŸ¥
const token = getWithExpiry<string>('auth_token')
if (!token) {
  router.push('/login')
}
```

#### 2. æ¥å£æ•°æ®ç¼“å­˜
```typescript
async function fetchProducts() {
  const cached = getWithExpiry<Product[]>('products_cache')
  if (cached) return cached

  const products = await api.getProducts()
  setWithExpiry('products_cache', products, 300) // 5åˆ†é’Ÿç¼“å­˜
  return products
}
```

---

### âš ï¸ **æ³¨æ„äº‹é¡¹**
1. **SSR å…¼å®¹æ€§**ï¼š
   ```typescript
   if (typeof window !== 'undefined') {
     // å®¢æˆ·ç«¯ä»£ç 
   }
   ```

2. **å­˜å‚¨é™åˆ¶**ï¼š
    - localStorage çº¦ 5MB
    - sessionStorage çº¦ 5MB
    - è¶…å‡ºé™åˆ¶ä¼šæŠ›å‡º `QuotaExceededError`

3. **æ•æ„Ÿä¿¡æ¯å®‰å…¨**ï¼š
   ```typescript
   // ä¸è¦å­˜å‚¨æœªåŠ å¯†çš„æ•æ„Ÿä¿¡æ¯
   setWithExpiry('credit_card', cardNumber, 3600) // âŒ å±é™©ï¼
   ```

éœ€è¦é’ˆå¯¹ç‰¹å®šæ¡†æ¶ï¼ˆå¦‚ Next.jsã€React Nativeï¼‰çš„ç‰¹æ®Šå¤„ç†æ–¹æ¡ˆå—ï¼Ÿæˆ–è€…éœ€è¦æ›´è¯¦ç»†çš„å®‰å…¨åŠ å¯†å®ç°ï¼Ÿ