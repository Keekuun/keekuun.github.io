## 97. 前端如何实现一个简单的图片裁剪功能？

实现前端图片裁剪功能可以通过原生 JavaScript 或第三方库（如 `cropper.js`）来完成。以下是两种方案的详细实现步骤和代码示例：

---

## **方案 1：使用原生 JavaScript + Canvas**
### **核心步骤**
1. **上传图片并预览**：通过 `<input type="file">` 获取图片文件，生成预览。
2. **绘制裁剪区域**：利用 Canvas 绘制图片和裁剪框。
3. **裁剪并导出**：通过 Canvas 的 `getImageData` 方法截取选中区域。

### **代码实现**
#### HTML 结构
```html
<input type="file" id="upload" accept="image/*" />
<div>
  <canvas id="canvas" width="500" height="500"></canvas>
</div>
<button id="crop-btn">裁剪</button>
<img id="result" />
```

#### JavaScript 逻辑
```typescript
const upload = document.getElementById('upload') as HTMLInputElement;
const canvas = document.getElementById('canvas') as HTMLCanvasElement;
const ctx = canvas.getContext('2d')!;
const cropBtn = document.getElementById('crop-btn') as HTMLButtonElement;
const result = document.getElementById('result') as HTMLImageElement;

let image: HTMLImageElement;
let isDragging = false;
let startX = 0;
let startY = 0;
let cropWidth = 100;
let cropHeight = 100;

// 1. 上传图片并预览
upload.addEventListener('change', (e) => {
  const file = (e.target as HTMLInputElement).files?.[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (event) => {
    image = new Image();
    image.onload = () => {
      ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
      drawCropArea(); // 初始绘制裁剪框
    };
    image.src = event.target?.result as string;
  };
  reader.readAsDataURL(file);
});

// 2. 绘制裁剪框
function drawCropArea() {
  ctx.strokeStyle = 'red';
  ctx.lineWidth = 2;
  ctx.strokeRect(startX, startY, cropWidth, cropHeight);
}

// 3. 拖动裁剪框
canvas.addEventListener('mousedown', (e) => {
  isDragging = true;
  startX = e.offsetX;
  startY = e.offsetY;
});

canvas.addEventListener('mousemove', (e) => {
  if (!isDragging) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
  cropWidth = e.offsetX - startX;
  cropHeight = e.offsetY - startY;
  drawCropArea();
});

canvas.addEventListener('mouseup', () => {
  isDragging = false;
});

// 4. 裁剪并导出
cropBtn.addEventListener('click', () => {
  const croppedImageData = ctx.getImageData(startX, startY, cropWidth, cropHeight);
  const croppedCanvas = document.createElement('canvas');
  croppedCanvas.width = cropWidth;
  croppedCanvas.height = cropHeight;
  const croppedCtx = croppedCanvas.getContext('2d')!;
  croppedCtx.putImageData(croppedImageData, 0, 0);

  result.src = croppedCanvas.toDataURL('image/png');
});
```

### **优点**
- 无第三方依赖，适合简单需求。
- 灵活可控。

### **缺点**
- 需要手动处理拖动逻辑和 Canvas 操作。

---

## **方案 2：使用第三方库 `cropper.js`**
### **核心步骤**
1. 引入 `cropper.js` 库。
2. 初始化 Cropper 实例并配置裁剪参数。
3. 通过 API 获取裁剪后的图片。

### **代码实现**
#### HTML 结构
```html
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
<input type="file" id="upload" accept="image/*" />
<div>
  <img id="image" src="" alt="预览图" />
</div>
<button id="crop-btn">裁剪</button>
<img id="result" />
```

#### JavaScript 逻辑
```typescript
import Cropper from 'cropperjs';

const upload = document.getElementById('upload') as HTMLInputElement;
const image = document.getElementById('image') as HTMLImageElement;
const cropBtn = document.getElementById('crop-btn') as HTMLButtonElement;
const result = document.getElementById('result') as HTMLImageElement;
let cropper: Cropper;

// 1. 上传图片并初始化 Cropper
upload.addEventListener('change', (e) => {
  const file = (e.target as HTMLInputElement).files?.[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (event) => {
    image.src = event.target?.result as string;
    if (cropper) cropper.destroy(); // 销毁旧实例

    cropper = new Cropper(image, {
      aspectRatio: 1, // 裁剪框比例（1:1）
      viewMode: 1,    // 限制裁剪框不超过图片范围
      autoCropArea: 0.8, // 默认裁剪区域占比
    });
  };
  reader.readAsDataURL(file);
});

// 2. 裁剪并导出
cropBtn.addEventListener('click', () => {
  if (!cropper) return;
  const croppedCanvas = cropper.getCroppedCanvas();
  result.src = croppedCanvas.toDataURL('image/png');
});
```

### **优点**
- 功能强大，支持旋转、缩放、比例锁定等。
- 代码简洁，社区支持好。

### **缺点**
- 需引入额外库（约 200KB）。

---

## **方案对比**
| **方案**           | **适用场景**               | **优点**                          | **缺点**                     |
|--------------------|--------------------------|----------------------------------|-----------------------------|
| **原生 JavaScript** | 简单需求、无库依赖        | 轻量、可控性强                   | 实现复杂功能（如旋转）困难   |
| **Cropper.js**     | 复杂需求、快速开发        | 功能丰富、API 友好               | 需引入第三方库              |

---

## **扩展功能**
1. **固定裁剪比例**：
   ```typescript
   new Cropper(image, { aspectRatio: 16 / 9 });
   ```
2. **旋转图片**：
   ```typescript
   cropper.rotate(90); // 旋转 90 度
   ```
3. **导出指定格式**：
   ```typescript
   cropper.getCroppedCanvas().toDataURL('image/jpeg', 0.8); // JPEG 质量为 80%
   ```

---

## **注意事项**
1. **移动端适配**：`cropper.js` 默认支持触摸事件，但需测试不同设备。
2. **性能优化**：大图片裁剪前可先压缩。
3. **安全性**：裁剪后的图片需校验内容（防止恶意文件上传）。

---

## **完整示例（Cropper.js）**
[CodePen 示例链接](https://codepen.io/anon/pen/xxYwBQv)
直接复制代码到本地或在线编辑器即可运行！

根据项目需求选择方案，快速实现图片裁剪功能！ ✂️🖼️