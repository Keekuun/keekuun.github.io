## 98. 如何检测网页空闲状态（一定时间内无操作）？

检测网页空闲状态（即用户在一定时间内无操作）可以通过监听用户的活动事件（如鼠标移动、键盘输入等），并结合定时器来实现。以下是详细的实现方法和代码示例：

---

## **1. 核心思路**
1. **监听用户活动事件**：如 `mousemove`、`keydown`、`scroll` 等。
2. **重置定时器**：每次用户操作时，重置一个倒计时定时器。
3. **触发空闲回调**：如果定时器倒计时结束，说明用户处于空闲状态。

---

## **2. 原生 JavaScript 实现**
### **代码示例**
```typescript
class IdleDetector {
  private timer: number | null = null;
  private isIdle = false;
  private readonly idleTimeout: number; // 空闲超时时间（毫秒）
  private readonly onIdle: () => void;  // 空闲回调函数
  private readonly onActive?: () => void; // 从空闲恢复的回调函数

  constructor(
    idleTimeout: number,
    onIdle: () => void,
    onActive?: () => void
  ) {
    this.idleTimeout = idleTimeout;
    this.onIdle = onIdle;
    this.onActive = onActive;
    this.startListening();
  }

  // 监听用户活动事件
  private startListening() {
    const events = ['mousemove', 'keydown', 'scroll', 'click', 'touchstart'];
    events.forEach((event) => {
      window.addEventListener(event, this.handleUserActivity.bind(this));
    });
  }

  // 用户活动时重置定时器
  private handleUserActivity() {
    if (this.timer) clearTimeout(this.timer);

    // 如果之前是空闲状态，触发恢复回调
    if (this.isIdle && this.onActive) {
      this.onActive();
      this.isIdle = false;
    }

    // 设置新的定时器
    this.timer = window.setTimeout(() => {
      this.isIdle = true;
      this.onIdle();
    }, this.idleTimeout);
  }

  // 销毁监听
  public destroy() {
    const events = ['mousemove', 'keydown', 'scroll', 'click', 'touchstart'];
    events.forEach((event) => {
      window.removeEventListener(event, this.handleUserActivity);
    });
    if (this.timer) clearTimeout(this.timer);
  }
}

// 使用示例
const detector = new IdleDetector(
  5000, // 5秒无操作视为空闲
  () => console.log('用户处于空闲状态！'),
  () => console.log('用户恢复活动！')
);

// 销毁（如组件卸载时调用）
// detector.destroy();
```

### **功能说明**
- **参数**：
    - `idleTimeout`：空闲超时时间（如 `5000` 毫秒）。
    - `onIdle`：空闲时触发的回调函数。
    - `onActive`（可选）：从空闲恢复时触发的回调函数。
- **事件监听**：覆盖鼠标、键盘、滚动等常见操作。
- **自动清理**：提供 `destroy()` 方法移除监听。

---

## **3. 使用第三方库 `idle-js`**
如果不想手动实现，可以使用轻量级库 [`idle-js`](https://github.com/shawnmclean/Idle.js)。

### **安装**
```bash
npm install idle-js
```

### **代码示例**
```typescript
import IdleJs from 'idle-js';

const idle = new IdleJs({
  idle: 5000, // 5秒无操作
  onIdle: () => console.log('用户空闲了！'),
  onActive: () => console.log('用户回来了！'),
  events: ['mousemove', 'keydown', 'scroll'], // 监听的事件
});

// 启动检测
idle.start();

// 停止检测
// idle.stop();
```

---

## **4. 实际应用场景**
### **场景 1：自动锁屏**
```typescript
const lockScreen = () => {
  document.body.innerHTML = '<div class="lock-screen">请重新操作以解锁</div>';
};

const unlockScreen = () => {
  document.body.innerHTML = '<div>正常内容</div>';
};

new IdleDetector(30000, lockScreen, unlockScreen); // 30秒无操作锁屏
```

### **场景 2：节省资源**
```typescript
// 用户空闲时暂停视频或动画
const video = document.getElementById('video') as HTMLVideoElement;
new IdleDetector(
  10000,
  () => video.pause(),
  () => video.play()
);
```

### **场景 3：统计用户行为**
```typescript
let idleCount = 0;
new IdleDetector(5000, () => {
  idleCount++;
  console.log(`用户第 ${idleCount} 次进入空闲状态`);
});
```

---

## **5. 注意事项**
1. **性能优化**：
    - 避免在 `mousemove` 等高频率事件中执行复杂逻辑。
    - 使用防抖（`debounce`）减少不必要的回调触发。

2. **移动端适配**：
    - 增加 `touchstart` 和 `touchend` 事件监听。

3. **安全考虑**：
    - 敏感操作（如支付）不建议仅依赖前端空闲检测，需结合后端验证。

4. **兼容性**：
    - 所有现代浏览器均支持相关事件。

---

## **总结**
| **方法**               | **适用场景**                     | **优点**                          | **缺点**                     |
|------------------------|--------------------------------|----------------------------------|-----------------------------|
| **原生 JavaScript**    | 需要高度自定义或避免第三方依赖   | 灵活、无额外依赖                 | 需手动实现细节              |
| **`idle-js` 库**       | 快速集成、标准化需求             | 开箱即用、功能完善               | 需引入额外库                |

根据需求选择合适方案，轻松实现用户空闲状态检测！ ⏳