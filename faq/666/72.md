## 72. 介绍一下 requestIdleCallback api

`requestIdleCallback` 是浏览器提供的一个用于 **在空闲时段执行低优先级任务** 的 API。它允许开发者将非关键任务延迟到浏览器空闲时执行，从而避免阻塞关键任务（如动画、用户交互等），提升页面性能和用户体验。

---

## **1. 核心概念**
- **作用**：在浏览器空闲时执行任务，避免影响关键渲染路径。
- **适用场景**：日志上报、数据预加载、非紧急 UI 更新等。
- **兼容性**：现代浏览器支持（Chrome、Firefox、Edge），但不支持 IE。

---

## **2. 基本用法**
```typescript
type IdleCallbackHandle = number;
type IdleRequestOptions = {
  timeout?: number; // 超时时间（毫秒），强制触发回调
};

// 注册空闲任务
const handle: IdleCallbackHandle = requestIdleCallback(
  (deadline: IdleDeadline) => {
    // deadline 提供两个关键属性：
    // - timeRemaining(): 剩余空闲时间（毫秒）
    // - didTimeout: 是否因超时触发
    while (deadline.timeRemaining() > 0 && tasks.length > 0) {
      performTask(); // 执行任务
    }

    if (tasks.length > 0) {
      requestIdleCallback(processTasks, { timeout: 1000 }); // 继续调度
    }
  },
  { timeout: 1000 } // 可选配置
);

// 取消任务
cancelIdleCallback(handle);
```

---

## **3. 关键参数解析**
### **(1) `IdleDeadline` 对象**
- `timeRemaining()`: 返回当前帧剩余的空闲时间（通常 ≤ 50ms）。
- `didTimeout`: 若任务因超时触发（配置了 `timeout`），则为 `true`。

### **(2) `options` 配置**
- `timeout`: 强制任务在指定时间后执行（即使浏览器不空闲）。

---

## **4. 使用场景示例**
### **(1) 日志批量上报**
```typescript
const logQueue: string[] = [];

// 收集日志
function collectLog(log: string) {
  logQueue.push(log);
  scheduleIdleLog();
}

// 空闲时上报
function scheduleIdleLog() {
  requestIdleCallback(
    (deadline) => {
      while (deadline.timeRemaining() > 0 && logQueue.length > 0) {
        sendLog(logQueue.shift()!);
      }
      if (logQueue.length > 0) scheduleIdleLog();
    },
    { timeout: 2000 } // 最多等待 2 秒
  );
}
```

### **(2) 数据预加载**
```typescript
function prefetchData(urls: string[]) {
  requestIdleCallback(() => {
    urls.forEach(url => {
      fetch(url, { mode: 'no-cors' }); // 静默预加载
    });
  });
}
```

---

## **5. 注意事项**
1. **避免长时间任务**：单次任务不应超过 `50ms`，否则可能阻塞交互。
2. **超时慎用**：`timeout` 可能强制触发任务，导致性能下降。
3. **兼容性处理**：降级方案可使用 `setTimeout`：
   ```typescript
   const fallbackIdleCallback = (cb: () => void) => setTimeout(cb, 100);
   ```

---

## **6. 与类似 API 对比**
| **API**                | **触发时机**               | **适用场景**                     |
|------------------------|--------------------------|--------------------------------|
| `requestIdleCallback`  | 浏览器空闲时               | 低优先级任务（如日志、预加载）     |
| `requestAnimationFrame`| 下一帧渲染前               | 动画、高频 UI 更新               |
| `setTimeout`           | 指定延迟后                 | 通用延迟任务（无空闲时间控制）     |

---

## **7. 性能优化实践**
- **分片任务**：将大任务拆分为多个小任务，每次空闲时执行一部分。
  ```typescript
  function processLargeTask(tasks: Task[]) {
    let index = 0;
    function doChunk(deadline: IdleDeadline) {
      while (deadline.timeRemaining() > 0 && index < tasks.length) {
        processTask(tasks[index++]);
      }
      if (index < tasks.length) {
        requestIdleCallback(doChunk);
      }
    }
    requestIdleCallback(doChunk);
  }
  ```

---

## **8. 兼容性增强**
```typescript
// 封装兼容性版本
const requestIdleCallback = window.requestIdleCallback || 
  ((cb: () => void) => setTimeout(cb, 50));

const cancelIdleCallback = window.cancelIdleCallback || 
  clearTimeout;
```

---

## **总结**
- **优势**：最大化利用浏览器空闲时间，避免阻塞关键任务。
- **原则**：适合非紧急、可中断的任务。
- **工具链**：可与 `Web Workers` 结合处理 CPU 密集型任务。

合理使用 `requestIdleCallback` 能让你的应用更流畅！ 🚀