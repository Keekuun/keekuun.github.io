## 91. Js 的加载会阻塞浏览器渲染吗？

是的，JavaScript 的加载和执行默认会阻塞浏览器渲染，但具体行为取决于脚本的加载方式（如 `<script>` 标签的属性）和浏览器的渲染机制。以下是详细分析：

---

## **1. 默认行为：阻塞渲染**
当浏览器解析 HTML 时，如果遇到 `<script>` 标签，会**立即停止 HTML 解析和渲染**，先加载并执行脚本，完成后才继续渲染。
**原因**：JS 可能修改 DOM 或 CSSOM，浏览器必须保证执行顺序的正确性。

```html
<script src="app.js"></script> <!-- 阻塞渲染 -->
```

---

## **2. 优化手段：避免阻塞**
### **(1) `async` 属性**
- **行为**：异步加载脚本，加载完成后**立即执行**（可能中断渲染）。
- **适用场景**：不依赖 DOM 或其他脚本的独立模块（如统计代码）。

```html
<script async src="analytics.js"></script>
```

### **(2) `defer` 属性**
- **行为**：异步加载脚本，但延迟到 **HTML 解析完成后**再按顺序执行。
- **适用场景**：依赖 DOM 或需要按顺序执行的脚本。

```html
<script defer src="app.js"></script>
```

### **(3) 动态加载**
通过 JavaScript 动态插入 `<script>` 标签，默认行为类似 `async`。

```javascript
const script = document.createElement('script');
script.src = 'app.js';
document.body.appendChild(script);
```

### **(4) `type="module"`**
- **行为**：现代浏览器默认以 `defer` 方式处理 ES 模块。
- **注意**：内联模块脚本仍会阻塞。

```html
<script type="module" src="app.js"></script>
```

---

## **3. 关键渲染路径（CRP）**
浏览器渲染流程与 JS 的关系：
1. **解析 HTML** → 构建 DOM 树。
2. **解析 CSS** → 构建 CSSOM 树。
3. **执行 JS** → 可能修改 DOM/CSSOM，触发回流或重绘。
4. **生成渲染树（Render Tree）** → 布局（Layout） → 绘制（Paint）。

**JS 阻塞 CRP**：因为 DOM/CSSOM 的修改可能影响后续渲染步骤。

---

## **4. 性能影响对比**
| **加载方式**       | **阻塞 HTML 解析** | **执行时机**               | **适用场景**               |
|--------------------|-------------------|---------------------------|---------------------------|
| 默认 (`<script>`)  | 是                | 立即执行                  | 无特殊需求                 |
| `async`            | 否（加载异步）     | 加载完成后立即执行         | 独立脚本（如统计）         |
| `defer`            | 否（加载异步）     | HTML 解析后按顺序执行      | 依赖 DOM 或多脚本协作      |
| 动态加载           | 否                | 加载完成后立即执行（类 async） | 按需加载的代码             |

---

## **5. 最佳实践**
1. **关键脚本**：使用 `defer` 或内联到 `<head>` 中。
2. **非关键脚本**：使用 `async` 或动态加载。
3. **减少同步操作**：避免在脚本中执行长耗时任务（如大量计算）。
4. **优化 CSS**：避免 JS 依赖未加载的 CSS（如 `getComputedStyle`）。

---

## **6. 示例：优化页面加载**
```html
<head>
  <!-- 关键 CSS -->
  <link rel="stylesheet" href="styles.css">
  <!-- 非阻塞 JS -->
  <script defer src="app.js"></script>
</head>
<body>
  <!-- 内容 -->
  <!-- 异步加载非关键 JS -->
  <script async src="analytics.js"></script>
</body>
```

---

## **总结**
- **JS 默认阻塞渲染**：因可能修改 DOM/CSSOM。
- **优化方式**：`async`、`defer`、动态加载或模块化。
- **目标**：优先加载关键资源，非关键脚本延迟或异步执行。

通过合理控制脚本加载策略，可以显著提升页面渲染性能！ 🚀