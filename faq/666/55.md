## 55. 用 nodejs 实现一个命令行工具，统计输入目录下面指定代码的行数

下面是一个使用 Node.js 实现的命令行工具，用于统计指定目录下特定代码文件的行数（支持递归搜索）。我们将使用 TypeScript 实现，并添加详细的注释说明：

---

### 📁 **项目结构**
```bash
code-stats/
├── src/
│   ├── cli.ts          # 命令行入口
│   ├── counter.ts      # 核心统计逻辑
│   ├── types.ts        # 类型定义
├── bin/                # 可执行文件
│   └── code-stats      # Linux/Mac 执行入口
├── package.json
└── tsconfig.json
```

---

### 📦 **安装依赖**
```bash
# 初始化项目
npm init -y

# 安装核心依赖
npm install typescript ts-node @types/node --save-dev

# 开发时运行工具
npm install chalk@4.1.2 commander@9.4.1 fast-glob@3.2.12 --save
```

---

### ⚙️ **核心实现**

#### 1. `src/types.ts` (类型定义)
```typescript
export interface FileStats {
  filePath: string
  lines: number
  blankLines: number
  codeLines: number
  commentLines: number
}

export interface Options {
  extensions: string[]
  ignore: string[]
  verbose: boolean
}
```

#### 2. `src/counter.ts` (统计逻辑)
```typescript
import fs from 'fs'
import path from 'path'
import fg from 'fast-glob'
import chalk from 'chalk'
import { FileStats, Options } from './types'

// 检测是否为注释行
const isCommentLine = (line: string): boolean => {
  const trimmed = line.trim()
  return (
    trimmed.startsWith('//') ||
    trimmed.startsWith('/*') ||
    trimmed.startsWith('*') ||
    trimmed.endsWith('*/')
  )
}

// 统计单个文件
export const countFileLines = (filePath: string): FileStats => {
  const content = fs.readFileSync(filePath, 'utf-8')
  const lines = content.split('\n')

  let blankLines = 0
  let commentLines = 0

  lines.forEach(line => {
    if (!line.trim()) blankLines++
    else if (isCommentLine(line)) commentLines++
  })

  return {
    filePath,
    lines: lines.length,
    blankLines,
    commentLines,
    codeLines: lines.length - blankLines - commentLines
  }
}

// 递归统计目录
export const countLines = async (dir: string, options: Options) => {
  const pattern = `**/*.{${options.extensions.join(',')}}`
  const files = await fg(pattern, {
    cwd: dir,
    absolute: true,
    ignore: options.ignore
  })

  const results: FileStats[] = []
  let total: Omit<FileStats, 'filePath'> = {
    lines: 0,
    blankLines: 0,
    codeLines: 0,
    commentLines: 0
  }

  for (const file of files) {
    const stats = countFileLines(file)
    results.push(stats)

    total.lines += stats.lines
    total.blankLines += stats.blankLines
    total.codeLines += stats.codeLines
    total.commentLines += stats.commentLines

    if (options.verbose) {
      console.log(
        chalk.gray(file) +
          chalk.green(` ${stats.lines}行`) +
          ` (代码:${stats.codeLines} ` +
          `空行:${stats.blankLines} ` +
          `注释:${stats.commentLines})`
      )
    }
  }

  return { files: results, total }
}
```

#### 3. `src/cli.ts` (命令行界面)
```typescript
#!/usr/bin/env node
import { program } from 'commander'
import chalk from 'chalk'
import { countLines } from './counter'
import { Options } from './types'

program
  .name('code-stats')
  .description('统计代码行数工具')
  .version('1.0.0')
  .argument('<dir>', '要统计的目录')
  .option('-e, --extensions <exts>', '文件扩展名 (默认: ts,js,jsx,tsx)', 'ts,js,jsx,tsx')
  .option('-i, --ignore <patterns>', '忽略目录 (默认: node_modules,dist)', 'node_modules,dist')
  .option('-v, --verbose', '显示详细输出')
  .action(async (dir, options) => {
    const opts: Options = {
      extensions: options.extensions.split(','),
      ignore: options.ignore.split(',').map(p => `**/${p}/**`),
      verbose: !!options.verbose
    }

    try {
      const { files, total } = await countLines(dir, opts)
    
      console.log(chalk.bold('\n📊 统计结果:'))
      console.log(chalk.blue(`📂 扫描目录: ${dir}`))
      console.log(chalk.blue(`📄 文件数量: ${files.length}`))
      console.log(chalk.yellow(`📜 总行数: ${total.lines}`))
      console.log(chalk.green(`💻 代码行: ${total.codeLines}`))
      console.log(chalk.gray(`⬜ 空行: ${total.blankLines}`))
      console.log(chalk.cyan(`💬 注释行: ${total.commentLines}\n`))

      if (!opts.verbose) {
        console.log(chalk.gray('添加 -v 参数查看每个文件的统计详情'))
      }
    } catch (err) {
      console.error(chalk.red('❌ 发生错误:', err.message))
      process.exit(1)
    }
  })

program.parse()
```

---

### 🔧 **项目配置**

#### 1. `package.json`
```json
{
  "name": "code-stats",
  "version": "1.0.0",
  "bin": {
    "code-stats": "bin/code-stats"
  },
  "scripts": {
    "build": "tsc",
    "start": "ts-node src/cli.ts",
    "dev": "nodemon --watch src --exec ts-node src/cli.ts"
  }
}
```

#### 2. `bin/code-stats` (可执行文件)
```bash
#!/usr/bin/env node
require('../dist/cli.js')
```

#### 3. `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true
  }
}
```

---

### 🚀 **使用方式**

#### 1. 全局安装使用
```bash
npm install -g .
code-stats ./src --extensions ts,js --ignore node_modules,test
```

#### 2. 直接运行
```bash
npx ts-node src/cli.ts ./src -v
```

#### 3. 示例输出
```text
📊 统计结果:
📂 扫描目录: ./src
📄 文件数量: 23
📜 总行数: 1520
💻 代码行: 982
⬜ 空行: 210
💬 注释行: 328
```

---

### 🛠️ **功能扩展建议**

1. **支持更多文件类型**：
   ```typescript
   // 修改检测逻辑
   const isCssComment = (line: string) => line.trim().startsWith('/*')
   ```

2. **导出统计报告**：
   ```typescript
   fs.writeFileSync('report.json', JSON.stringify(results, null, 2))
   ```

3. **Git 集成**：
   ```bash
   npm install simple-git
   ```
   ```typescript
   import git from 'simple-git'
   const modifiedFiles = await git().diff(['--name-only'])
   ```

4. **性能优化**：
   ```typescript
   // 使用 worker_threads 并行处理大文件
   import { Worker } from 'worker_threads'
   ```

5. **交互式选择**：
   ```bash
   npm install inquirer @types/inquirer
   ```
   ```typescript
   import inquirer from 'inquirer'
   const { dir } = await inquirer.prompt([...])
   ```

---

### ⚠️ **注意事项**

1. **大文件处理**：
    - 使用流式读取避免内存溢出：
      ```typescript
      const stream = fs.createReadStream(file, 'utf8')
      ```

2. **符号链接**：
    - 在 `fast-glob` 中添加 `followSymbolicLinks: true`

3. **编码检测**：
    - 使用 `jschardet` 检测非 UTF-8 文件

4. **跨平台路径**：
    - 始终使用 `path.join()` 处理路径

---

这个工具提供了：
- 多文件扩展名支持
- 忽略目录功能
- 详细/简洁输出模式
- 代码/注释/空行分类统计
- 友好的彩色控制台输出

需要进一步扩展任何特定功能吗？比如添加测试覆盖率统计或者与 CI 工具集成？