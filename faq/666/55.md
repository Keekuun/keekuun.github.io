## 55. ç”¨ nodejs å®ç°ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç»Ÿè®¡è¾“å…¥ç›®å½•ä¸‹é¢æŒ‡å®šä»£ç çš„è¡Œæ•°

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Node.js å®ç°çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºç»Ÿè®¡æŒ‡å®šç›®å½•ä¸‹ç‰¹å®šä»£ç æ–‡ä»¶çš„è¡Œæ•°ï¼ˆæ”¯æŒé€’å½’æœç´¢ï¼‰ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ TypeScript å®ç°ï¼Œå¹¶æ·»åŠ è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜ï¼š

---

### ğŸ“ **é¡¹ç›®ç»“æ„**
```bash
code-stats/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ cli.ts          # å‘½ä»¤è¡Œå…¥å£
â”‚   â”œâ”€â”€ counter.ts      # æ ¸å¿ƒç»Ÿè®¡é€»è¾‘
â”‚   â”œâ”€â”€ types.ts        # ç±»å‹å®šä¹‰
â”œâ”€â”€ bin/                # å¯æ‰§è¡Œæ–‡ä»¶
â”‚   â””â”€â”€ code-stats      # Linux/Mac æ‰§è¡Œå…¥å£
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

---

### ğŸ“¦ **å®‰è£…ä¾èµ–**
```bash
# åˆå§‹åŒ–é¡¹ç›®
npm init -y

# å®‰è£…æ ¸å¿ƒä¾èµ–
npm install typescript ts-node @types/node --save-dev

# å¼€å‘æ—¶è¿è¡Œå·¥å…·
npm install chalk@4.1.2 commander@9.4.1 fast-glob@3.2.12 --save
```

---

### âš™ï¸ **æ ¸å¿ƒå®ç°**

#### 1. `src/types.ts` (ç±»å‹å®šä¹‰)
```typescript
export interface FileStats {
  filePath: string
  lines: number
  blankLines: number
  codeLines: number
  commentLines: number
}

export interface Options {
  extensions: string[]
  ignore: string[]
  verbose: boolean
}
```

#### 2. `src/counter.ts` (ç»Ÿè®¡é€»è¾‘)
```typescript
import fs from 'fs'
import path from 'path'
import fg from 'fast-glob'
import chalk from 'chalk'
import { FileStats, Options } from './types'

// æ£€æµ‹æ˜¯å¦ä¸ºæ³¨é‡Šè¡Œ
const isCommentLine = (line: string): boolean => {
  const trimmed = line.trim()
  return (
    trimmed.startsWith('//') ||
    trimmed.startsWith('/*') ||
    trimmed.startsWith('*') ||
    trimmed.endsWith('*/')
  )
}

// ç»Ÿè®¡å•ä¸ªæ–‡ä»¶
export const countFileLines = (filePath: string): FileStats => {
  const content = fs.readFileSync(filePath, 'utf-8')
  const lines = content.split('\n')

  let blankLines = 0
  let commentLines = 0

  lines.forEach(line => {
    if (!line.trim()) blankLines++
    else if (isCommentLine(line)) commentLines++
  })

  return {
    filePath,
    lines: lines.length,
    blankLines,
    commentLines,
    codeLines: lines.length - blankLines - commentLines
  }
}

// é€’å½’ç»Ÿè®¡ç›®å½•
export const countLines = async (dir: string, options: Options) => {
  const pattern = `**/*.{${options.extensions.join(',')}}`
  const files = await fg(pattern, {
    cwd: dir,
    absolute: true,
    ignore: options.ignore
  })

  const results: FileStats[] = []
  let total: Omit<FileStats, 'filePath'> = {
    lines: 0,
    blankLines: 0,
    codeLines: 0,
    commentLines: 0
  }

  for (const file of files) {
    const stats = countFileLines(file)
    results.push(stats)

    total.lines += stats.lines
    total.blankLines += stats.blankLines
    total.codeLines += stats.codeLines
    total.commentLines += stats.commentLines

    if (options.verbose) {
      console.log(
        chalk.gray(file) +
          chalk.green(` ${stats.lines}è¡Œ`) +
          ` (ä»£ç :${stats.codeLines} ` +
          `ç©ºè¡Œ:${stats.blankLines} ` +
          `æ³¨é‡Š:${stats.commentLines})`
      )
    }
  }

  return { files: results, total }
}
```

#### 3. `src/cli.ts` (å‘½ä»¤è¡Œç•Œé¢)
```typescript
#!/usr/bin/env node
import { program } from 'commander'
import chalk from 'chalk'
import { countLines } from './counter'
import { Options } from './types'

program
  .name('code-stats')
  .description('ç»Ÿè®¡ä»£ç è¡Œæ•°å·¥å…·')
  .version('1.0.0')
  .argument('<dir>', 'è¦ç»Ÿè®¡çš„ç›®å½•')
  .option('-e, --extensions <exts>', 'æ–‡ä»¶æ‰©å±•å (é»˜è®¤: ts,js,jsx,tsx)', 'ts,js,jsx,tsx')
  .option('-i, --ignore <patterns>', 'å¿½ç•¥ç›®å½• (é»˜è®¤: node_modules,dist)', 'node_modules,dist')
  .option('-v, --verbose', 'æ˜¾ç¤ºè¯¦ç»†è¾“å‡º')
  .action(async (dir, options) => {
    const opts: Options = {
      extensions: options.extensions.split(','),
      ignore: options.ignore.split(',').map(p => `**/${p}/**`),
      verbose: !!options.verbose
    }

    try {
      const { files, total } = await countLines(dir, opts)
    
      console.log(chalk.bold('\nğŸ“Š ç»Ÿè®¡ç»“æœ:'))
      console.log(chalk.blue(`ğŸ“‚ æ‰«æç›®å½•: ${dir}`))
      console.log(chalk.blue(`ğŸ“„ æ–‡ä»¶æ•°é‡: ${files.length}`))
      console.log(chalk.yellow(`ğŸ“œ æ€»è¡Œæ•°: ${total.lines}`))
      console.log(chalk.green(`ğŸ’» ä»£ç è¡Œ: ${total.codeLines}`))
      console.log(chalk.gray(`â¬œ ç©ºè¡Œ: ${total.blankLines}`))
      console.log(chalk.cyan(`ğŸ’¬ æ³¨é‡Šè¡Œ: ${total.commentLines}\n`))

      if (!opts.verbose) {
        console.log(chalk.gray('æ·»åŠ  -v å‚æ•°æŸ¥çœ‹æ¯ä¸ªæ–‡ä»¶çš„ç»Ÿè®¡è¯¦æƒ…'))
      }
    } catch (err) {
      console.error(chalk.red('âŒ å‘ç”Ÿé”™è¯¯:', err.message))
      process.exit(1)
    }
  })

program.parse()
```

---

### ğŸ”§ **é¡¹ç›®é…ç½®**

#### 1. `package.json`
```json
{
  "name": "code-stats",
  "version": "1.0.0",
  "bin": {
    "code-stats": "bin/code-stats"
  },
  "scripts": {
    "build": "tsc",
    "start": "ts-node src/cli.ts",
    "dev": "nodemon --watch src --exec ts-node src/cli.ts"
  }
}
```

#### 2. `bin/code-stats` (å¯æ‰§è¡Œæ–‡ä»¶)
```bash
#!/usr/bin/env node
require('../dist/cli.js')
```

#### 3. `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true
  }
}
```

---

### ğŸš€ **ä½¿ç”¨æ–¹å¼**

#### 1. å…¨å±€å®‰è£…ä½¿ç”¨
```bash
npm install -g .
code-stats ./src --extensions ts,js --ignore node_modules,test
```

#### 2. ç›´æ¥è¿è¡Œ
```bash
npx ts-node src/cli.ts ./src -v
```

#### 3. ç¤ºä¾‹è¾“å‡º
```text
ğŸ“Š ç»Ÿè®¡ç»“æœ:
ğŸ“‚ æ‰«æç›®å½•: ./src
ğŸ“„ æ–‡ä»¶æ•°é‡: 23
ğŸ“œ æ€»è¡Œæ•°: 1520
ğŸ’» ä»£ç è¡Œ: 982
â¬œ ç©ºè¡Œ: 210
ğŸ’¬ æ³¨é‡Šè¡Œ: 328
```

---

### ğŸ› ï¸ **åŠŸèƒ½æ‰©å±•å»ºè®®**

1. **æ”¯æŒæ›´å¤šæ–‡ä»¶ç±»å‹**ï¼š
   ```typescript
   // ä¿®æ”¹æ£€æµ‹é€»è¾‘
   const isCssComment = (line: string) => line.trim().startsWith('/*')
   ```

2. **å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Š**ï¼š
   ```typescript
   fs.writeFileSync('report.json', JSON.stringify(results, null, 2))
   ```

3. **Git é›†æˆ**ï¼š
   ```bash
   npm install simple-git
   ```
   ```typescript
   import git from 'simple-git'
   const modifiedFiles = await git().diff(['--name-only'])
   ```

4. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   ```typescript
   // ä½¿ç”¨ worker_threads å¹¶è¡Œå¤„ç†å¤§æ–‡ä»¶
   import { Worker } from 'worker_threads'
   ```

5. **äº¤äº’å¼é€‰æ‹©**ï¼š
   ```bash
   npm install inquirer @types/inquirer
   ```
   ```typescript
   import inquirer from 'inquirer'
   const { dir } = await inquirer.prompt([...])
   ```

---

### âš ï¸ **æ³¨æ„äº‹é¡¹**

1. **å¤§æ–‡ä»¶å¤„ç†**ï¼š
    - ä½¿ç”¨æµå¼è¯»å–é¿å…å†…å­˜æº¢å‡ºï¼š
      ```typescript
      const stream = fs.createReadStream(file, 'utf8')
      ```

2. **ç¬¦å·é“¾æ¥**ï¼š
    - åœ¨ `fast-glob` ä¸­æ·»åŠ  `followSymbolicLinks: true`

3. **ç¼–ç æ£€æµ‹**ï¼š
    - ä½¿ç”¨ `jschardet` æ£€æµ‹é UTF-8 æ–‡ä»¶

4. **è·¨å¹³å°è·¯å¾„**ï¼š
    - å§‹ç»ˆä½¿ç”¨ `path.join()` å¤„ç†è·¯å¾„

---

è¿™ä¸ªå·¥å…·æä¾›äº†ï¼š
- å¤šæ–‡ä»¶æ‰©å±•åæ”¯æŒ
- å¿½ç•¥ç›®å½•åŠŸèƒ½
- è¯¦ç»†/ç®€æ´è¾“å‡ºæ¨¡å¼
- ä»£ç /æ³¨é‡Š/ç©ºè¡Œåˆ†ç±»ç»Ÿè®¡
- å‹å¥½çš„å½©è‰²æ§åˆ¶å°è¾“å‡º

éœ€è¦è¿›ä¸€æ­¥æ‰©å±•ä»»ä½•ç‰¹å®šåŠŸèƒ½å—ï¼Ÿæ¯”å¦‚æ·»åŠ æµ‹è¯•è¦†ç›–ç‡ç»Ÿè®¡æˆ–è€…ä¸ CI å·¥å…·é›†æˆï¼Ÿ