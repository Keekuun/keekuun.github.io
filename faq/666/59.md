## 59. [React] å¦‚ä½•è¿›è¡Œè·¯ç”±å˜åŒ–ç›‘å¬

åœ¨ React åº”ç”¨ä¸­ç›‘å¬è·¯ç”±å˜åŒ–æ˜¯å¸¸è§çš„éœ€æ±‚ï¼ˆå¦‚åŸ‹ç‚¹ç»Ÿè®¡ã€æƒé™æ§åˆ¶ã€åŠ¨æ€æ ‡é¢˜ç­‰ï¼‰ã€‚ä»¥ä¸‹æ˜¯é’ˆå¯¹ä¸åŒè·¯ç”±æ–¹æ¡ˆçš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼ˆä»¥ React Router v6 ä¸ºä¾‹ï¼‰ï¼š

---

### ğŸŒŸ **æ ¸å¿ƒç›‘å¬æ–¹æ¡ˆ**
#### 1. **ä½¿ç”¨ `useLocation` + `useEffect`ï¼ˆå‡½æ•°ç»„ä»¶æ¨èï¼‰**
```tsx
import { useEffect } from 'react'
import { useLocation } from 'react-router-dom'

function RouteListener() {
  const location = useLocation()

  useEffect(() => {
    // è·¯ç”±å˜åŒ–æ—¶è§¦å‘
    console.log('è·¯ç”±å˜åŒ–:', location.pathname, location.search)
  
    // æ‰§è¡ŒåŸ‹ç‚¹ä¸ŠæŠ¥
    trackPageView(location.pathname)
  
    // åŠ¨æ€ä¿®æ”¹æ ‡é¢˜
    document.title = getTitleByPath(location.pathname)
  }, [location]) // ä¾èµ– location å¯¹è±¡

  return null
}

// åœ¨æ ¹ç»„ä»¶ä¸­ä½¿ç”¨
<Router>
  <RouteListener />
  <App />
</Router>
```

#### 2. **ç±»ç»„ä»¶ä¸­é€šè¿‡ HOC åŒ…è£…**
```tsx
import { withRouter } from './withRouter' // è‡ªå®šä¹‰ HOC

class RouteTracker extends React.Component {
  componentDidUpdate(prevProps) {
    if (this.props.location !== prevProps.location) {
      console.log('è·¯ç”±å˜åŒ–:', this.props.location)
    }
  }

  render() {
    return null
  }
}

// ä½¿ç”¨è‡ªå®šä¹‰ withRouterï¼ˆReact Router v6 ä¸å†æä¾›å®˜æ–¹ HOCï¼‰
export function withRouter(Component) {
  return (props) => {
    const location = useLocation()
    return <Component {...props} location={location} />
  }
}

// ä½¿ç”¨
const EnhancedTracker = withRouter(RouteTracker)
```

---

### ğŸ” **ç›‘å¬ç‰¹å®šè·¯ç”±å˜åŒ–**
#### åœºæ™¯ï¼šå½“è¿›å…¥ `/admin` æ—¶æ£€æŸ¥æƒé™
```tsx
useEffect(() => {
  if (location.pathname.startsWith('/admin')) {
    checkAdminPermission().catch(() => navigate('/login'))
  }
}, [location.pathname])
```

---

### ğŸ“œ **History å¯¹è±¡ç›´æ¥ç›‘å¬ï¼ˆé€šç”¨æ–¹æ¡ˆï¼‰**
é€‚ç”¨äºé React Router åœºæ™¯æˆ–éœ€è¦æ›´åº•å±‚æ§åˆ¶çš„æƒ…å†µï¼š
```tsx
import { useEffect } from 'react'
import { useNavigate } from 'react-router-dom'

function HistoryListener() {
  const navigate = useNavigate()

  useEffect(() => {
    // ä¿å­˜åŸå§‹ pushState æ–¹æ³•
    const originalPushState = window.history.pushState

    // é‡å†™ pushState
    window.history.pushState = function (...args) {
      originalPushState.apply(window.history, args)
      console.log('è·¯ç”±å˜åŒ–ï¼ˆpushStateï¼‰:', window.location.href)
    }

    // ç›‘å¬ popstateï¼ˆæµè§ˆå™¨å‰è¿›/åé€€ï¼‰
    const handlePopState = () => {
      console.log('è·¯ç”±å˜åŒ–ï¼ˆpopstateï¼‰:', window.location.href)
    }

    window.addEventListener('popstate', handlePopState)

    return () => {
      window.history.pushState = originalPushState // æ¢å¤åŸæ–¹æ³•
      window.removeEventListener('popstate', handlePopState)
    }
  }, [])

  return null
}
```

---

### ğŸ›¡ï¸ **è·¯ç”±å®ˆå«å®ç°**
å°è£…é«˜é˜¶ç»„ä»¶å®ç°å…¨å±€è·¯ç”±æ‹¦æˆªï¼š
```tsx
function AuthRoute({ children }) {
  const location = useLocation()
  const [isAllowed, setIsAllowed] = useState(false)

  useEffect(() => {
    checkAuth(location.pathname).then(setIsAllowed)
  }, [location])

  return isAllowed ? children : <Loading />
}

// ä½¿ç”¨
<Route path="/dashboard" element={<AuthRoute><Dashboard /></AuthRoute>} />
```

---

### âš ï¸ **æ³¨æ„äº‹é¡¹**
1. **é¿å…æ— é™å¾ªç¯**ï¼š
   åœ¨è·¯ç”±ç›‘å¬å›è°ƒä¸­è°¨æ…ä½¿ç”¨ `navigate`ï¼Œéœ€æ·»åŠ æ¡ä»¶åˆ¤æ–­ï¼š
   ```tsx
   useEffect(() => {
     if (!isLogin && location.pathname !== '/login') {
       navigate('/login') // é¿å…é‡å¤è·³è½¬
     }
   }, [location])
   ```

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   å¯¹é«˜é¢‘æ“ä½œï¼ˆå¦‚æ»šåŠ¨æ¢å¤ï¼‰ä½¿ç”¨é˜²æŠ–ï¼š
   ```tsx
   import { debounce } from 'lodash'

   useEffect(() => {
     const handleScroll = debounce(() => {
       saveScrollPosition(location.key)
     }, 300)
   
     window.addEventListener('scroll', handleScroll)
     return () => window.removeEventListener('scroll', handleScroll)
   }, [location.key])
   ```

3. **SSR å…¼å®¹æ€§**ï¼š
   æœåŠ¡ç«¯æ¸²æŸ“æ—¶éœ€ç‰¹æ®Šå¤„ç† `window` å¯¹è±¡ï¼š
   ```tsx
   useEffect(() => {
     if (typeof window !== 'undefined') {
       // å®¢æˆ·ç«¯ä»£ç 
     }
   }, [])
   ```

---

### ğŸ”§ **è°ƒè¯•æŠ€å·§**
åœ¨å¼€å‘æ—¶æ‰“å°å®Œæ•´è·¯ç”±ä¿¡æ¯ï¼š
```tsx
useEffect(() => {
  console.log('è·¯ç”±å˜æ›´è¯¦æƒ…:', {
    pathname: location.pathname,
    search: location.search,
    hash: location.hash,
    state: location.state // å¯é€šè¿‡ navigate('/path', { state: { key: value } }) ä¼ é€’
  })
}, [location])
```

---

### ğŸŒ **å„ç‰ˆæœ¬ React Router å¯¹æ¯”**
| åŠŸèƒ½               | v5 åŠä¹‹å‰           | v6                   |
|--------------------|--------------------|----------------------|
| è·å–è·¯ç”±ä¿¡æ¯       | `withRouter` HOC   | `useLocation` hook   |
| ç¼–ç¨‹å¼å¯¼èˆª         | `useHistory`       | `useNavigate`        |
| ç›‘å¬æ‰€æœ‰è·¯ç”±å˜åŒ–   | ç›‘å¬ history å¯¹è±¡  | `useLocation` ä¾èµ–   |
| è·¯ç”±å®ˆå«           | è‡ªå®šä¹‰ `<Route>`   | `useLocation` + æ¡ä»¶ |

---

### ğŸ“Œ **æœ€ä½³å®è·µå»ºè®®**
1. **ä¼˜å…ˆä½¿ç”¨ React Router åŸç”Ÿ hooks**ï¼ˆv6 çš„ `useLocation`/`useNavigate`ï¼‰
2. **æ•æ„Ÿæ“ä½œæ”¾åœ¨æœ€å¤–å±‚è·¯ç”±ç›‘å¬**ï¼ˆå¦‚æƒé™æ ¡éªŒï¼‰
3. **å¯¹ç¬¬ä¸‰æ–¹è·¯ç”±åº“**ï¼ˆå¦‚ Next.jsï¼‰ï¼Œä½¿ç”¨å…¶æä¾›çš„è·¯ç”±äº‹ä»¶ï¼š
   ```tsx
   // Next.js ç¤ºä¾‹
   import { useRouter } from 'next/router'

   useEffect(() => {
     const handleRouteChange = (url) => {
       console.log('å¯¼èˆªè‡³:', url)
     }
     router.events.on('routeChangeComplete', handleRouteChange)
     return () => router.events.off('routeChangeComplete', handleRouteChange)
   }, [router])
   ```

4. **TypeScript ç±»å‹å¢å¼º**ï¼š
   ```tsx
   import { Location } from 'react-router-dom'

   declare module 'react-router-dom' {
     interface Location {
       from?: string // è‡ªå®šä¹‰æ‰©å±• state ç±»å‹
     }
   }
   ```

æ ¹æ®ä½ çš„å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆï¼Œé€šå¸¸ç»„åˆä½¿ç”¨ `useLocation` + `useEffect` å³å¯è¦†ç›–å¤§å¤šæ•°éœ€æ±‚ã€‚