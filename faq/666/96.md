## 96. HTTP æ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„åè®®ï¼Œé‚£ä¹ˆ Web åº”ç”¨è¦æ€ä¹ˆä¿æŒç”¨æˆ·çš„ç™»å½•æ€å‘¢ï¼Ÿ

HTTP æ˜¯ä¸€ä¸ªæ— çŠ¶æ€åè®®ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼ŒæœåŠ¡å™¨é»˜è®¤ä¸ä¼šè®°ä½ä¹‹å‰çš„è¯·æ±‚ä¿¡æ¯ã€‚ä¸ºäº†åœ¨ Web åº”ç”¨ä¸­ä¿æŒç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼ˆå³å®ç°â€œæœ‰çŠ¶æ€â€çš„ä¼šè¯ç®¡ç†ï¼‰ï¼Œé€šå¸¸éœ€è¦å€ŸåŠ©ä»¥ä¸‹æŠ€æœ¯æ‰‹æ®µï¼š

---

## **1. åŸºäº Cookie çš„ä¼šè¯ç®¡ç†**
### **åŸç†**
- æœåŠ¡å™¨åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåç”Ÿæˆä¸€ä¸ª **å”¯ä¸€ä¼šè¯æ ‡è¯†ç¬¦ï¼ˆSession IDï¼‰**ï¼Œå­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼ˆå¦‚å†…å­˜ã€Redisï¼‰ã€‚
- é€šè¿‡ `Set-Cookie` å“åº”å¤´å°†ä¼šè¯ ID å‘é€ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨åç»­è¯·æ±‚è‡ªåŠ¨æºå¸¦è¯¥ Cookieã€‚

### **å®ç°æ­¥éª¤**
1. **ç”¨æˆ·ç™»å½•**ï¼š
   ```typescript
   // æœåŠ¡å™¨ç”Ÿæˆ Session å¹¶è¿”å› Cookie
   app.post('/login', (req, res) => {
     const sessionId = generateSessionId();
     storeSession(sessionId, { userId: 123 }); // å­˜å‚¨åˆ° Redis
     res.setHeader('Set-Cookie', `sessionId=${sessionId}; Path=/; HttpOnly; Secure`);
     res.send('ç™»å½•æˆåŠŸ');
   });
   ```

2. **æµè§ˆå™¨è‡ªåŠ¨æºå¸¦ Cookie**ï¼š
   ```http
   GET /profile HTTP/1.1
   Cookie: sessionId=abc123
   ```

3. **æœåŠ¡å™¨éªŒè¯ Session**ï¼š
   ```typescript
   app.get('/profile', (req, res) => {
     const sessionId = req.cookies.sessionId;
     const session = getSession(sessionId); // ä» Redis è¯»å–
     if (!session) return res.status(401).send('æœªç™»å½•');
     res.send(`ç”¨æˆ·ID: ${session.userId}`);
   });
   ```

### **ä¼˜ç‚¹**
- ç®€å•æ˜“ç”¨ï¼Œå…¼å®¹æ€§å¥½ã€‚
- å¯é€šè¿‡ `HttpOnly` å’Œ `Secure` æå‡å®‰å…¨æ€§ã€‚

### **ç¼ºç‚¹**
- ä¾èµ–æµè§ˆå™¨ Cookieï¼Œå¯èƒ½å—è·¨åŸŸé™åˆ¶ã€‚
- æœåŠ¡å™¨éœ€ç»´æŠ¤ Session å­˜å‚¨ã€‚

---

## **2. åŸºäº Token çš„è®¤è¯ï¼ˆå¦‚ JWTï¼‰**
### **åŸç†**
- ç”¨æˆ·ç™»å½•åï¼ŒæœåŠ¡å™¨ç”Ÿæˆä¸€ä¸ª **ç­¾å Tokenï¼ˆå¦‚ JWTï¼‰** å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚
- å®¢æˆ·ç«¯åç»­è¯·æ±‚åœ¨ `Authorization` å¤´ä¸­æºå¸¦ Tokenï¼ŒæœåŠ¡å™¨ç›´æ¥éªŒè¯ Token æœ‰æ•ˆæ€§ã€‚

### **å®ç°æ­¥éª¤**
1. **ç”¨æˆ·ç™»å½•**ï¼š
   ```typescript
   // æœåŠ¡å™¨ç”Ÿæˆ JWT
   app.post('/login', (req, res) => {
     const token = jwt.sign({ userId: 123 }, 'secret-key', { expiresIn: '1h' });
     res.json({ token });
   });
   ```

2. **å®¢æˆ·ç«¯å­˜å‚¨ Token**ï¼ˆé€šå¸¸å­˜äº `localStorage` æˆ– `Cookie`ï¼‰ï¼š
   ```typescript
   // å‰ç«¯ä¿å­˜ Token
   localStorage.setItem('token', response.data.token);
   ```

3. **è¯·æ±‚æ—¶æºå¸¦ Token**ï¼š
   ```typescript
   // å‰ç«¯è¯·æ±‚
   axios.get('/profile', {
     headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
   });
   ```

4. **æœåŠ¡å™¨éªŒè¯ Token**ï¼š
   ```typescript
   app.get('/profile', (req, res) => {
     const token = req.headers.authorization?.split(' ')[1];
     try {
       const decoded = jwt.verify(token, 'secret-key');
       res.send(`ç”¨æˆ·ID: ${decoded.userId}`);
     } catch (err) {
       res.status(401).send('Token æ— æ•ˆ');
     }
   });
   ```

### **ä¼˜ç‚¹**
- æ— çŠ¶æ€ï¼ŒæœåŠ¡å™¨æ— éœ€å­˜å‚¨ä¼šè¯ã€‚
- é€‚åˆåˆ†å¸ƒå¼ç³»ç»Ÿæˆ–è·¨åŸŸåœºæ™¯ã€‚

### **ç¼ºç‚¹**
- Token ä¸€æ—¦ç­¾å‘æ— æ³•ç«‹å³æ’¤é”€ï¼ˆéœ€ç»“åˆé»‘åå•æˆ–çŸ­æœ‰æ•ˆæœŸï¼‰ã€‚
- éœ€é˜²èŒƒ XSS æ”»å‡»ï¼ˆé¿å… `localStorage` è¢«æ¶æ„è„šæœ¬è¯»å–ï¼‰ã€‚

---

## **3. ç»“åˆ Cookie å’Œ Token çš„æ··åˆæ¨¡å¼**
### **åœºæ™¯**
- ä¸ºäº†å…¼é¡¾å®‰å…¨æ€§å’Œä¾¿åˆ©æ€§ï¼Œå¯å°† JWT å­˜å‚¨åˆ° `HttpOnly Cookie` ä¸­ã€‚
- æœåŠ¡å™¨é€šè¿‡ Cookie è¯»å– Token å¹¶éªŒè¯ã€‚

### **ç¤ºä¾‹**
```typescript
// æœåŠ¡å™¨è®¾ç½® HttpOnly Cookie
res.setHeader('Set-Cookie', `token=${token}; Path=/; HttpOnly; Secure`);

// å‰ç«¯æ— éœ€æ‰‹åŠ¨å¤„ç† Tokenï¼Œæµè§ˆå™¨è‡ªåŠ¨æºå¸¦
```

---

## **4. å…¶ä»–å®‰å…¨æªæ–½**
| **æªæ–½**               | **ä½œç”¨**                                                                 |
|------------------------|-------------------------------------------------------------------------|
| **CSRF Token**         | é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆé…åˆ Cookie ä½¿ç”¨ï¼‰ã€‚                                    |
| **SameSite Cookie**    | é™åˆ¶ Cookie çš„è·¨ç«™å‘é€ï¼ˆ`SameSite=Lax/Strict`ï¼‰ã€‚                        |
| **çŸ­ Token æœ‰æ•ˆæœŸ**    | å‡å°‘ Token æ³„éœ²åçš„é£é™©ã€‚                                                |
| **å®šæœŸåˆ·æ–° Token**     | é€šè¿‡ Refresh Token æœºåˆ¶æ›´æ–° Access Tokenã€‚                               |

---

## **5. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**
### **é—®é¢˜ 1ï¼šå¦‚ä½•å®ç°â€œè®°ä½æˆ‘â€åŠŸèƒ½ï¼Ÿ**
- å»¶é•¿ Session æˆ– Token æœ‰æ•ˆæœŸï¼ˆå¦‚è®¾ç½® `expiresIn: '7d'`ï¼‰ã€‚
- ä½¿ç”¨ Refresh Token æœºåˆ¶ã€‚

### **é—®é¢˜ 2ï¼šå¦‚ä½•å¼ºåˆ¶ç”¨æˆ·é€€å‡ºï¼Ÿ**
- **Session æ–¹æ¡ˆ**ï¼šåˆ é™¤æœåŠ¡å™¨ç«¯ Sessionã€‚
- **JWT æ–¹æ¡ˆ**ï¼šç»´æŠ¤ Token é»‘åå•æˆ–ç¼©çŸ­æœ‰æ•ˆæœŸã€‚

### **é—®é¢˜ 3ï¼šè·¨åŸŸå¦‚ä½•ä¼ é€’è®¤è¯ä¿¡æ¯ï¼Ÿ**
- é…ç½® CORS å…è®¸ `credentials`ï¼š
  ```typescript
  // æœåŠ¡å™¨
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  res.setHeader('Access-Control-Allow-Origin', 'https://your-frontend.com');
  ```
- å‰ç«¯å¯ç”¨ `withCredentials`ï¼š
  ```typescript
  axios.get('https://api.com/data', { withCredentials: true });
  ```

---

## **æ€»ç»“**
| **æ–¹æ¡ˆ**          | **é€‚ç”¨åœºæ™¯**                     | **å…³é”®æŠ€æœ¯**                          |
|-------------------|--------------------------------|--------------------------------------|
| **Cookie + Session** | ä¼ ç»Ÿ Web åº”ç”¨                  | `Set-Cookie`, Redis å­˜å‚¨              |
| **JWT**           | å‰åç«¯åˆ†ç¦»ã€è·¨åŸŸã€åˆ†å¸ƒå¼ç³»ç»Ÿ     | `Authorization: Bearer <token>`       |
| **æ··åˆæ¨¡å¼**       | é«˜å®‰å…¨æ€§éœ€æ±‚                   | HttpOnly Cookie + JWT                 |

æ ¹æ®é¡¹ç›®éœ€æ±‚é€‰æ‹©åˆé€‚æ–¹æ¡ˆï¼Œå¹¶å§‹ç»ˆå…³æ³¨å®‰å…¨æ€§ï¼ ğŸ”’
**æç¤º**ï¼šå¯¹äºæ•æ„Ÿæ“ä½œï¼ˆå¦‚æ”¯ä»˜ï¼‰ï¼Œå»ºè®®ç»“åˆå¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰ã€‚