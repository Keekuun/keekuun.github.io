## 130. [Vue] 中为何不要把 v-if 和 v-for 同时用在同一个元素上，原理是什么？

在 Vue 中，**不建议将 `v-if` 和 `v-for` 同时用在同一个元素上**，主要原因与 Vue 的编译机制和性能优化有关。以下是详细的原理和解决方案：

---

### 1. **优先级问题**
- **`v-for` 的优先级高于 `v-if`**（Vue 2.x 中）。
  这意味着 Vue 会先执行 `v-for` 循环生成所有元素，然后再对每个元素应用 `v-if` 判断。
  **问题**：即使某些元素最终会被 `v-if` 过滤掉，它们仍然会被渲染到虚拟 DOM 中，造成不必要的性能开销。

#### 示例代码（不推荐）：
```vue
<template>
  <div>
    <!-- 先循环，再判断 -->
    <div v-for="item in list" v-if="item.isActive" :key="item.id">
      {{ item.name }}
    </div>
  </div>
</template>
```

---

### 2. **性能浪费**
- **每次渲染都会重新计算整个列表**，即使 `list` 中只有少量元素需要显示。
  如果 `list` 很大，`v-for` 会生成大量虚拟 DOM 节点，即使最终只有少数节点通过 `v-if` 显示。

---

### 3. **Vue 3.x 的变化**
- 在 Vue 3.x 中，**`v-if` 的优先级高于 `v-for`**。
  这意味着 `v-if` 会先执行，但这样会导致 `v-for` 的作用域变量在 `v-if` 中不可用，引发逻辑错误。
  **Vue 3 官方文档明确禁止这种用法**，并在控制台抛出警告。

---

### 4. **正确的解决方案**
#### (1) **使用计算属性过滤数据**
在数据层面提前过滤，避免渲染不必要的元素。

```vue
<template>
  <div>
    <!-- 直接循环过滤后的数据 -->
    <div v-for="item in activeItems" :key="item.id">
      {{ item.name }}
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      list: [
        { id: 1, name: 'Alice', isActive: true },
        { id: 2, name: 'Bob', isActive: false },
      ],
    };
  },
  computed: {
    activeItems() {
      return this.list.filter(item => item.isActive);
    },
  },
};
</script>
```

#### (2) **将 `v-if` 提升到外层**
通过嵌套的 `template` 或外层元素拆分逻辑。

```vue
<template>
  <div>
    <template v-for="item in list" :key="item.id">
      <div v-if="item.isActive">
        {{ item.name }}
      </div>
    </template>
  </div>
</template>
```

#### (3) **使用 `v-show`（如果只是显示/隐藏）**
`v-show` 不会销毁元素，而是通过 CSS 控制显示/隐藏，适合频繁切换的场景。

```vue
<template>
  <div>
    <div v-for="item in list" :key="item.id" v-show="item.isActive">
      {{ item.name }}
    </div>
  </div>
</template>
```

---

### 5. **底层原理**
- **Vue 2.x**：
    - 编译模板时，`v-for` 会生成渲染函数中的循环逻辑，`v-if` 会生成条件判断。
    - 由于 `v-for` 优先级更高，循环生成的虚拟 DOM 节点会先被创建，再被 `v-if` 过滤，导致冗余的虚拟 DOM 操作。

- **Vue 3.x**：
    - 如果同时使用 `v-if` 和 `v-for`，`v-if` 会先执行，但循环变量可能未定义，导致逻辑错误。
    - 直接禁止这种用法，强制开发者显式优化。

---

### 6. **总结**
| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 优先级冲突 | `v-for` 和 `v-if` 的优先级问题 | 使用计算属性过滤数据 |
| 性能浪费 | 生成不必要的虚拟 DOM 节点 | 将 `v-if` 提升到外层 |
| 逻辑错误（Vue 3） | `v-if` 中无法访问循环变量 | 避免同时使用 |

**最佳实践**：
- **优先用计算属性过滤数据**，减少不必要的渲染。
- **避免在同一个元素上混用 `v-if` 和 `v-for`**，保持代码清晰和性能高效。

通过合理的设计，可以显著提升 Vue 应用的性能！ 🚀