## 132. SPA é¦–å±åŠ è½½é€Ÿåº¦æ…¢æ€ä¹ˆè§£å†³

SPAï¼ˆå•é¡µåº”ç”¨ï¼‰çš„é¦–å±åŠ è½½é€Ÿåº¦æ…¢æ˜¯ä¸€ä¸ªå¸¸è§é—®é¢˜ï¼Œä¸»è¦åŸå› åŒ…æ‹¬ **èµ„æºä½“ç§¯è¿‡å¤§**ã€**ç½‘ç»œè¯·æ±‚è¿‡å¤š**ã€**æ¸²æŸ“é˜»å¡** ç­‰ã€‚ä»¥ä¸‹æ˜¯ç³»ç»ŸåŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œæ¶µç›– **ä»£ç ä¼˜åŒ–**ã€**ç½‘ç»œä¼˜åŒ–** å’Œ **æ¸²æŸ“ä¼˜åŒ–** ç­‰å¤šä¸ªç»´åº¦ï¼š

---

## ğŸŒŸ **æ ¸å¿ƒä¼˜åŒ–æ–¹å‘**
| **é—®é¢˜ç±»å‹**       | **ä¼˜åŒ–æ‰‹æ®µ**                          | **æ•ˆæœé¢„ä¼°**               |
|--------------------|-------------------------------------|---------------------------|
| **èµ„æºä½“ç§¯è¿‡å¤§**   | ä»£ç åˆ†å‰² + å‹ç¼©                      | å‡å°‘ 30%~50% ä½“ç§¯         |
| **ç½‘ç»œè¯·æ±‚è¿‡å¤š**   | HTTP/2 + èµ„æºé¢„åŠ è½½                  | å‡å°‘ 40%+ è¯·æ±‚æ—¶é—´         |
| **æ¸²æŸ“é˜»å¡**       | éª¨æ¶å± + æœåŠ¡ç«¯æ¸²æŸ“ (SSR)            | æå‡ç”¨æˆ·æ„ŸçŸ¥é€Ÿåº¦ 50%+      |
| **ç¬¬ä¸‰æ–¹åº“è‡ƒè‚¿**   | æŒ‰éœ€å¼•å…¥ + æ›¿æ¢è½»é‡åº“                | å‡å°‘ 20%~30% ä»£ç           |

---

## ğŸ›  **å…·ä½“ä¼˜åŒ–æ–¹æ¡ˆ**

### ğŸ“Œ **1. ä»£ç ä½“ç§¯ä¼˜åŒ–**
#### âœ… **ä»£ç åˆ†å‰²ï¼ˆCode Splittingï¼‰**
é€šè¿‡åŠ¨æ€å¯¼å…¥ï¼ˆDynamic Importï¼‰æ‹†åˆ†ä»£ç ï¼ŒæŒ‰éœ€åŠ è½½è·¯ç”±ç»„ä»¶ï¼š
```typescript
// React ç¤ºä¾‹ï¼ˆä½¿ç”¨ React.lazyï¼‰
const Home = React.lazy(() => import('./Home'));
const About = React.lazy(() => import('./About'));

function App() {
  return (
    <Suspense fallback={<LoadingSpinner />}>
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="/about" element={<About />} />
      </Routes>
    </Suspense>
  );
}
```
**å·¥å…·æ”¯æŒ**ï¼š
- Webpack çš„ `SplitChunksPlugin` è‡ªåŠ¨æ‹†åˆ†å…¬å…±ä¾èµ–ã€‚
- ä½¿ç”¨ `@loadable/component` æ›´ç²¾ç»†æ§åˆ¶åŠ è½½ï¼ˆæ”¯æŒ SSRï¼‰ã€‚

---

#### âœ… **Tree Shaking**
ç§»é™¤æœªä½¿ç”¨çš„ä»£ç ï¼ˆå¯¹ ESM æ¨¡å—æœ‰æ•ˆï¼‰ï¼š
```javascript
// webpack.config.js
module.exports = {
  optimization: {
    usedExports: true, // æ ‡è®°æœªä½¿ç”¨ä»£ç 
    minimize: true,   // å¯ç”¨ TerserPlugin åˆ é™¤æ­»ä»£ç 
  }
};
```
**æ³¨æ„**ï¼šç¡®ä¿ `package.json` ä¸­è®¾ç½® `"sideEffects": false`ã€‚

---

#### âœ… **å‹ç¼©èµ„æº**
- **JavaScript**ï¼š`TerserPlugin`
- **CSS**ï¼š`CssMinimizerPlugin`
- **HTML**ï¼š`HtmlWebpackPlugin` çš„ `minify` é€‰é¡¹
- **å›¾ç‰‡**ï¼š`image-webpack-loader`ï¼ˆè‡ªåŠ¨å‹ç¼© PNG/JPEGï¼‰

```javascript
// å›¾ç‰‡å‹ç¼©ç¤ºä¾‹
rules: [
  {
    test: /\.(png|jpe?g)$/,
    use: [
      'file-loader',
      {
        loader: 'image-webpack-loader',
        options: {
          mozjpeg: { quality: 60 }, // JPEG è´¨é‡ 60%
        },
      },
    ],
  },
]
```

---

### ğŸ“Œ **2. ç½‘ç»œä¼˜åŒ–**
#### âœ… **å¯ç”¨ HTTP/2**
- æœåŠ¡å™¨é…ç½® HTTP/2ï¼ˆå¦‚ Nginx çš„ `listen 443 http2`ï¼‰ã€‚
- åˆ©ç”¨å¤šè·¯å¤ç”¨å‡å°‘è¯·æ±‚å»¶è¿Ÿã€‚

---

#### âœ… **èµ„æºé¢„åŠ è½½**
ä½¿ç”¨ `<link rel="preload">` æå‰åŠ è½½å…³é”®èµ„æºï¼š
```html
<!-- é¢„åŠ è½½å…³é”® CSS/JS -->
<link rel="preload" href="critical.css" as="style" />
<link rel="preload" href="main.js" as="script" />
```
**è‡ªåŠ¨åŒ–å·¥å…·**ï¼š
- `preload-webpack-plugin` è‡ªåŠ¨ç”Ÿæˆé¢„åŠ è½½æ ‡ç­¾ã€‚

---

#### âœ… **CDN åŠ é€Ÿ**
- å°†é™æ€èµ„æºï¼ˆå¦‚ JS/CSS/å›¾ç‰‡ï¼‰æ‰˜ç®¡åˆ° CDNã€‚
- ç¬¬ä¸‰æ–¹åº“é€šè¿‡ CDN å¼•å…¥ï¼ˆå¦‚ `unpkg.com`ï¼‰ã€‚

---

### ğŸ“Œ **3. æ¸²æŸ“ä¼˜åŒ–**
#### âœ… **éª¨æ¶å±ï¼ˆSkeleton Screenï¼‰**
åœ¨å†…å®¹åŠ è½½å‰å±•ç¤ºå ä½å›¾ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼š
```tsx
// éª¨æ¶å±ç»„ä»¶ç¤ºä¾‹
const Skeleton = () => (
  <div className="skeleton">
    <div className="skeleton-header" />
    <div className="skeleton-body" />
  </div>
);

// ä½¿ç”¨
<Suspense fallback={<Skeleton />}>
  <LazyComponent />
</Suspense>
```
**å·¥å…·æ¨è**ï¼š`react-loading-skeleton`ã€‚

---

#### âœ… **æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰**
é€šè¿‡ Next.js æˆ–è‡ªå®šä¹‰ SSR æ–¹æ¡ˆç›´å‡º HTMLï¼š
```javascript
// Next.js ç¤ºä¾‹ï¼ˆé»˜è®¤æ”¯æŒ SSRï¼‰
export async function getServerSideProps() {
  const data = await fetchAPI();
  return { props: { data } };
}

function Page({ data }) {
  return <div>{data}</div>;
}
```
**ä¼˜åŠ¿**ï¼šé¦–å±ç›´æ¥æ¸²æŸ“ï¼Œæ— éœ€ç­‰å¾…å®¢æˆ·ç«¯ JS æ‰§è¡Œã€‚

---

### ğŸ“Œ **4. ç¬¬ä¸‰æ–¹åº“ä¼˜åŒ–**
#### âœ… **æŒ‰éœ€å¼•å…¥**
- **Ant Design**ï¼š`babel-plugin-import`
  ```javascript
  // .babelrc
  plugins: [
    ['import', { libraryName: 'antd', style: 'css' }]
  ]
  ```
- **Lodash**ï¼šç›´æ¥å¼•å…¥å•å‡½æ•°
  ```javascript
  import debounce from 'lodash/debounce'; // è€Œéæ•´ä¸ª lodash
  ```

---

#### âœ… **æ›¿æ¢è½»é‡åº“**
| **åŸåº“**       | **æ›¿ä»£æ–¹æ¡ˆ**       | **ä½“ç§¯å‡å°‘** |
|----------------|-------------------|-------------|
| `Moment.js`    | `date-fns`        | 80%+        |
| `Lodash`       | `lodash-es`       | 50%+        |
| `Axios`        | `Fetch API`       | 100%        |

---

### ğŸ“Œ **5. ç›‘æ§ä¸åˆ†æ**
#### âœ… **æ€§èƒ½åˆ†æå·¥å…·**
- **Lighthouse**ï¼šç»¼åˆè¯„åˆ†ä¸ä¼˜åŒ–å»ºè®®ã€‚
- **Webpack Bundle Analyzer**ï¼šå¯è§†åŒ–åˆ†æåŒ…ä½“ç§¯ã€‚
  ```bash
  npx webpack --profile --json > stats.json
  npx webpack-bundle-analyzer stats.json
  ```

---

#### âœ… **æ€§èƒ½ç›‘æ§**
- **CLSï¼ˆå¸ƒå±€åç§»ï¼‰**ï¼šä½¿ç”¨ `web-vitals` åº“ç›‘æ§ã€‚
- **FP/FCPï¼ˆé¦–æ¬¡æ¸²æŸ“ï¼‰**ï¼šé€šè¿‡ `PerformanceObserver` ä¸ŠæŠ¥ã€‚

```typescript
import { getCLS, getFID, getFCP } from 'web-vitals';

getCLS(console.log); // ç›‘æ§å¸ƒå±€åç§»
```

---

## ğŸ¯ **ä¼˜åŒ–æ•ˆæœå¯¹æ¯”**
| **ä¼˜åŒ–å‰**       | **ä¼˜åŒ–å**         | **æå‡å¹…åº¦** |
|------------------|-------------------|-------------|
| 4MB JS æ–‡ä»¶      | 1.5MBï¼ˆGzip åï¼‰  | 60%+        |
| 10+ ç½‘ç»œè¯·æ±‚     | 4~5 ä¸ªï¼ˆHTTP/2ï¼‰  | 50%+        |
| 3s é¦–å±æ¸²æŸ“      | 1s å†…ï¼ˆSSRï¼‰      | 70%+        |

---

## ğŸ“¦ **å®æˆ˜é…ç½®ç¤ºä¾‹**
### **Webpack ç”Ÿäº§é…ç½®**
```javascript
// webpack.prod.js
const CssMinimizerPlugin = require('css-minimizer-webpack-plugin');
const TerserPlugin = require('terser-webpack-plugin');

module.exports = {
  optimization: {
    minimizer: [
      new TerserPlugin(),
      new CssMinimizerPlugin(),
    ],
    splitChunks: {
      chunks: 'all', // è‡ªåŠ¨æ‹†åˆ† node_modules
    },
  },
  plugins: [
    new PreloadWebpackPlugin({
      rel: 'preload',
      include: 'initial',
    }),
  ],
};
```

### **Nginx é…ç½®ï¼ˆGzip + HTTP/2ï¼‰**
```nginx
server {
  listen 443 ssl http2;
  gzip on;
  gzip_types text/css application/javascript;
}
```

---

## ğŸš€ **æ€»ç»“**
é€šè¿‡ **ä»£ç åˆ†å‰²**ã€**èµ„æºå‹ç¼©**ã€**é¢„åŠ è½½** å’Œ **æ¸²æŸ“ä¼˜åŒ–** ç­‰ç»„åˆç­–ç•¥ï¼ŒSPA é¦–å±åŠ è½½é€Ÿåº¦å¯æ˜¾è‘—æå‡ã€‚å…³é”®æ­¥éª¤ï¼š
1. **åˆ†æç“¶é¢ˆ**ï¼šç”¨ Lighthouse å®šä½é—®é¢˜ã€‚
2. **æ¸è¿›ä¼˜åŒ–**ï¼šä»ä»£ç ä½“ç§¯åˆ°ç½‘ç»œå±‚é€çº§ä¼˜åŒ–ã€‚
3. **æŒç»­ç›‘æ§**ï¼šä¸Šçº¿åè·Ÿè¸ªæ ¸å¿ƒæŒ‡æ ‡ï¼ˆå¦‚ FCPï¼‰ã€‚

> ğŸ’¡ **ç»ˆææ–¹æ¡ˆ**ï¼šå¯¹äºæè‡´æ€§èƒ½è¦æ±‚ï¼Œè€ƒè™‘ SSR æˆ–é™æ€ç”Ÿæˆï¼ˆå¦‚ Next.jsï¼‰ã€‚