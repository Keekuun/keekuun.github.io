(window.webpackJsonp=window.webpackJsonp||[]).push([[170],{875:function(t,s,n){"use strict";n.r(s);var a=n(2),e=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p"),s("div",{staticClass:"table-of-contents"},[s("ul")]),s("p"),t._v(" "),s("h1",{attrs:{id:"_1-项目背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-项目背景"}},[t._v("🌙")]),t._v(" 1.项目背景")]),t._v(" "),s("ul",[s("li",[t._v("node: 16.6")]),t._v(" "),s("li",[t._v("nuxt: 2.15.8")]),t._v(" "),s("li",[t._v("axios: 0.18.0")])]),t._v(" "),s("p",[t._v("项目是一个基于nuxt2的SSR项目，本地run正常，线上部署报错")]),t._v(" "),s("h1",{attrs:{id:"_2-问题描述"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-问题描述"}},[t._v("🌙")]),t._v(" 2.问题描述")]),t._v(" "),s("p",[t._v("报错console：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("cross-env NODE_ENV=production node server/index.js\n....\nCannot stringify a function httpAdapter\nCannot stringify a function transform Request\nCannot stringify a function transform Request\nCannot stringify a function validateStatus\nCannot stringify arbitrary no-POJOs Writable\n\nERROR Maximum call stack size exceeded\n\nat String.replace(<annoymous>)\nat stringfyPrimitive(node_modules/@nuxt/devalue/dist/devalue.js 193:16)\nat stringfy(node_modules/@nuxt/devalue/dist/devalue.js 80:14)\nat node_modules/@nuxt/devalue/dist/devalue.js 116:71\n...\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br")])]),s("h1",{attrs:{id:"_3-排查过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-排查过程"}},[t._v("🌙")]),t._v(" 3.排查过程")]),t._v(" "),s("ul",[s("li",[t._v("1.注意到"),s("code",[t._v("ERROR Maximum call stack size exceeded")]),t._v(",因为本地build跑起来没问题，误认为是生产环境node运行内存不够导致的\n使用 "),s("code",[t._v("process.memoryUsage()")]),t._v("查看运行内存，打算使用"),s("a",{attrs:{href:"https://nodejs.cn/api/cli/max_old_space_size_size_in_megabytes.html",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("node --max-old-space-size=10240 index.js")]),s("OutboundLink")],1),t._v(" 来增加运行内存解决问题。")])]),t._v(" "),s("p",[t._v("显然，这个方式无法解决问题，就算临时可以解决，服务能运行一段时间，最终还是会爆栈。")]),t._v(" "),s("ul",[s("li",[t._v("2.继续查看报错日记：")])]),t._v(" "),s("p",[s("code",[t._v("Cannot stringify a function httpAdapter")]),t._v("这个应该是罪魁祸首，报错的地方"),s("code",[t._v("at stringfyPrimitive(node_modules/@nuxt/devalue/dist/devalue.js 193:16)")]),t._v("，\n但是我们仍然没法判断是什么引发的，只能初步判断与http请求相关，发现axios封装代码：")]),t._v(" "),s("blockquote",[s("p",[t._v("由于是接手的项目，这些代码一般都不会主动去做修改~~")])]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("request")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" extendsOptions")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("axios")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" option"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" extendsOptions"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" data\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("catch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 此处直接reject,没有错误记录（坑）")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Promise"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reject")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("p",[t._v("加一些console")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("request")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" extendsOptions")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("axios")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" option"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" extendsOptions"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" data\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("catch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 先打印，简单排查")]),t._v("\n        console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'axios error：'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Promise"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reject")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br")])]),s("p",[t._v("再次部署上去，获取到了关键的日志：")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("axios error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" write EPROTO 139888620882736"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("1408F10B"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("SSL routines"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("ssl3_get_record"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("wrong version number"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("../deps/openssl/openssl/ssl/record/ssl3_record.c"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("331")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("h1",{attrs:{id:"_4-问题原因"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-问题原因"}},[t._v("🌙")]),t._v(" 4.问题原因")]),t._v(" "),s("ul",[s("li",[t._v("1.由于后端有接口没有支持"),s("code",[t._v("https")]),t._v(",而项目"),s("code",[t._v("baseurl")]),t._v("配置的是"),s("code",[t._v("https")]),t._v(",就造成了这个问题。")]),t._v(" "),s("li",[t._v("2.axios报错信息未做日志记录，项目虽然接入了sentry,但是这里的错误信息并没有捕获到")]),t._v(" "),s("li",[t._v("3.axios的这个错误导致了nuxt服务的崩溃，"),s("code",[t._v("@nuxt/devalue")]),t._v("健壮性。。。")])]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("try catch")]),t._v("和"),s("code",[t._v("window.onerror")]),t._v("是无法捕捉"),s("code",[t._v("Promise")]),t._v("错误的（因为是异步）\n而当 "),s("code",[t._v("Promise")]),t._v(" 被 "),s("code",[t._v("reject")]),t._v(" 且没有 "),s("code",[t._v("reject")]),t._v(" 处理器的时候，会触发 "),s("code",[t._v("unhandledrejection")]),t._v(" 事件\n当 "),s("code",[t._v("Promise")]),t._v(" 被 "),s("code",[t._v("reject")]),t._v(" 且有 "),s("code",[t._v("reject")]),t._v(" 处理器的时候，会触发 "),s("code",[t._v("rejectionhandled")]),t._v(" 事件。\nSentry这边只收集没有被reject的错误即"),s("code",[t._v("window.unhandledrejection")])])]),t._v(" "),s("h1",{attrs:{id:"_5-按图索骥"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-按图索骥"}},[t._v("🌙")]),t._v(" 5.按图索骥")]),t._v(" "),s("p",[t._v("虽然"),s("code",[t._v("axios")]),t._v("报错了，但是使用"),s("code",[t._v("catch")]),t._v("去捕获了错误，那么按理说"),s("code",[t._v("node")]),t._v("服务应该成功运行啊，为什么会爆栈呢？")]),t._v(" "),s("p",[t._v("于是，去github查看nuxt的"),s("a",{attrs:{href:"https://github.com/nuxt/nuxt/issues?q=httpadapter",target:"_blank",rel:"noopener noreferrer"}},[t._v("httpadapter"),s("OutboundLink")],1),t._v(" 相关issue还很多，着实惊出一身冷汗！")]),t._v(" "),s("p",[t._v("最后在这个issue"),s("a",{attrs:{href:"https://github.com/nuxt/nuxt/issues/1842",target:"_blank",rel:"noopener noreferrer"}},[t._v("nuxt.js+axios SSR Parse Error"),s("OutboundLink")],1),t._v(" 看到官方的建议：")]),t._v(" "),s("blockquote",[s("p",[t._v("We highly recommend to use "),s("a",{attrs:{href:"https://github.com/nuxt-community/axios-module",target:"_blank",rel:"noopener noreferrer"}},[t._v("axios official nuxt module"),s("OutboundLink")],1),t._v(" since it prevents some security issue when working with session.\nAlso, from your error, your API is sending back to you the HPE_INVALID_HEADER_TOKEN error.")])]),t._v(" "),s("h1",{attrs:{id:"_6-最佳实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-最佳实践"}},[t._v("🌙")]),t._v(" 6.最佳实践")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("axios")]),t._v("报错日志补充")]),t._v(" "),s("li",[t._v("*sentry监控错误,是否需要主动上报")]),t._v(" "),s("li",[s("strong",[t._v("使用官方nuxt axios替换")]),s("a",{attrs:{href:"https://github.com/nuxt-community/axios-module",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/nuxt-community/axios-module"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);