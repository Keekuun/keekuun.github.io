(window.webpackJsonp=window.webpackJsonp||[]).push([[141],{845:function(t,s,n){"use strict";n.r(s);var a=n(2),e=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"nodejs之stream模块学习笔记"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nodejs之stream模块学习笔记"}},[t._v("🌙")]),t._v(" NodeJS之stream模块学习笔记")]),t._v(" "),s("h2",{attrs:{id:"_1-stream-流-模块简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-stream-流-模块简介"}},[t._v("🌙")]),t._v(" 1.stream（流）模块简介")]),t._v(" "),s("p",[t._v("流（stream）是 Node.js 中处理流式数据的抽象接口。 "),s("code",[t._v("stream")]),t._v(" 模块用于构建实现了流接口的对象。")]),t._v(" "),s("p",[t._v("Node.js 提供了多种流对象。 例如，"),s("a",{attrs:{href:"http://nodejs.cn/s/2RqpEw",target:"_blank",rel:"noopener noreferrer"}},[t._v("HTTP 服务器的请求"),s("OutboundLink")],1),t._v("和 "),s("a",{attrs:{href:"http://nodejs.cn/s/tQWUzG",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("process.stdout")]),s("OutboundLink")],1),t._v(" 都是流的实例。")]),t._v(" "),s("p",[t._v("流可以是可读的、可写的、或者可读可写的。 所有的流都是 "),s("a",{attrs:{href:"http://nodejs.cn/s/pGAddE",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("EventEmitter")]),s("OutboundLink")],1),t._v(" 的实例。")]),t._v(" "),s("p",[t._v("访问 "),s("code",[t._v("stream")]),t._v(" 模块：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" stream "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("尽管理解流的工作方式很重要，但是 "),s("code",[t._v("stream")]),t._v(" 模块主要用于开发者创建新类型的流实例。 对于以消费流对象为主的开发者，极少需要直接使用 "),s("code",[t._v("stream")]),t._v(" 模块。")]),t._v(" "),s("h2",{attrs:{id:"_2-流的类型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-流的类型"}},[t._v("🌙")]),t._v(" 2. 流的类型")]),t._v(" "),s("p",[t._v("Node.js 中有四种基本的流类型：")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Writable")]),s("OutboundLink")],1),t._v(" - 可写入数据的流（例如 "),s("a",{attrs:{href:"http://nodejs.cn/s/VdSJQa",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("fs.createWriteStream()")]),s("OutboundLink")],1),t._v("）。")]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/YuDKX1",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Readable")]),s("OutboundLink")],1),t._v(" - 可读取数据的流（例如 "),s("a",{attrs:{href:"http://nodejs.cn/s/wiVPXD",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("fs.createReadStream()")]),s("OutboundLink")],1),t._v("）。")]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/2iRabr",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Duplex")]),s("OutboundLink")],1),t._v(" - 可读又可写的流（例如 "),s("a",{attrs:{href:"http://nodejs.cn/s/wsJ1o1",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("net.Socket")]),s("OutboundLink")],1),t._v("）。")]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/fhVJQM",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Transform")]),s("OutboundLink")],1),t._v(" - 在读写过程中可以修改或转换数据的 "),s("code",[t._v("Duplex")]),t._v(" 流（例如 "),s("a",{attrs:{href:"http://nodejs.cn/s/n6ED45",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("zlib.createDeflate()")]),s("OutboundLink")],1),t._v("）。")])]),t._v(" "),s("p",[t._v("此外，该模块还包括实用函数 "),s("a",{attrs:{href:"http://nodejs.cn/s/kGvtzK",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.pipeline()")]),s("OutboundLink")],1),t._v("、"),s("a",{attrs:{href:"http://nodejs.cn/s/DjDduq",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.finished()")]),s("OutboundLink")],1),t._v(" 和 "),s("a",{attrs:{href:"http://nodejs.cn/s/bSCxhZ",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.Readable.from()")]),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"_3-可写流-stream-writable"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-可写流-stream-writable"}},[t._v("🌙")]),t._v(" 3.可写流 "),s("code",[t._v("stream.Writable")])]),t._v(" "),s("p",[t._v("可写流是对数据要被写入的目的地的一种抽象。")]),t._v(" "),s("p",[t._v("可写流的例子包括：")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/2F5RHd",target:"_blank",rel:"noopener noreferrer"}},[t._v("客户端的 HTTP 请求"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/rMXoZ1",target:"_blank",rel:"noopener noreferrer"}},[t._v("服务器的 HTTP 响应"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/2uZDVA",target:"_blank",rel:"noopener noreferrer"}},[t._v("fs 的写入流"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/duYbh2",target:"_blank",rel:"noopener noreferrer"}},[t._v("zlib 流"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/FuEfsg",target:"_blank",rel:"noopener noreferrer"}},[t._v("crypto 流"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/wsJ1o1",target:"_blank",rel:"noopener noreferrer"}},[t._v("TCP socket"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/Su8gEr",target:"_blank",rel:"noopener noreferrer"}},[t._v("子进程 stdin"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/tQWUzG",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("process.stdout")]),s("OutboundLink")],1),t._v("、"),s("a",{attrs:{href:"http://nodejs.cn/s/wPv5zY",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("process.stderr")]),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("上面的一些例子事实上是实现了可写流接口的 "),s("a",{attrs:{href:"http://nodejs.cn/s/2iRabr",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Duplex")]),s("OutboundLink")],1),t._v(" 流。")]),t._v(" "),s("p",[t._v("所有可写流都实现了 "),s("code",[t._v("stream.Writable")]),t._v(" 类定义的接口。")]),t._v(" "),s("p",[t._v("尽管可写流的具体实例可能略有差别，但所有的可写流都遵循同一基本的使用模式，如以下例子所示：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" myStream "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getWritableStreamSomehow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nmyStream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'一些数据'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nmyStream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'更多数据'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nmyStream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'完成写入数据'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("h3",{attrs:{id:"_3-1-stream-writable-事件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-stream-writable-事件"}},[t._v("🌙")]),t._v(" 3.1 "),s("code",[t._v("stream.Writable")]),t._v(" 事件")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("事件名称")]),t._v(" "),s("th",[t._v("说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[s("code",[t._v("close")])]),t._v(" "),s("td",[t._v("当流或其底层资源（比如文件描述符）被关闭时触发。 表明不会再触发其他事件，也不会再发生操作。如果使用 "),s("code",[t._v("emitClose")]),t._v(" 选项创建"),s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[t._v("可写流"),s("OutboundLink")],1),t._v("，则它将会始终发出 "),s("code",[t._v("'close'")]),t._v(" 事件。")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("drain")])]),t._v(" "),s("td",[t._v("如果调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/doppiK",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.write(chunk)")]),s("OutboundLink")],1),t._v(" 返回 "),s("code",[t._v("false")]),t._v("，则当可以继续写入数据到流时会触发 "),s("code",[t._v("'drain'")]),t._v(" 事件。")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("error")])]),t._v(" "),s("td",[t._v("如果在写入或管道数据时发生错误，则会触发 "),s("code",[t._v("'error'")]),t._v(" 事件。 当调用时，监听器回调会传入一个 "),s("code",[t._v("Error")]),t._v(" 参数。除非在创建流时将 "),s("a",{attrs:{href:"http://nodejs.cn/s/u7KYa2",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("autoDestroy")]),s("OutboundLink")],1),t._v(" 选项设置为 "),s("code",[t._v("false")]),t._v("，否则在触发 "),s("code",[t._v("'error'")]),t._v(" 事件时流会被关闭。在 "),s("code",[t._v("'error'")]),t._v(" 之后，除 "),s("code",[t._v("'close'")]),t._v(" 事件外，不应再触发其他事件（包括 "),s("code",[t._v("'error'")]),t._v(" 事件）。")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("finish")])]),t._v(" "),s("td",[t._v("调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/nvArK4",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.end()")]),s("OutboundLink")],1),t._v(" 且缓冲数据都已传给底层系统之后触发。")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("pipe")])]),t._v(" "),s("td",[t._v("当在可读流上调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/Ea2ZNW",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.pipe()")]),s("OutboundLink")],1),t._v(" 方法时会发出 "),s("code",[t._v("'pipe'")]),t._v(" 事件，并将此可写流添加到其目标集。")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("unpipe")])]),t._v(" "),s("td",[t._v("在可读流上调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/35GqHX",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.unpipe()")]),s("OutboundLink")],1),t._v(" 方法时会发出 "),s("code",[t._v("'unpipe'")]),t._v("事件，从其目标集中移除此可写流。当可读流通过管道流向可写流发生错误时，也会触发此事件。")])])])]),t._v(" "),s("h3",{attrs:{id:"_3-2-stream-writable方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-stream-writable方法"}},[t._v("🌙")]),t._v(" 3.2 "),s("code",[t._v("stream.Writable")]),t._v("方法")]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("writable.cork()")]),t._v("：强制把所有写入的数据都缓冲到内存中。 当调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/2Bzt8L",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.uncork()")]),s("OutboundLink")],1),t._v(" 或 "),s("a",{attrs:{href:"http://nodejs.cn/s/nvArK4",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.end()")]),s("OutboundLink")],1),t._v(" 方法时，缓冲的数据才会被输出。")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("writable.destroy([error])")]),t._v("：销毁流。 可选地触发 "),s("code",[t._v("error")]),t._v("，并且触发 "),s("code",[t._v("'close'")]),t._v(" 事件（除非将 "),s("code",[t._v("emitClose")]),t._v(" 设置为 "),s("code",[t._v("false")]),t._v("）。")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("error")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/qZ873x",target:"_blank",rel:"noopener noreferrer"}},[t._v("Error"),s("OutboundLink")],1),t._v(" 可选，使用 "),s("code",[t._v("'error'")]),t._v(" 事件触发的错误。")]),t._v(" "),s("li",[t._v("返回: "),s("a",{attrs:{href:"http://nodejs.cn/s/v7Fsu2",target:"_blank",rel:"noopener noreferrer"}},[t._v("this"),s("OutboundLink")],1)])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("writable.destroyed")]),t._v(" : boolean 在调用了 "),s("a",{attrs:{href:"http://nodejs.cn/s/tLkQ7J",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("writable.destroy()")]),s("OutboundLink")],1),t._v(" 之后为 "),s("code",[t._v("true")]),t._v("。")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("writable.end([chunk[, encoding]][, callback])")]),t._v(":调用 "),s("code",[t._v("writable.end()")]),t._v(" 表明已没有数据要被写入"),s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[t._v("可写流"),s("OutboundLink")],1),t._v("。 可选的 "),s("code",[t._v("chunk")]),t._v(" 和 "),s("code",[t._v("encoding")]),t._v(" 参数可以在关闭流之前再写入一块数据。 如果传入了 "),s("code",[t._v("callback")]),t._v(" 函数，则会做为监听器添加到 "),s("a",{attrs:{href:"http://nodejs.cn/s/VBJRc8",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("'finish'")]),s("OutboundLink")],1),t._v(" 事件和 "),s("code",[t._v("'error'")]),t._v(" 事件。")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("chunk")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/9Tw2bK",target:"_blank",rel:"noopener noreferrer"}},[t._v("string"),s("OutboundLink")],1),t._v(" | "),s("a",{attrs:{href:"http://nodejs.cn/s/6x1hD3",target:"_blank",rel:"noopener noreferrer"}},[t._v("Buffer"),s("OutboundLink")],1),t._v(" | "),s("a",{attrs:{href:"http://nodejs.cn/s/ZbDkpm",target:"_blank",rel:"noopener noreferrer"}},[t._v("Uint8Array"),s("OutboundLink")],1),t._v(" | "),s("a",{attrs:{href:"http://nodejs.cn/s/6sTGdS",target:"_blank",rel:"noopener noreferrer"}},[t._v("any"),s("OutboundLink")],1),t._v(" 要写入的数据。 对于非对象模式的流， "),s("code",[t._v("chunk")]),t._v(" 必须是字符串、 "),s("code",[t._v("Buffer")]),t._v("、或 "),s("code",[t._v("Uint8Array")]),t._v("。 对于对象模式的流， "),s("code",[t._v("chunk")]),t._v(" 可以是任何 JavaScript 值，除了 "),s("code",[t._v("null")]),t._v("。")]),t._v(" "),s("li",[s("code",[t._v("encoding")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/9Tw2bK",target:"_blank",rel:"noopener noreferrer"}},[t._v("string"),s("OutboundLink")],1),t._v(" 如果 "),s("code",[t._v("chunk")]),t._v(" 是字符串，则指定字符编码。")]),t._v(" "),s("li",[s("code",[t._v("callback")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/ceTQa6",target:"_blank",rel:"noopener noreferrer"}},[t._v("function"),s("OutboundLink")],1),t._v(" 当流结束或报错时的回调函数。")]),t._v(" "),s("li",[t._v("返回: "),s("a",{attrs:{href:"http://nodejs.cn/s/v7Fsu2",target:"_blank",rel:"noopener noreferrer"}},[t._v("this"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/nvArK4",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.end()")]),s("OutboundLink")],1),t._v(" 之后再调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/doppiK",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.write()")]),s("OutboundLink")],1),t._v(" 会导致错误。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 先写入 'hello, '，结束前再写入 'world!'。")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" file "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createWriteStream")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'例子.txt'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nfile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello, '")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nfile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'world!'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 后面不允许再写入数据！")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("writable.setDefaultEncoding(encoding)")]),t._v("为"),s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[t._v("可写流"),s("OutboundLink")],1),t._v("设置默认的 "),s("code",[t._v("encoding")]),t._v("。返回：this")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("writable.uncork()")]),t._v("调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/HbaGHW",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.cork()")]),s("OutboundLink")],1),t._v(" 后缓冲的所有数据输出到目标。")]),t._v(" "),s("p",[t._v("当使用 "),s("a",{attrs:{href:"http://nodejs.cn/s/HbaGHW",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("writable.cork()")]),s("OutboundLink")],1),t._v(" 和 "),s("code",[t._v("writable.uncork()")]),t._v(" 来管理流的写入缓冲时，建议使用 "),s("code",[t._v("process.nextTick()")]),t._v(" 来延迟调用 "),s("code",[t._v("writable.uncork()")]),t._v("。 通过这种方式，可以对单个 Node.js 事件循环中调用的所有 "),s("code",[t._v("writable.write()")]),t._v(" 进行批处理。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cork")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nstream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'一些 '")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nstream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'数据 '")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nprocess"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("uncork")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("如果一个流上多次调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/HbaGHW",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("writable.cork()")]),s("OutboundLink")],1),t._v("，则必须调用同样次数的 "),s("code",[t._v("writable.uncork()")]),t._v(" 才能输出缓冲的数据。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cork")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nstream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'一些 '")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nstream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cork")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nstream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'数据 '")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nprocess"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("uncork")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 数据不会被输出，直到第二次调用 uncork()。")]),t._v("\n  stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("uncork")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("writable.write(chunk[, encoding][, callback])")])]),t._v(" "),s("ul",[s("li",[s("code",[t._v("chunk")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/9Tw2bK",target:"_blank",rel:"noopener noreferrer"}},[t._v("string"),s("OutboundLink")],1),t._v(" | "),s("a",{attrs:{href:"http://nodejs.cn/s/6x1hD3",target:"_blank",rel:"noopener noreferrer"}},[t._v("Buffer"),s("OutboundLink")],1),t._v(" | "),s("a",{attrs:{href:"http://nodejs.cn/s/ZbDkpm",target:"_blank",rel:"noopener noreferrer"}},[t._v("Uint8Array"),s("OutboundLink")],1),t._v(" | [any](要写入的数据。  对于非对象模式的流， "),s("code",[t._v("chunk")]),t._v(" 必须是字符串、 "),s("code",[t._v("Buffer")]),t._v(" 或 "),s("code",[t._v("Uint8Array")]),t._v("。 对于对象模式的流， "),s("code",[t._v("chunk")]),t._v(" 可以是任何 JavaScript 值，除了 "),s("code",[t._v("null")]),t._v("。")]),t._v(" "),s("li",[s("code",[t._v("encoding")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/9Tw2bK",target:"_blank",rel:"noopener noreferrer"}},[t._v("string"),s("OutboundLink")],1),t._v(" 如果 "),s("code",[t._v("chunk")]),t._v(" 是字符串，则指定字符编码。")]),t._v(" "),s("li",[s("code",[t._v("callback")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/ceTQa6",target:"_blank",rel:"noopener noreferrer"}},[t._v("function"),s("OutboundLink")],1),t._v(" 当数据块被输出到目标后的回调函数。")]),t._v(" "),s("li",[t._v("返回: "),s("a",{attrs:{href:"http://nodejs.cn/s/jFbvuT",target:"_blank",rel:"noopener noreferrer"}},[t._v("boolean"),s("OutboundLink")],1),t._v(" 如果流需要等待 "),s("code",[t._v("'drain'")]),t._v(" 事件触发才能继续写入更多数据，则返回 "),s("code",[t._v("false")]),t._v("，否则返回 "),s("code",[t._v("true")]),t._v("。")])]),t._v(" "),s("p",[s("code",[t._v("writable.write()")]),t._v(" 写入数据到流，并在数据被完全处理之后调用 "),s("code",[t._v("callback")]),t._v("。 如果发生错误，则 "),s("code",[t._v("callback")]),t._v(" 可能被调用也可能不被调用。 为了可靠地检测错误，可以为 "),s("code",[t._v("'error'")]),t._v(" 事件添加监听器。 "),s("code",[t._v("callback")]),t._v(" 会在触发 "),s("code",[t._v("'error'")]),t._v(" 之前被异步地调用。")]),t._v(" "),s("p",[t._v("在接收了 "),s("code",[t._v("chunk")]),t._v(" 后，如果内部的缓冲小于创建流时配置的 "),s("code",[t._v("highWaterMark")]),t._v("，则返回 "),s("code",[t._v("true")]),t._v(" 。 如果返回 "),s("code",[t._v("false")]),t._v(" ，则应该停止向流写入数据，直到 "),s("a",{attrs:{href:"http://nodejs.cn/s/gFdjtJ",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("'drain'")]),s("OutboundLink")],1),t._v(" 事件被触发。")]),t._v(" "),s("p",[t._v("当流还未被排空时，调用 "),s("code",[t._v("write()")]),t._v(" 会缓冲 "),s("code",[t._v("chunk")]),t._v("，并返回 "),s("code",[t._v("false")]),t._v("。 一旦所有当前缓冲的数据块都被排空了（被操作系统接收并传输），则触发 "),s("code",[t._v("'drain'")]),t._v(" 事件。 建议一旦 "),s("code",[t._v("write()")]),t._v(" 返回 false，则不再写入任何数据块，直到 "),s("code",[t._v("'drain'")]),t._v(" 事件被触发。 当流还未被排空时，也是可以调用 "),s("code",[t._v("write()")]),t._v("，Node.js 会缓冲所有被写入的数据块，直到达到最大内存占用，这时它会无条件中止。 甚至在它中止之前， 高内存占用将会导致垃圾回收器的性能变差和 RSS 变高（即使内存不再需要，通常也不会被释放回系统）。 如果远程的另一端没有读取数据，TCP 的 socket 可能永远也不会排空，所以写入到一个不会排空的 socket 可能会导致远程可利用的漏洞。")]),t._v(" "),s("p",[t._v("对于 "),s("a",{attrs:{href:"http://nodejs.cn/s/fhVJQM",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Transform")]),s("OutboundLink")],1),t._v(", 写入数据到一个不会排空的流尤其成问题，因为 "),s("code",[t._v("Transform")]),t._v(" 流默认会被暂停，直到它们被 pipe 或者添加了 "),s("code",[t._v("'data'")]),t._v(" 或 "),s("code",[t._v("'readable'")]),t._v(" 事件句柄。")]),t._v(" "),s("p",[t._v("如果要被写入的数据可以根据需要生成或者取得，建议将逻辑封装为一个"),s("a",{attrs:{href:"http://nodejs.cn/s/YuDKX1",target:"_blank",rel:"noopener noreferrer"}},[t._v("可读流"),s("OutboundLink")],1),t._v("并且使用 "),s("a",{attrs:{href:"http://nodejs.cn/s/Ea2ZNW",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.pipe()")]),s("OutboundLink")],1),t._v("。 如果要优先调用 "),s("code",[t._v("write()")]),t._v("，则可以使用 "),s("a",{attrs:{href:"http://nodejs.cn/s/gFdjtJ",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("'drain'")]),s("OutboundLink")],1),t._v(" 事件来防止背压与避免内存问题:")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cb")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("once")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'drain'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextTick")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在回调函数被执行后再进行其他的写入。")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'完成写入，可以进行更多的写入'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br")])]),s("p",[t._v("对象模式下的可写流将会始终忽略 "),s("code",[t._v("encoding")]),t._v(" 参数。")])])]),t._v(" "),s("h2",{attrs:{id:"_4-可读流-stream-readable"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-可读流-stream-readable"}},[t._v("🌙")]),t._v(" 4.可读流 "),s("code",[t._v("stream.Readable")])]),t._v(" "),s("p",[t._v("可读流是对提供数据的来源的一种抽象。")]),t._v(" "),s("p",[t._v("可读流的例子包括：")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/2RqpEw",target:"_blank",rel:"noopener noreferrer"}},[t._v("客户端的 HTTP 响应"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/2RqpEw",target:"_blank",rel:"noopener noreferrer"}},[t._v("服务器的 HTTP 请求"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/C3Eioq",target:"_blank",rel:"noopener noreferrer"}},[t._v("fs 的读取流"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/duYbh2",target:"_blank",rel:"noopener noreferrer"}},[t._v("zlib 流"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/FuEfsg",target:"_blank",rel:"noopener noreferrer"}},[t._v("crypto 流"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/wsJ1o1",target:"_blank",rel:"noopener noreferrer"}},[t._v("TCP socket"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/F2vs59",target:"_blank",rel:"noopener noreferrer"}},[t._v("子进程 stdout 与 stderr"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/gagmJq",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("process.stdin")]),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("所有"),s("a",{attrs:{href:"http://nodejs.cn/s/YuDKX1",target:"_blank",rel:"noopener noreferrer"}},[t._v("可读流"),s("OutboundLink")],1),t._v("都实现了 "),s("code",[t._v("stream.Readable")]),t._v(" 类定义的接口。")]),t._v(" "),s("h3",{attrs:{id:"_4-1-两种读取模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-两种读取模式"}},[t._v("🌙")]),t._v(" 4.1 两种读取模式")]),t._v(" "),s("ul",[s("li",[t._v("流动模式（flowing）：数据自动从底层系统读取，并通过 "),s("a",{attrs:{href:"http://nodejs.cn/s/pGAddE",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("EventEmitter")]),s("OutboundLink")],1),t._v(" 接口的事件尽可能快地被提供给应用程序。")]),t._v(" "),s("li",[t._v("暂停模式（paused）：必须显式调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/SpgRaa",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.read()")]),s("OutboundLink")],1),t._v(" 读取数据块。")])]),t._v(" "),s("p",[t._v("所有"),s("a",{attrs:{href:"http://nodejs.cn/s/YuDKX1",target:"_blank",rel:"noopener noreferrer"}},[t._v("可读流"),s("OutboundLink")],1),t._v("都开始于暂停模式，可以通过以下方式切换到"),s("strong",[t._v("流动模式")]),t._v("：")]),t._v(" "),s("ul",[s("li",[t._v("添加 "),s("a",{attrs:{href:"http://nodejs.cn/s/8CCPjN",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("'data'")]),s("OutboundLink")],1),t._v(" 事件句柄。")]),t._v(" "),s("li",[t._v("调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/Zhf28N",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.resume()")]),s("OutboundLink")],1),t._v(" 方法。")]),t._v(" "),s("li",[t._v("调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/Ea2ZNW",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.pipe()")]),s("OutboundLink")],1),t._v(" 方法将数据发送到"),s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[t._v("可写流"),s("OutboundLink")],1),t._v("。")])]),t._v(" "),s("p",[t._v("可读流可以通过以下方式切换回"),s("strong",[t._v("暂停模式")]),t._v("：")]),t._v(" "),s("ul",[s("li",[t._v("如果没有管道目标，则调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/jqytVw",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.pause()")]),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("li",[t._v("如果有管道目标，则移除所有管道目标。调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/35GqHX",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.unpipe()")]),s("OutboundLink")],1),t._v(" 可以移除多个管道目标。")])]),t._v(" "),s("h3",{attrs:{id:"_4-2-三种状态"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-三种状态"}},[t._v("🌙")]),t._v(" 4.2 三种状态")]),t._v(" "),s("p",[t._v("在任意时刻，可读流会处于以下三种状态之一：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("readable.readableFlowing === null")])]),t._v(" "),s("li",[s("code",[t._v("readable.readableFlowing === false")])]),t._v(" "),s("li",[s("code",[t._v("readable.readableFlowing === true")])])]),t._v(" "),s("p",[t._v("当 "),s("code",[t._v("readable.readableFlowing")]),t._v(" 为 "),s("code",[t._v("null")]),t._v(" 时，没有提供消费流数据的机制，所以流不会产生数据。 在这个状态下，监听 "),s("code",[t._v("'data'")]),t._v(" 事件、调用 "),s("code",[t._v("readable.pipe()")]),t._v("、或调用 "),s("code",[t._v("readable.resume()")]),t._v(" 都会使 "),s("code",[t._v("readable.readableFlowing")]),t._v(" 切换到 "),s("code",[t._v("true")]),t._v("，可读流开始主动地产生数据并触发事件。")]),t._v(" "),s("p",[t._v("调用 "),s("code",[t._v("readable.pause()")]),t._v("、 "),s("code",[t._v("readable.unpipe()")]),t._v("、或接收到背压，则 "),s("code",[t._v("readable.readableFlowing")]),t._v(" 会被设为 "),s("code",[t._v("false")]),t._v("，暂时停止事件流动但不会停止数据的生成。 在这个状态下，为 "),s("code",[t._v("'data'")]),t._v(" 事件绑定监听器不会使 "),s("code",[t._v("readable.readableFlowing")]),t._v(" 切换到 "),s("code",[t._v("true")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" PassThrough"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Writable "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" pass "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PassThrough")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" writable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Writable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\npass"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pipe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("writable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\npass"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unpipe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("writable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// readableFlowing 现在为 false。")]),t._v("\n\npass"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'data'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("chunk")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toString")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\npass"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ok'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不会触发 'data' 事件。")]),t._v("\npass"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resume")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 必须调用它才会触发 'data' 事件。")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("p",[t._v("当 "),s("code",[t._v("readable.readableFlowing")]),t._v(" 为 "),s("code",[t._v("false")]),t._v(" 时，数据可能会堆积在流的内部缓冲中。")]),t._v(" "),s("h3",{attrs:{id:"_4-3-stream-readable事件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-stream-readable事件"}},[t._v("🌙")]),t._v(" 4.3 "),s("code",[t._v("stream.Readable")]),t._v("事件")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("事件名称")]),t._v(" "),s("th",[t._v("说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[s("code",[t._v("close")])]),t._v(" "),s("td",[t._v("流或其底层资源（比如文件描述符）被关闭时触发 "),s("code",[t._v("'close'")]),t._v(" 事件。 该事件表明不会再触发其他事件，也不会再发生操作。如果使用 "),s("code",[t._v("emitClose")]),t._v(" 选项创建"),s("a",{attrs:{href:"http://nodejs.cn/s/YuDKX1",target:"_blank",rel:"noopener noreferrer"}},[t._v("可读流"),s("OutboundLink")],1),t._v("，则它将会始终发出 "),s("code",[t._v("'close'")]),t._v(" 事件。")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("data")])]),t._v(" "),s("td",[t._v("当流将数据块传送给消费者后触发。 当调用 "),s("code",[t._v("readable.pipe()")]),t._v("， "),s("code",[t._v("readable.resume()")]),t._v(" 或绑定监听器到 "),s("code",[t._v("'data'")]),t._v(" 事件时，流会转换到流动模式。 当调用 "),s("code",[t._v("readable.read()")]),t._v(" 且有数据块返回时，也会触发 "),s("code",[t._v("'data'")]),t._v(" 事件。将 "),s("code",[t._v("'data'")]),t._v(" 事件监听器附加到尚未显式暂停的流将会使流切换为流动模式。 数据将会在可用时立即传递。")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("end")])]),t._v(" "),s("td",[t._v("当流中没有数据可供消费时触发。"),s("code",[t._v("'end'")]),t._v(" 事件只有在数据被完全消费掉后才会触发。 要想触发该事件，可以将流转换到流动模式，或反复调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/SpgRaa",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.read()")]),s("OutboundLink")],1),t._v(" 直到数据被消费完。")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("error")])]),t._v(" "),s("td",[s("code",[t._v("'error'")]),t._v(" 事件可能随时由 "),s("code",[t._v("Readable")]),t._v(" 实现触发。 通常，如果底层的流由于底层内部的故障而无法生成数据，或者流的实现尝试推送无效的数据块，则可能会发生这种情况。监听器回调将会传入一个 "),s("code",[t._v("Error")]),t._v(" 对象。")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("pause")])]),t._v(" "),s("td",[t._v("当调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/jqytVw",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.pause()")]),s("OutboundLink")],1),t._v(" 并且 "),s("code",[t._v("readsFlowing")]),t._v(" 不为 "),s("code",[t._v("false")]),t._v(" 时，就会触发 "),s("code",[t._v("'pause'")]),t._v(" 事件。")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("readable")])]),t._v(" "),s("td",[t._v("当有数据可从流中读取时，就会触发 "),s("code",[t._v("'readable'")]),t._v(" 事件。 在某些情况下，为 "),s("code",[t._v("'readable'")]),t._v(" 事件附加监听器将会导致将一些数据读入内部缓冲区。")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("resume")])]),t._v(" "),s("td",[t._v("当调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/Zhf28N",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.resume()")]),s("OutboundLink")],1),t._v(" 并且 "),s("code",[t._v("readsFlowing")]),t._v(" 不为 "),s("code",[t._v("true")]),t._v(" 时，将会触发 "),s("code",[t._v("'resume'")]),t._v(" 事件。")])])])]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" readable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getReadableStreamSomehow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'data'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("chunk")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("接收到 ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" 个字节的数据")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" readable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getReadableStreamSomehow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'data'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("chunk")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("接收到 ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" 个字节的数据")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'end'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'已没有数据'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("h3",{attrs:{id:"_4-4-stream-readable方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-stream-readable方法"}},[t._v("🌙")]),t._v(" 4.4 "),s("code",[t._v("stream.Readable")]),t._v("方法")]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("readable.destroy([error])")]),t._v("：销毁流。 可选地触发 "),s("code",[t._v("'error'")]),t._v(" 事件，并触发 "),s("code",[t._v("'close'")]),t._v(" 事件（除非将 "),s("code",[t._v("emitClose")]),t._v(" 设置为 "),s("code",[t._v("false")]),t._v("）。 在此调用之后，可读流将会释放所有内部的资源，并且将会忽略对 "),s("code",[t._v("push()")]),t._v(" 的后续调用。")]),t._v(" "),s("p",[t._v("一旦调用 "),s("code",[t._v("destroy()")]),t._v("，则不会再执行任何其他操作，并且除了 "),s("code",[t._v("_destroy")]),t._v(" 以外的其他错误都不会作为 "),s("code",[t._v("'error'")]),t._v(" 触发。返回: "),s("a",{attrs:{href:"http://nodejs.cn/s/v7Fsu2",target:"_blank",rel:"noopener noreferrer"}},[t._v("this"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.destroyed")]),t._v("：在调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/6VkV74",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("readable.destroy()")]),s("OutboundLink")],1),t._v(" 之后为 "),s("code",[t._v("true")]),t._v("。返回: boolean")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.isPaused()")]),t._v("："),s("code",[t._v("readable.isPaused()")]),t._v(" 方法返回可读流当前的操作状态。 主要用于 "),s("code",[t._v("readable.pipe()")]),t._v(" 底层的机制。返回: boolean")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" readable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Readable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isPaused")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// === false")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pause")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isPaused")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// === true")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resume")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isPaused")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// === false")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.pause()")]),t._v("："),s("code",[t._v("readable.pause()")]),t._v(" 方法使流动模式的流停止触发 "),s("a",{attrs:{href:"http://nodejs.cn/s/8CCPjN",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("'data'")]),s("OutboundLink")],1),t._v(" 事件，并切换出流动模式。 任何可用的数据都会保留在内部缓存中。返回: "),s("a",{attrs:{href:"http://nodejs.cn/s/v7Fsu2",target:"_blank",rel:"noopener noreferrer"}},[t._v("this"),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" readable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getReadableStreamSomehow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'data'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("chunk")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("接收到 ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" 字节的数据")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  readable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pause")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'暂停一秒'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'数据重新开始流动'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    readable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resume")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br")])]),s("p",[t._v("如果存在 "),s("code",[t._v("'readable'")]),t._v(" 事件监听器，则 "),s("code",[t._v("readable.pause()")]),t._v(" 方法不起作用。")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.pipe(destination[, options])")]),t._v(":")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("destination")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[t._v("stream.Writable"),s("OutboundLink")],1),t._v(" 数据写入的目标。")]),t._v(" "),s("li",[s("code",[t._v("options")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/jzn6Ao",target:"_blank",rel:"noopener noreferrer"}},[t._v("object"),s("OutboundLink")],1),t._v(" 管道选项。\n"),s("ul",[s("li",[s("code",[t._v("end")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/jFbvuT",target:"_blank",rel:"noopener noreferrer"}},[t._v("boolean"),s("OutboundLink")],1),t._v(" 当读取器结束时终止写入器。"),s("strong",[t._v("默认值:")]),t._v(" "),s("code",[t._v("true")]),t._v("。")])])]),t._v(" "),s("li",[t._v("返回: "),s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[t._v("stream.Writable"),s("OutboundLink")],1),t._v(" 目标可写流，如果是 "),s("a",{attrs:{href:"http://nodejs.cn/s/2iRabr",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Duplex")]),s("OutboundLink")],1),t._v(" 流或 "),s("a",{attrs:{href:"http://nodejs.cn/s/fhVJQM",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Transform")]),s("OutboundLink")],1),t._v(" 流则可以形成管道链。")])]),t._v(" "),s("p",[s("code",[t._v("readable.pipe()")]),t._v(" 方法绑定可写流到可读流，将可读流自动切换到流动模式，并将可读流的所有数据推送到绑定的可写流。 数据流会被自动管理，所以即使可读流更快，目标可写流也不会超负荷。")]),t._v(" "),s("p",[s("code",[t._v("readable.pipe()")]),t._v(" 会返回目标流的引用，这样就可以对流进行链式地管道操作：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" r "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createReadStream")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'file.txt'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" z "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" zlib"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createGzip")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" w "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createWriteStream")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'file.txt.gz'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pipe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("z"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pipe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("w"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("默认情况下，当来源可读流触发 "),s("a",{attrs:{href:"http://nodejs.cn/s/ZgviqU",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("'end'")]),s("OutboundLink")],1),t._v(" 事件时，目标可写流也会调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/nvArK4",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.end()")]),s("OutboundLink")],1),t._v(" 结束写入。 若要禁用这种默认行为， "),s("code",[t._v("end")]),t._v(" 选项应设为 "),s("code",[t._v("false")]),t._v("，这样目标流就会保持打开：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("reader"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pipe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("writer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("end")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nreader"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'end'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  writer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'结束'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.read([size])")]),t._v(":")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("size")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/SXbo1v",target:"_blank",rel:"noopener noreferrer"}},[t._v("number"),s("OutboundLink")],1),t._v(" 要读取的数据的字节数。")]),t._v(" "),s("li",[t._v("返回: "),s("a",{attrs:{href:"http://nodejs.cn/s/9Tw2bK",target:"_blank",rel:"noopener noreferrer"}},[t._v("string"),s("OutboundLink")],1),t._v(" | "),s("a",{attrs:{href:"http://nodejs.cn/s/6x1hD3",target:"_blank",rel:"noopener noreferrer"}},[t._v("Buffer"),s("OutboundLink")],1),t._v(" | "),s("a",{attrs:{href:"http://nodejs.cn/s/334hvC",target:"_blank",rel:"noopener noreferrer"}},[t._v("null"),s("OutboundLink")],1),t._v(" | "),s("a",{attrs:{href:"http://nodejs.cn/s/6sTGdS",target:"_blank",rel:"noopener noreferrer"}},[t._v("any"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("从内部缓冲拉取并返回数据。 如果没有可读的数据，则返回 "),s("code",[t._v("null")]),t._v("。 默认情况下， "),s("code",[t._v("readable.read()")]),t._v(" 返回的数据是 "),s("code",[t._v("Buffer")]),t._v(" 对象，除非使用 "),s("code",[t._v("readable.setEncoding()")]),t._v(" 指定字符编码或流处于对象模式。")]),t._v(" "),s("p",[t._v("可选的 "),s("code",[t._v("size")]),t._v(" 参数指定要读取的特定字节数。 如果无法读取 "),s("code",[t._v("size")]),t._v(" 个字节，则除非流已结束，否则将会返回 "),s("code",[t._v("null")]),t._v("，在这种情况下，将会返回内部 buffer 中剩余的所有数据。")]),t._v(" "),s("p",[t._v("如果没有指定 "),s("code",[t._v("size")]),t._v(" 参数，则返回内部缓冲中的所有数据。")]),t._v(" "),s("p",[s("code",[t._v("size")]),t._v(" 参数必须小于或等于 1 GB。")]),t._v(" "),s("p",[s("code",[t._v("readable.read()")]),t._v(" 应该只对处于暂停模式的可读流调用。 在流动模式中， "),s("code",[t._v("readable.read()")]),t._v(" 会自动调用直到内部缓冲的数据完全耗尽。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" readable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getReadableStreamSomehow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'readable'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chunk "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" readable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("接收到 ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" 字节的数据")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("使用 "),s("code",[t._v("readable.read()")]),t._v(" 处理数据时， "),s("code",[t._v("while")]),t._v(" 循环是必需的。 只有在 "),s("code",[t._v("readable.read()")]),t._v(" 返回 "),s("code",[t._v("null")]),t._v(" 之后，才会触发 "),s("a",{attrs:{href:"http://nodejs.cn/s/J6CZGb",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("'readable'")]),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v("对象模式下的可读流将会始终从调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/SpgRaa",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("readable.read(size)")]),s("OutboundLink")],1),t._v(" 返回单个子项，而不管 "),s("code",[t._v("size")]),t._v(" 参数的值如何。")]),t._v(" "),s("p",[t._v("如果 "),s("code",[t._v("readable.read()")]),t._v(" 返回一个数据块，则 "),s("code",[t._v("'data'")]),t._v(" 事件也会触发。")]),t._v(" "),s("p",[t._v("在 "),s("a",{attrs:{href:"http://nodejs.cn/s/ZgviqU",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("'end'")]),s("OutboundLink")],1),t._v(" 事件触发后再调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/SpgRaa",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.read([size\\])")]),s("OutboundLink")],1),t._v(" 会返回 "),s("code",[t._v("null")]),t._v("。 不会引发运行时错误。")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.readable")]),t._v(":如果可以安全地调用 "),s("a",{attrs:{href:"http://nodejs.cn/s/SpgRaa",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("readable.read()")]),s("OutboundLink")],1),t._v("（这意味着流没有被破坏或触发 "),s("code",[t._v("'error'")]),t._v(" 或 "),s("code",[t._v("'end'")]),t._v("），则为 "),s("code",[t._v("true")]),t._v("。")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.readableEncoding")]),t._v("：获取用于给定可读流的 "),s("code",[t._v("encoding")]),t._v(" 属性。 可以使用 "),s("a",{attrs:{href:"http://nodejs.cn/s/SjJGhm",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("readable.setEncoding()")]),s("OutboundLink")],1),t._v(" 方法设置 "),s("code",[t._v("encoding")]),t._v(" 属性。")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.readableEnded")]),t._v("： 当 "),s("a",{attrs:{href:"http://nodejs.cn/s/ZgviqU",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("'end'")]),s("OutboundLink")],1),t._v(" 事件被触发时变为 "),s("code",[t._v("true")]),t._v("。")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.resume()")]),t._v("：返回"),s("a",{attrs:{href:"http://nodejs.cn/s/v7Fsu2",target:"_blank",rel:"noopener noreferrer"}},[t._v("this"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("code",[t._v("readable.resume()")]),t._v(" 方法将被暂停的可读流恢复触发 "),s("a",{attrs:{href:"http://nodejs.cn/s/8CCPjN",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("'data'")]),s("OutboundLink")],1),t._v(" 事件，并将流切换到流动模式。")]),t._v(" "),s("p",[s("code",[t._v("readable.resume()")]),t._v(" 方法可以用来充分消耗流中的数据，但无需实际处理任何数据：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getReadableStreamSomehow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resume")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'end'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'到达流的尽头，但无需读取任何数据'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("当存在 "),s("code",[t._v("'readable'")]),t._v(" 事件监听器时， "),s("code",[t._v("readable.resume()")]),t._v(" 方法不起作用。")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.setEncoding(encoding)")]),t._v(":")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("encoding")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/9Tw2bK",target:"_blank",rel:"noopener noreferrer"}},[t._v("string"),s("OutboundLink")],1),t._v(" 字符编码。")]),t._v(" "),s("li",[t._v("返回: "),s("a",{attrs:{href:"http://nodejs.cn/s/v7Fsu2",target:"_blank",rel:"noopener noreferrer"}},[t._v("this"),s("OutboundLink")],1)])]),t._v(" "),s("p",[s("code",[t._v("readable.setEncoding()")]),t._v(" 方法为从可读流读取的数据设置字符编码。")]),t._v(" "),s("p",[t._v("默认情况下没有设置字符编码，流数据返回的是 "),s("code",[t._v("Buffer")]),t._v(" 对象。 如果设置了字符编码，则流数据返回指定编码的字符串。 例如，调用 "),s("code",[t._v("readable.setEncoding('utf-8')")]),t._v(" 会将数据解析为 UTF-8 数据，并返回字符串，调用 "),s("code",[t._v("readable.setEncoding('hex')")]),t._v(" 则会将数据编码成十六进制字符串。")]),t._v(" "),s("p",[t._v("可读流将会正确地处理通过流传递的多字节字符，否则如果简单地从流中作为 "),s("code",[t._v("Buffer")]),t._v(" 对象拉出，则会被不正确地解码。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" readable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getReadableStreamSomehow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setEncoding")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf8'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'data'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("chunk")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  assert"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("equal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'读取到 %d 个字符的字符串数据'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.unpipe([destination])")]),t._v(":")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("destination")]),t._v(" "),s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[t._v("stream.Writable"),s("OutboundLink")],1),t._v(" 要移除管道的可写流。")]),t._v(" "),s("li",[t._v("返回: "),s("a",{attrs:{href:"http://nodejs.cn/s/v7Fsu2",target:"_blank",rel:"noopener noreferrer"}},[t._v("this"),s("OutboundLink")],1)])]),t._v(" "),s("p",[s("code",[t._v("readable.unpipe()")]),t._v(" 方法解绑之前使用 "),s("a",{attrs:{href:"http://nodejs.cn/s/Ea2ZNW",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.pipe()")]),s("OutboundLink")],1),t._v(" 方法绑定的可写流。")]),t._v(" "),s("p",[t._v("如果没有指定 "),s("code",[t._v("destination")]),t._v(", 则解绑所有管道.")]),t._v(" "),s("p",[t._v("如果指定了 "),s("code",[t._v("destination")]),t._v(", 但它没有建立管道，则不起作用.")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" readable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getReadableStreamSomehow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" writable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createWriteStream")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'file.txt'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 可读流的所有数据开始传输到 'file.txt'，但一秒后停止。")]),t._v("\nreadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pipe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("writable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'停止写入 file.txt'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  readable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unpipe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("writable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'手动关闭文件流'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  writable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("readable.unshift(chunk[, encoding])")]),t._v(":"),s("code",[t._v("readable.unshift()")]),t._v(" 方法将数据块推回内部缓冲。")]),t._v(" "),s("p",[t._v("​\t可用于以下情景：正被消费中的流需要将一些已经被拉出的数据重置为未消费状态，以便这些数据可以传给其他方。")]),t._v(" "),s("p",[t._v("​\t触发 "),s("a",{attrs:{href:"http://nodejs.cn/s/ZgviqU",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("'end'")]),s("OutboundLink")],1),t._v(" 事件或抛出运行时错误之后，不能再调用 "),s("code",[t._v("stream.unshift()")]),t._v(" 方法。")]),t._v(" "),s("p",[t._v("使用 "),s("code",[t._v("stream.unshift()")]),t._v(" 的开发者可以考虑切换到 "),s("a",{attrs:{href:"http://nodejs.cn/s/fhVJQM",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Transform")]),s("OutboundLink")],1),t._v(" 流。 详见"),s("a",{attrs:{href:"http://nodejs.cn/s/d2EgSi",target:"_blank",rel:"noopener noreferrer"}},[t._v("用于实现流的API"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 拉出由 \\n\\n 分隔的标题。")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果获取太多，则使用 unshift()。")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用 (error, header, stream) 调用回调。")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" StringDecoder "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string_decoder'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parseHeader")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'readable'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" onReadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" decoder "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StringDecoder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf8'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" header "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onReadable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chunk "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" str "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" decoder"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("match")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token regex"}},[s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[t._v("\\n\\n")]),s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发现头部边界。")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" split "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" str"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("split")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token regex"}},[s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[t._v("\\n\\n")]),s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        header "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" split"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("shift")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" remaining "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" split"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\n\\n'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" buf "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Buffer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("remaining"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf8'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在调用 unshift() 前移除 'readable' 监听器。")]),t._v("\n        stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'readable'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" onReadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unshift")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("buf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 现在可以从流中读取消息的主体。")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" header"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stream"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 继续读取头部。")]),t._v("\n        header "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" str"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br")])]),s("p",[t._v("与 "),s("a",{attrs:{href:"http://nodejs.cn/s/8s3paZ",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.push(chunk)")]),s("OutboundLink")],1),t._v(" 不同， "),s("code",[t._v("stream.unshift(chunk)")]),t._v(" 不会通过重置流的内部读取状态来结束读取过程。 如果在读取期间调用 "),s("code",[t._v("readable.unshift()")]),t._v("（即从自定义的流上的 "),s("a",{attrs:{href:"http://nodejs.cn/s/5hv4Rd",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream._read()")]),s("OutboundLink")],1),t._v(" 实现中调用），则会导致意外结果。 在使用立即的 "),s("a",{attrs:{href:"http://nodejs.cn/s/8s3paZ",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("stream.push('')")]),s("OutboundLink")],1),t._v(" 调用 "),s("code",[t._v("readable.unshift()")]),t._v(" 之后，将适当地重置读取状态，但最好在执行读取的过程中避免调用 "),s("code",[t._v("readable.unshift()")]),t._v("。")])])]),t._v(" "),s("h2",{attrs:{id:"_5-双工流与转换流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-双工流与转换流"}},[t._v("🌙")]),t._v(" 5.双工流与转换流")]),t._v(" "),s("h3",{attrs:{id:"_5-1-stream-duplex-双工流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-stream-duplex-双工流"}},[t._v("🌙")]),t._v(" 5.1 "),s("code",[t._v("stream.Duplex")]),t._v(" 双工流")]),t._v(" "),s("p",[t._v("双工流（Duplex）是同时实现了 "),s("a",{attrs:{href:"http://nodejs.cn/s/YuDKX1",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Readable")]),s("OutboundLink")],1),t._v(" 和 "),s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Writable")]),s("OutboundLink")],1),t._v(" 接口的流。")]),t._v(" "),s("p",[s("code",[t._v("Duplex")]),t._v(" 流的例子包括：")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/wsJ1o1",target:"_blank",rel:"noopener noreferrer"}},[t._v("TCP socket"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/duYbh2",target:"_blank",rel:"noopener noreferrer"}},[t._v("zlib 流"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://nodejs.cn/s/FuEfsg",target:"_blank",rel:"noopener noreferrer"}},[t._v("crypto 流"),s("OutboundLink")],1)])]),t._v(" "),s("h3",{attrs:{id:"_5-2-stream-transform-转换流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-stream-transform-转换流"}},[t._v("🌙")]),t._v(" 5.2 "),s("code",[t._v("stream.Transform")]),t._v(" 转换流")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("transform.destroy([error])")]),t._v("：销毁流，并可选地触发 "),s("code",[t._v("'error'")]),t._v(" 事件。")])]),t._v(" "),s("p",[t._v("转换流（Transform）是一种 "),s("a",{attrs:{href:"http://nodejs.cn/s/2iRabr",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Duplex")]),s("OutboundLink")],1),t._v(" 流，但它的输出与输入是相关联的。 与 "),s("a",{attrs:{href:"http://nodejs.cn/s/2iRabr",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Duplex")]),s("OutboundLink")],1),t._v(" 流一样， "),s("code",[t._v("Transform")]),t._v(" 流也同时实现了 "),s("a",{attrs:{href:"http://nodejs.cn/s/YuDKX1",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Readable")]),s("OutboundLink")],1),t._v(" 和 "),s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Writable")]),s("OutboundLink")],1),t._v(" 接口。")]),t._v(" "),s("p",[s("code",[t._v("Transform")]),t._v(" 流的例子包括：")]),t._v(" "),s("ul",[s("li",[s("p",[s("a",{attrs:{href:"http://nodejs.cn/s/duYbh2",target:"_blank",rel:"noopener noreferrer"}},[t._v("zlib 流"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"http://nodejs.cn/s/FuEfsg",target:"_blank",rel:"noopener noreferrer"}},[t._v("crypto 流"),s("OutboundLink")],1)])])]),t._v(" "),s("h2",{attrs:{id:"_6-实现流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-实现流"}},[t._v("🌙")]),t._v(" 6. 实现流")]),t._v(" "),s("p",[s("code",[t._v("stream")]),t._v(" 模块 API 旨在为了更容易地使用 JavaScript 的原型继承模式来实现流。")]),t._v(" "),s("p",[t._v("首先，流的开发者声明一个新的 JavaScript 类，该类继承了四个基本流类之一（"),s("code",[t._v("stream.Writeable")]),t._v("、 "),s("code",[t._v("stream.Readable")]),t._v("、 "),s("code",[t._v("stream.Duplex")]),t._v(" 或 "),s("code",[t._v("stream.Transform")]),t._v("），并确保调用了相应的父类构造函数:")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Writable "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyWritable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Writable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" highWaterMark"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("options "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" highWaterMark "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])]),s("h3",{attrs:{id:"_6-1-实现可写流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-实现可写流"}},[t._v("🌙")]),t._v(" 6.1 实现可写流")]),t._v(" "),s("p",[s("code",[t._v("stream.Writable")]),t._v(" 类可用于实现 "),s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Writable")]),s("OutboundLink")],1),t._v(" 流。")]),t._v(" "),s("p",[t._v("自定义的 "),s("code",[t._v("Writable")]),t._v(" 流必须调用 "),s("code",[t._v("new stream.Writable([options])")]),t._v(" 构造函数并实现 "),s("code",[t._v("writable._write()")]),t._v(" 和/或 "),s("code",[t._v("writable._writev()")]),t._v(" 方法。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Writable "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyWritable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Writable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调用 stream.Writable() 构造函数。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ES6之前")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Writable "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" util "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'util'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("MyWritable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyWritable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyWritable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Writable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nutil"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("inherits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MyWritable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Writable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用简化的构造函数：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Writable "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" myWritable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Writable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" encoding"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("writev")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("chunks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br")])]),s("h3",{attrs:{id:"_6-2-实现可读流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-实现可读流"}},[t._v("🌙")]),t._v(" 6.2 实现可读流")]),t._v(" "),s("p",[s("code",[t._v("stream.Readable")]),t._v(" 类可用于实现可读流。")]),t._v(" "),s("p",[t._v("自定义的可读流必须调用 "),s("code",[t._v("new stream.Readable([options])")]),t._v(" 构造函数并实现 "),s("code",[t._v("readable._read()")]),t._v(" 方法。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Readable "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyReadable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Readable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调用 stream.Readable(options) 构造函数。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用 ES6 之前的语法：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Readable "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" util "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'util'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("MyReadable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyReadable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyReadable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Readable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nutil"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("inherits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MyReadable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Readable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用简化的构造函数：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Readable "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" myReadable "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Readable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("size")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br")])]),s("h3",{attrs:{id:"_6-3-实现双工流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-实现双工流"}},[t._v("🌙")]),t._v(" 6.3 实现双工流")]),t._v(" "),s("p",[s("a",{attrs:{href:"http://nodejs.cn/s/2iRabr",target:"_blank",rel:"noopener noreferrer"}},[t._v("双工流"),s("OutboundLink")],1),t._v("同时实现了"),s("a",{attrs:{href:"http://nodejs.cn/s/YuDKX1",target:"_blank",rel:"noopener noreferrer"}},[t._v("可读流"),s("OutboundLink")],1),t._v("和"),s("a",{attrs:{href:"http://nodejs.cn/s/9JUnJ8",target:"_blank",rel:"noopener noreferrer"}},[t._v("可写流"),s("OutboundLink")],1),t._v("，例如 TCP socket 连接。")]),t._v(" "),s("p",[t._v("因为 JavaScript 不支持多重继承，所以使用 "),s("code",[t._v("stream.Duplex")]),t._v(" 类实现"),s("a",{attrs:{href:"http://nodejs.cn/s/2iRabr",target:"_blank",rel:"noopener noreferrer"}},[t._v("双工流"),s("OutboundLink")],1),t._v("（而不是使用 "),s("code",[t._v("stream.Readable")]),t._v(" 类和 "),s("code",[t._v("stream.Writable")]),t._v(" 类）。")]),t._v(" "),s("p",[s("code",[t._v("stream.Duplex")]),t._v(" 类的原型继承自 "),s("code",[t._v("stream.Readable")]),t._v(" 和寄生自 "),s("code",[t._v("stream.Writable")]),t._v("，但是 "),s("code",[t._v("instanceof")]),t._v(" 对这两个基础类都可用，因为重写了 "),s("code",[t._v("stream.Writable")]),t._v(" 的 "),s("a",{attrs:{href:"http://nodejs.cn/s/D1EDvM",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Symbol.hasInstance")]),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v("自定义的双工流必须调用 "),s("code",[t._v("new stream.Duplex([options])")]),t._v(" 构造函数并实现 "),s("code",[t._v("readable._read()")]),t._v(" 和 "),s("code",[t._v("writable._write()")]),t._v(" 方法。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Duplex "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyDuplex")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Duplex")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用 ES6 之前的语法：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Duplex "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" util "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'util'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("MyDuplex")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyDuplex")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyDuplex")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Duplex")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nutil"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("inherits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MyDuplex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Duplex"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用简化的构造函数：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Duplex "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" myDuplex "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Duplex")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("size")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" encoding"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br")])]),s("h3",{attrs:{id:"_6-4-实现转换流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-实现转换流"}},[t._v("🌙")]),t._v(" 6.4 实现转换流")]),t._v(" "),s("p",[s("a",{attrs:{href:"http://nodejs.cn/s/fhVJQM",target:"_blank",rel:"noopener noreferrer"}},[t._v("转换流"),s("OutboundLink")],1),t._v("是一种"),s("a",{attrs:{href:"http://nodejs.cn/s/2iRabr",target:"_blank",rel:"noopener noreferrer"}},[t._v("双工流"),s("OutboundLink")],1),t._v("，它会对输入做些计算然后输出。 例如 "),s("a",{attrs:{href:"http://nodejs.cn/s/duYbh2",target:"_blank",rel:"noopener noreferrer"}},[t._v("zlib"),s("OutboundLink")],1),t._v(" 流和 "),s("a",{attrs:{href:"http://nodejs.cn/s/FuEfsg",target:"_blank",rel:"noopener noreferrer"}},[t._v("crypto"),s("OutboundLink")],1),t._v(" 流会压缩、加密或解密数据。")]),t._v(" "),s("p",[t._v("输出流的大小、数据块的数量都不一定会和输入流的一致。 例如， "),s("code",[t._v("Hash")]),t._v(" 流在输入结束时只会输出一个数据块，而 "),s("code",[t._v("zlib")]),t._v(" 流的输出可能比输入大很多或小很多。")]),t._v(" "),s("p",[s("code",[t._v("stream.Transform")]),t._v(" 类可用于实现了一个"),s("a",{attrs:{href:"http://nodejs.cn/s/fhVJQM",target:"_blank",rel:"noopener noreferrer"}},[t._v("转换流"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[s("code",[t._v("stream.Transform")]),t._v(" 类继承自 "),s("code",[t._v("stream.Duplex")]),t._v("，并且实现了自有的 "),s("code",[t._v("writable._write()")]),t._v(" 和 "),s("code",[t._v("readable._read()")]),t._v(" 方法。 自定义的转换流必须实现 "),s("a",{attrs:{href:"http://nodejs.cn/s/N8nFbP",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("transform._transform()")]),s("OutboundLink")],1),t._v(" 方法，"),s("a",{attrs:{href:"http://nodejs.cn/s/mErApk",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("transform._flush()")]),s("OutboundLink")],1),t._v(" 方法是可选的。")]),t._v(" "),s("p",[t._v("当使用转换流时，如果可读端的输出没有被消费，则写入流的数据可能会导致可写端被暂停。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Transform "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyTransform")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Transform")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用 ES6 之前的语法：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Transform "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" util "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'util'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("MyTransform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyTransform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyTransform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Transform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nutil"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("inherits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MyTransform"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Transform"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用简化的构造函数：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Transform "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stream'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" myTransform "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Transform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("transform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("chunk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" encoding"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br")])])])}),[],!1,null,null,null);s.default=e.exports}}]);